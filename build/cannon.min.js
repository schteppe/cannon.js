(function(){var CANNON=CANNON||{};if(!this.Int32Array){this.Int32Array=Array;this.Float32Array=Array}CANNON.Broadphase=function(){this.world=null};CANNON.Broadphase.prototype.constructor=CANNON.BroadPhase;CANNON.Broadphase.prototype.collisionPairs=function(world){throw"collisionPairs not implemented for this BroadPhase class!"};CANNON.NaiveBroadphase=function(){this.temp={r:new CANNON.Vec3,normal:new CANNON.Vec3,quat:new CANNON.Quaternion,relpos:new CANNON.Vec3}};CANNON.NaiveBroadphase.prototype=new CANNON.Broadphase;CANNON.NaiveBroadphase.prototype.constructor=CANNON.NaiveBroadphase;CANNON.NaiveBroadphase.prototype.collisionPairs=function(world){var pairs1=[],pairs2=[];var n=world.numObjects(),bodies=world.bodies;var types=CANNON.Shape.types;var BOX_SPHERE_COMPOUND_CONVEX=types.SPHERE|types.BOX|types.COMPOUND|types.CONVEXPOLYHEDRON,PLANE=types.PLANE,STATIC_OR_KINEMATIC=CANNON.Body.STATIC|CANNON.Body.KINEMATIC;var temp=this.temp;var r=temp.r,normal=temp.normal,quat=temp.quat,relpos=temp.relpos;for(var i=0;i<n;i++){for(var j=0;j<i;j++){var bi=bodies[i],bj=bodies[j];if(((bi.motionstate&STATIC_OR_KINEMATIC)!==0||bi.isSleeping())&&((bj.motionstate&STATIC_OR_KINEMATIC)!==0||bj.isSleeping())){continue}var bishape=bi.shape,bjshape=bj.shape;if(bishape&&bjshape){var ti=bishape.type,tj=bjshape.type;if(ti&BOX_SPHERE_COMPOUND_CONVEX&&tj&BOX_SPHERE_COMPOUND_CONVEX){bj.position.vsub(bi.position,r);if(bishape.boundingSphereRadiusNeedsUpdate)bishape.computeBoundingSphereRadius();if(bjshape.boundingSphereRadiusNeedsUpdate)bjshape.computeBoundingSphereRadius();var boundingRadiusSum=bishape.boundingSphereRadius+bjshape.boundingSphereRadius;if(r.norm2()<boundingRadiusSum*boundingRadiusSum){pairs1.push(bi);pairs2.push(bj)}}else if(ti&BOX_SPHERE_COMPOUND_CONVEX&&tj&types.PLANE||tj&BOX_SPHERE_COMPOUND_CONVEX&&ti&types.PLANE){var pi=ti===PLANE?i:j,oi=ti!==PLANE?i:j;bodies[oi].position.vsub(bodies[pi].position,r);normal.set(0,0,1);bodies[pi].quaternion.vmult(normal,normal);if(bodies[oi].shape.boundingSphereRadiusNeedsUpdate)bodies[oi].shape.computeBoundingSphereRadius();var q=r.dot(normal)-bodies[oi].shape.boundingSphereRadius;if(q<0){pairs1.push(bi);pairs2.push(bj)}}}else{if(!bishape&&!bjshape){}else{var particle=bishape?bj:bi;var other=bishape?bi:bj;var otherShape=other.shape;var type=otherShape.type;if(type&BOX_SPHERE_COMPOUND_CONVEX){if(type===types.SPHERE){particle.position.vsub(other.position,relpos);if(otherShape.radius*otherShape.radius>=relpos.norm2()){pairs1.push(particle);pairs2.push(other)}}else if(type===types.CONVEXPOLYHEDRON||type===types.BOX||type===types.COMPOUND){if(otherShape.boundingSphereRadiusNeedsUpdate)otherShape.computeBoundingSphereRadius();var R=otherShape.boundingSphereRadius;particle.position.vsub(other.position,relpos);if(R*R>=relpos.norm2()){pairs1.push(particle);pairs2.push(other)}}}else if(type===types.PLANE){var plane=other;normal.set(0,0,1);plane.quaternion.vmult(normal,normal);particle.position.vsub(plane.position,relpos);if(normal.dot(relpos)<=0){pairs1.push(particle);pairs2.push(other)}}}}}}return[pairs1,pairs2]};CANNON.Ray=function(origin,direction){this.origin=origin||new CANNON.Vec3;this.direction=direction||new CANNON.Vec3;var precision=1e-4;this.setPrecision=function(value){precision=value};var a=new CANNON.Vec3;var b=new CANNON.Vec3;var c=new CANNON.Vec3;var d=new CANNON.Vec3;var directionCopy=new CANNON.Vec3;var vector=new CANNON.Vec3;var normal=new CANNON.Vec3;var intersectPoint=new CANNON.Vec3;this.intersectBody=function(body){if(body.shape instanceof CANNON.ConvexPolyhedron){return this.intersectShape(body.shape,body.quaternion,body.position,body)}else if(body.shape instanceof CANNON.Box){return this.intersectShape(body.shape.convexPolyhedronRepresentation,body.quaternion,body.position,body)}else console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")};this.intersectShape=function(shape,quat,position,body){var intersect,intersects=[];if(shape instanceof CANNON.ConvexPolyhedron){var distance=distanceFromIntersection(this.origin,this.direction,position);if(distance>shape.getBoundingSphereRadius()){return intersects}var dot,scalar,faces=shape.faces,vertices=shape.vertices,normals=shape.faceNormals;for(var fi=0;fi<faces.length;fi++){var face=faces[fi];var faceNormal=normals[fi];var q=quat;var x=position;vertices[face[0]].copy(vector);q.vmult(vector,vector);vector.vadd(x,vector);vector.vsub(this.origin,vector);q.vmult(faceNormal,normal);dot=this.direction.dot(normal);if(Math.abs(dot)<precision)continue;scalar=normal.dot(vector)/dot;if(scalar<0)continue;if(dot<0){this.direction.mult(scalar,intersectPoint);intersectPoint.vadd(this.origin,intersectPoint);vertices[face[0]].copy(a);q.vmult(a,a);x.vadd(a,a);for(var i=1;i<face.length-1;i++){vertices[face[i]].copy(b);vertices[face[i+1]].copy(c);q.vmult(b,b);q.vmult(c,c);x.vadd(b,b);x.vadd(c,c);if(pointInTriangle(intersectPoint,a,b,c)){intersect={distance:this.origin.distanceTo(intersectPoint),point:intersectPoint.copy(),face:face,body:body};intersects.push(intersect);break}}}}}return intersects};this.intersectBodies=function(bodies){var intersects=[];for(var i=0,l=bodies.length;i<l;i++){var result=this.intersectBody(bodies[i]);Array.prototype.push.apply(intersects,result)}intersects.sort(function(a,b){return a.distance-b.distance});return intersects};var v0=new CANNON.Vec3,intersect=new CANNON.Vec3;var dot,distance;function distanceFromIntersection(origin,direction,position){position.vsub(origin,v0);dot=v0.dot(direction);direction.mult(dot,intersect);intersect.vadd(origin,intersect);distance=position.distanceTo(intersect);return distance}var dot00,dot01,dot02,dot11,dot12,invDenom,u,v;var v1=new CANNON.Vec3,v2=new CANNON.Vec3;function pointInTriangle(p,a,b,c){c.vsub(a,v0);b.vsub(a,v1);p.vsub(a,v2);dot00=v0.dot(v0);dot01=v0.dot(v1);dot02=v0.dot(v2);dot11=v1.dot(v1);dot12=v1.dot(v2);invDenom=1/(dot00*dot11-dot01*dot01);u=(dot11*dot02-dot01*dot12)*invDenom;v=(dot00*dot12-dot01*dot02)*invDenom;return u>=0&&v>=0&&u+v<1}};CANNON.Ray.prototype.constructor=CANNON.Ray;CANNON.Mat3=function(elements){if(elements){this.elements=elements}else{this.elements=[0,0,0,0,0,0,0,0,0]}};CANNON.Mat3.prototype.identity=function(){this.elements[0]=1;this.elements[1]=0;this.elements[2]=0;this.elements[3]=0;this.elements[4]=1;this.elements[5]=0;this.elements[6]=0;this.elements[7]=0;this.elements[8]=1};CANNON.Mat3.prototype.setZero=function(){var e=this.elements;e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=0;e[6]=0;e[7]=0;e[8]=0};CANNON.Mat3.prototype.setTrace=function(vec3){this.elements[0]=vec3.x;this.elements[4]=vec3.y;this.elements[8]=vec3.z};CANNON.Mat3.prototype.vmult=function(v,target){target=target||new CANNON.Vec3;var e=this.elements,x=v.x,y=v.y,z=v.z;target.x=e[0]*x+e[1]*y+e[2]*z;target.y=e[3]*x+e[4]*y+e[5]*z;target.z=e[6]*x+e[7]*y+e[8]*z;return target};CANNON.Mat3.prototype.smult=function(s){for(var i=0;i<this.elements.length;i++){this.elements[i]*=s}};CANNON.Mat3.prototype.mmult=function(m){var r=new CANNON.Mat3;for(var i=0;i<3;i++){for(var j=0;j<3;j++){var sum=0;for(var k=0;k<3;k++){sum+=m.elements[i+k*3]*this.elements[k+j*3]}r.elements[i+j*3]=sum}}return r};CANNON.Mat3.prototype.solve=function(b,target){target=target||new CANNON.Vec3;var nr=3;var nc=4;var eqns=[];for(var i=0;i<nr*nc;i++)eqns.push(0);var i,j;for(i=0;i<3;i++){for(j=0;j<3;j++){eqns[i+nc*j]=this.elements[i+3*j]}}eqns[3+4*0]=b.x;eqns[3+4*1]=b.y;eqns[3+4*2]=b.z;var n=3,k=n,np;var kp=4;var p,els;do{i=k-n;if(eqns[i+nc*i]===0){for(j=i+1;j<k;j++){if(eqns[i+nc*j]!==0){np=kp;do{p=kp-np;eqns[p+nc*i]+=eqns[p+nc*j]}while(--np);break}}}if(eqns[i+nc*i]!==0){for(j=i+1;j<k;j++){var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=kp;do{p=kp-np;eqns[p+nc*j]=p<=i?0:eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}}}while(--n);target.z=eqns[2*nc+3]/eqns[2*nc+2];target.y=(eqns[1*nc+3]-eqns[1*nc+2]*target.z)/eqns[1*nc+1];target.x=(eqns[0*nc+3]-eqns[0*nc+2]*target.z-eqns[0*nc+1]*target.y)/eqns[0*nc+0];if(isNaN(target.x)||isNaN(target.y)||isNaN(target.z)||target.x===Infinity||target.y===Infinity||target.z===Infinity){throw"Could not solve equation! Got x=["+target.toString()+"], b=["+b.toString()+"], A=["+this.toString()+"]"}return target};CANNON.Mat3.prototype.e=function(row,column,value){if(value===undefined){return this.elements[column+3*row]}else{this.elements[column+3*row]=value}};CANNON.Mat3.prototype.copy=function(target){target=target||new CANNON.Mat3;for(var i=0;i<this.elements.length;i++){target.elements[i]=this.elements[i]}return target};CANNON.Mat3.prototype.toString=function(){var r="";var sep=",";for(var i=0;i<9;i++){r+=this.elements[i]+sep}return r};CANNON.Mat3.prototype.reverse=function(target){target=target||new CANNON.Mat3;var nr=3;var nc=6;var eqns=[];for(var i=0;i<nr*nc;i++)eqns.push(0);var i,j;for(i=0;i<3;i++){for(j=0;j<3;j++){eqns[i+nc*j]=this.elements[i+3*j]}}eqns[3+6*0]=1;eqns[3+6*1]=0;eqns[3+6*2]=0;eqns[4+6*0]=0;eqns[4+6*1]=1;eqns[4+6*2]=0;eqns[5+6*0]=0;eqns[5+6*1]=0;eqns[5+6*2]=1;var n=3,k=n,np;var kp=nc;var p;do{i=k-n;if(eqns[i+nc*i]===0){for(j=i+1;j<k;j++){if(eqns[i+nc*j]!==0){np=kp;do{p=kp-np;eqns[p+nc*i]+=eqns[p+nc*j]}while(--np);break}}}if(eqns[i+nc*i]!==0){for(j=i+1;j<k;j++){var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=kp;do{p=kp-np;eqns[p+nc*j]=p<=i?0:eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}}}while(--n);i=2;do{j=i-1;do{var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=nc;do{p=nc-np;eqns[p+nc*j]=eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}while(j--)}while(--i);i=2;do{var multiplier=1/eqns[i+nc*i];np=nc;do{p=nc-np;eqns[p+nc*i]=eqns[p+nc*i]*multiplier}while(--np)}while(i--);i=2;do{j=2;do{p=eqns[nr+j+nc*i];if(isNaN(p)||p===Infinity)throw"Could not reverse! A=["+this.toString()+"]";target.e(i,j,p)}while(j--)}while(i--);return target};var numVecs=0;CANNON.Vec3=function(x,y,z){this.x=x||0;this.y=y||0;this.z=z||0;numVecs++};CANNON.Vec3.prototype.cross=function(v,target){var vx=v.x,vy=v.y,vz=v.z,x=this.x,y=this.y,z=this.z;target=target||new CANNON.Vec3;var A=[this.x,this.y,this.z];var B=[v.x,v.y,v.z];target.x=y*vz-z*vy;target.y=z*vx-x*vz;target.z=x*vy-y*vx;return target};CANNON.Vec3.prototype.set=function(x,y,z){this.x=x;this.y=y;this.z=z;return this};CANNON.Vec3.prototype.vadd=function(v,target){if(target){target.x=v.x+this.x;target.y=v.y+this.y;target.z=v.z+this.z}else{return new CANNON.Vec3(this.x+v.x,this.y+v.y,this.z+v.z)}};CANNON.Vec3.prototype.vsub=function(v,target){if(target){target.x=this.x-v.x;target.y=this.y-v.y;target.z=this.z-v.z}else{return new CANNON.Vec3(this.x-v.x,this.y-v.y,this.z-v.z)}};CANNON.Vec3.prototype.crossmat=function(){return new CANNON.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])};CANNON.Vec3.prototype.normalize=function(){var x=this.x,y=this.y,z=this.z;var n=Math.sqrt(x*x+y*y+z*z);if(n>0){var invN=1/n;this.x*=invN;this.y*=invN;this.z*=invN}else{this.x=0;this.y=0;this.z=0}return n};CANNON.Vec3.prototype.unit=function(target){target=target||new CANNON.Vec3;var x=this.x,y=this.y,z=this.z;var ninv=Math.sqrt(x*x+y*y+z*z);if(ninv>0){ninv=1/ninv;target.x=x*ninv;target.y=y*ninv;target.z=z*ninv}else{target.x=1;target.y=0;target.z=0}return target};CANNON.Vec3.prototype.norm=function(){var x=this.x,y=this.y,z=this.z;return Math.sqrt(x*x+y*y+z*z)};CANNON.Vec3.prototype.norm2=function(){return this.dot(this)};CANNON.Vec3.prototype.distanceTo=function(p){var x=this.x,y=this.y,z=this.z;var px=p.x,py=p.y,pz=p.z;return Math.sqrt((px-x)*(px-x)+(py-y)*(py-y)+(pz-z)*(pz-z))};CANNON.Vec3.prototype.mult=function(scalar,target){if(!target)target=new CANNON.Vec3;target.x=scalar*this.x;target.y=scalar*this.y;target.z=scalar*this.z;return target};CANNON.Vec3.prototype.dot=function(v){return this.x*v.x+this.y*v.y+this.z*v.z};CANNON.Vec3.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0};CANNON.Vec3.prototype.negate=function(target){target=target||new CANNON.Vec3;target.x=-this.x;target.y=-this.y;target.z=-this.z;return target};var Vec3_tangents_n=new CANNON.Vec3;var Vec3_tangents_randVec=new CANNON.Vec3;CANNON.Vec3.prototype.tangents=function(t1,t2){var norm=this.norm();if(norm>0){var n=Vec3_tangents_n;var inorm=1/norm;n.set(this.x*inorm,this.y*inorm,this.z*inorm);var randVec=Vec3_tangents_randVec;if(Math.abs(n.x)<.9){randVec.set(1,0,0);n.cross(randVec,t1)}else{randVec.set(0,1,0);n.cross(randVec,t1)}n.cross(t1,t2)}else{t1.set(1,0,0).normalize();t2.set(0,1,0).normalize()}};CANNON.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z};CANNON.Vec3.prototype.copy=function(target){target=target||new CANNON.Vec3;target.x=this.x;target.y=this.y;target.z=this.z;return target};CANNON.Vec3.prototype.lerp=function(v,t,target){var x=this.x,y=this.y,z=this.z;target.x=x+(v.x-x)*t;target.y=y+(v.y-y)*t;target.z=z+(v.z-z)*t};CANNON.Vec3.prototype.almostEquals=function(v,precision){if(precision===undefined)precision=1e-6;if(Math.abs(this.x-v.x)>precision||Math.abs(this.y-v.y)>precision||Math.abs(this.z-v.z)>precision)return false;return true};CANNON.Vec3.prototype.almostZero=function(precision){if(precision===undefined)precision=1e-6;if(Math.abs(this.x)>precision||Math.abs(this.y)>precision||Math.abs(this.z)>precision)return false;return true};CANNON.Quaternion=function(x,y,z,w){this.x=x!=undefined?x:0;this.y=y!=undefined?y:0;this.z=z!=undefined?z:0;this.w=w!=undefined?w:1};CANNON.Quaternion.prototype.set=function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w};CANNON.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w};CANNON.Quaternion.prototype.setFromAxisAngle=function(axis,angle){var s=Math.sin(angle*.5);this.x=axis.x*s;this.y=axis.y*s;this.z=axis.z*s;this.w=Math.cos(angle*.5)};CANNON.Quaternion.prototype.toAxisAngle=function(targetAxis){targetAxis=targetAxis||new CANNON.Vec3;this.normalize();var angle=2*Math.acos(this.w);var s=Math.sqrt(1-this.w*this.w);if(s<.001){targetAxis.x=this.x;targetAxis.y=this.y;targetAxis.z=this.z}else{targetAxis.x=this.x/s;targetAxis.y=this.y/s;targetAxis.z=this.z/s}return[targetAxis,angle]};CANNON.Quaternion.prototype.setFromVectors=function(u,v){var a=u.cross(v);this.x=a.x;this.y=a.y;this.z=a.z;this.w=Math.sqrt(Math.pow(u.norm(),2)*Math.pow(v.norm(),2))+u.dot(v);this.normalize()};var Quaternion_mult_va=new CANNON.Vec3;var Quaternion_mult_vb=new CANNON.Vec3;var Quaternion_mult_vaxvb=new CANNON.Vec3;CANNON.Quaternion.prototype.mult=function(q,target){target=target||new CANNON.Quaternion;var w=this.w,va=Quaternion_mult_va,vb=Quaternion_mult_vb,vaxvb=Quaternion_mult_vaxvb;va.set(this.x,this.y,this.z);vb.set(q.x,q.y,q.z);target.w=w*q.w-va.dot(vb);va.cross(vb,vaxvb);target.x=w*vb.x+q.w*va.x+vaxvb.x;target.y=w*vb.y+q.w*va.y+vaxvb.y;target.z=w*vb.z+q.w*va.z+vaxvb.z;return target};CANNON.Quaternion.prototype.inverse=function(target){var x=this.x,y=this.y,z=this.z,w=this.w;if(target==undefined)target=new CANNON.Quaternion;this.conjugate(target);var inorm2=1/(x*x+y*y+z*z+w*w);target.x*=inorm2;target.y*=inorm2;target.z*=inorm2;target.w*=inorm2;return target};CANNON.Quaternion.prototype.conjugate=function(target){if(target==undefined)target=new CANNON.Quaternion;target.x=-this.x;target.y=-this.y;target.z=-this.z;target.w=this.w;return target};CANNON.Quaternion.prototype.normalize=function(){var l=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);if(l===0){this.x=0;this.y=0;this.z=0;this.w=0}else{l=1/l;this.x*=l;this.y*=l;this.z*=l;this.w*=l}};CANNON.Quaternion.prototype.normalizeFast=function(){var f=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;if(f===0){this.x=0;this.y=0;this.z=0;this.w=0}else{this.x*=f;this.y*=f;this.z*=f;this.w*=f}};CANNON.Quaternion.prototype.vmult=function(v,target){target=target||new CANNON.Vec3;if(this.w==0){target.x=v.x;target.y=v.y;target.z=v.z}else{var x=v.x,y=v.y,z=v.z;var qx=this.x,qy=this.y,qz=this.z,qw=this.w;var ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;target.x=ix*qw+iw*-qx+iy*-qz-iz*-qy;target.y=iy*qw+iw*-qy+iz*-qx-ix*-qz;target.z=iz*qw+iw*-qz+ix*-qy-iy*-qx}return target};CANNON.Quaternion.prototype.copy=function(target){target.x=this.x;target.y=this.y;target.z=this.z;target.w=this.w};CANNON.Quaternion.prototype.toEuler=function(target,order){order=order||"YZX";var heading,attitude,bank;var x=this.x,y=this.y,z=this.z,w=this.w;switch(order){case"YZX":var test=x*y+z*w;if(test>.499){heading=2*Math.atan2(x,w);attitude=Math.PI/2;bank=0}if(test<-.499){heading=-2*Math.atan2(x,w);attitude=-Math.PI/2;bank=0}if(isNaN(heading)){var sqx=x*x;var sqy=y*y;var sqz=z*z;heading=Math.atan2(2*y*w-2*x*z,1-2*sqy-2*sqz);attitude=Math.asin(2*test);bank=Math.atan2(2*x*w-2*y*z,1-2*sqx-2*sqz)}break;default:throw new Error("Euler order "+order+" not supported yet.");break}target.y=heading;target.z=attitude;target.x=bank};CANNON.EventTarget=function(){var listeners={};this.addEventListener=function(type,listener){if(listeners[type]==undefined){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}};this.dispatchEvent=function(event){for(var listener in listeners[event.type]){listeners[event.type][listener](event)}};this.removeEventListener=function(type,listener){var index=listeners[type].indexOf(listener);if(index!==-1){listeners[type].splice(index,1)}}};CANNON.ObjectPool=function(){this.objects=[];this.type=Object};CANNON.ObjectPool.prototype.release=function(){for(var i in arguments)this.objects.push(arguments[i])};CANNON.ObjectPool.prototype.get=function(){if(this.objects.length===0)return this.constructObject();else return this.objects.pop()};CANNON.ObjectPool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this ObjectPool subclass yet!")};CANNON.Vec3Pool=function(){CANNON.ObjectPool.call(this);this.type=CANNON.Vec3};CANNON.Vec3Pool.prototype=new CANNON.ObjectPool;CANNON.Vec3Pool.prototype.constructObject=function(){return new CANNON.Vec3};CANNON.Shape=function(){this.type=0;this.aabbmin=new CANNON.Vec3;this.aabbmax=new CANNON.Vec3;this.boundingSphereRadius=0;this.boundingSphereRadiusNeedsUpdate=true};CANNON.Shape.prototype.constructor=CANNON.Shape;CANNON.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type};CANNON.Shape.prototype.getBoundingSphereRadius=function(){if(this.boundingSphereRadiusNeedsUpdate){this.computeBoundingSphereRadius()}return this.boundingSphereRadius};CANNON.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type};CANNON.Shape.prototype.calculateLocalInertia=function(mass,target){throw"calculateLocalInertia() not implemented for shape type "+this.type};var Shape_calculateTransformedInertia_localInertia=new CANNON.Vec3;var Shape_calculateTransformedInertia_worldInertia=new CANNON.Vec3;CANNON.Shape.prototype.calculateTransformedInertia=function(mass,quat,target){target=target||new CANNON.Vec3;var localInertia=Shape_calculateTransformedInertia_localInertia;var worldInertia=Shape_calculateTransformedInertia_worldInertia;this.calculateLocalInertia(mass,localInertia);quat.vmult(localInertia,worldInertia);target.x=Math.abs(worldInertia.x);target.y=Math.abs(worldInertia.y);target.z=Math.abs(worldInertia.z);return target};CANNON.Shape.calculateLocalAABB=function(){throw new Error(".calculateLocalAABB is not implemented for this Shape yet!")};CANNON.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16};CANNON.Body=function(type){CANNON.EventTarget.apply(this);this.type=type;this.world=null;this.preStep=null;this.postStep=null;this.vlambda=new CANNON.Vec3};CANNON.Body.DYNAMIC=1;CANNON.Body.STATIC=2;CANNON.Body.KINEMATIC=4;CANNON.Particle=function(mass,material){if(typeof mass!="number")throw new Error("Argument 1 (mass) must be a number.");if(typeof material!="undefined"&&!(material instanceof CANNON.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");CANNON.Body.call(this,"particle");this.position=new CANNON.Vec3;this.initPosition=new CANNON.Vec3;this.velocity=new CANNON.Vec3;this.initVelocity=new CANNON.Vec3;this.force=new CANNON.Vec3;this.mass=mass;this.invMass=mass>0?1/mass:0;this.material=material;this.linearDamping=.01;this.motionstate=mass<=0?CANNON.Body.STATIC:CANNON.Body.DYNAMIC;this.allowSleep=true;this.sleepState=0;this.sleepSpeedLimit=.1;this.sleepTimeLimit=1;this.timeLastSleepy=0};CANNON.Particle.prototype=new CANNON.Body;CANNON.Particle.prototype.constructor=CANNON.Particle;CANNON.Particle.prototype.isAwake=function(){return this.sleepState==0};CANNON.Particle.prototype.isSleepy=function(){return this.sleepState==1};CANNON.Particle.prototype.isSleeping=function(){return this.sleepState==2};CANNON.Particle.prototype.wakeUp=function(){this.sleepState=0;this.dispatchEvent({type:"wakeup"})};CANNON.Particle.prototype.sleep=function(){this.sleepState=2};CANNON.Particle.prototype.sleepTick=function(time){if(this.allowSleep){var sleepState=this.sleepState;var speedSquared=this.velocity.norm2();var speedLimitSquared=Math.pow(this.sleepSpeedLimit,2);if(sleepState==0&&speedSquared<speedLimitSquared){this.sleepState=1;this.timeLastSleepy=time;this.dispatchEvent({type:"sleepy"})}else if(sleepState>0&&speedSquared>speedLimitSquared){this.wakeUp()}else if(sleepState==1&&time-this.timeLastSleepy>this.sleepTimeLimit){this.sleepState=2;this.dispatchEvent({type:"sleep"})}}};CANNON.RigidBody=function(mass,shape,material){if(typeof mass!="number")throw new Error("Argument 1 (mass) must be a number.");if(typeof material!="undefined"&&!(material instanceof CANNON.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");CANNON.Particle.call(this,mass,material);var that=this;this.tau=new CANNON.Vec3;this.quaternion=new CANNON.Quaternion;this.initQuaternion=new CANNON.Quaternion;this.angularVelocity=new CANNON.Vec3;this.initAngularVelocity=new CANNON.Vec3;this.shape=shape;this.inertia=new CANNON.Vec3;shape.calculateLocalInertia(mass,this.inertia);this.inertiaWorld=new CANNON.Vec3;this.inertia.copy(this.inertiaWorld);this.inertiaWorldAutoUpdate=false;this.invInertia=new CANNON.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0);this.invInertiaWorld=new CANNON.Vec3;this.invInertia.copy(this.invInertiaWorld);this.invInertiaWorldAutoUpdate=false;this.angularDamping=.01;this.aabbmin=new CANNON.Vec3;this.aabbmax=new CANNON.Vec3;this.calculateAABB();this.wlambda=new CANNON.Vec3};CANNON.RigidBody.prototype=new CANNON.Particle(0);CANNON.RigidBody.prototype.constructor=CANNON.RigidBody;CANNON.RigidBody.prototype.calculateAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax)};CANNON.RigidBody.prototype.applyImpulse=function(worldPoint,force,dt){dt=dt||1/60;var r=new CANNON.Vec3,rotForce=new CANNON.Vec3;worldPoint.vsub(this.position,r);r.cross(force,rotForce);this.velocity.vadd(force.mult(dt),this.velocity);this.angularVelocity.vadd(rotForce.mult(dt),this.angularVelocity)};CANNON.Sphere=function(radius){CANNON.Shape.call(this);this.radius=radius!=undefined?Number(radius):1;this.type=CANNON.Shape.types.SPHERE};CANNON.Sphere.prototype=new CANNON.Shape;CANNON.Sphere.prototype.constructor=CANNON.Sphere;CANNON.Sphere.prototype.calculateLocalInertia=function(mass,target){target=target||new CANNON.Vec3;var I=2*mass*this.radius*this.radius/5;target.x=I;target.y=I;target.z=I;return target};CANNON.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3};CANNON.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=false;this.boundingSphereRadius=this.radius};CANNON.Sphere.prototype.calculateWorldAABB=function(pos,quat,min,max){var r=this.radius;var axes=["x","y","z"];for(var i=0;i<axes.length;i++){var ax=axes[i];min[ax]=pos[ax]-r;max[ax]=pos[ax]+r}};CANNON.Box=function(halfExtents){CANNON.Shape.call(this);this.halfExtents=halfExtents;this.type=CANNON.Shape.types.BOX;this.convexPolyhedronRepresentation=null;this.updateConvexPolyhedronRepresentation()};CANNON.Box.prototype=new CANNON.Shape;CANNON.Box.prototype.constructor=CANNON.Box;CANNON.Box.prototype.updateConvexPolyhedronRepresentation=function(){var sx=this.halfExtents.x;var sy=this.halfExtents.y;var sz=this.halfExtents.z;var v=CANNON.Vec3;var h=new CANNON.ConvexPolyhedron([new v(-sx,-sy,-sz),new v(sx,-sy,-sz),new v(sx,sy,-sz),new v(-sx,sy,-sz),new v(-sx,-sy,sz),new v(sx,-sy,sz),new v(sx,sy,sz),new v(-sx,sy,sz)],[[0,1,2,3],[4,5,6,7],[0,1,5,4],[2,3,7,6],[0,3,7,4],[1,2,6,5]],[new v(0,0,-1),new v(0,0,1),new v(0,-1,0),new v(0,1,0),new v(-1,0,0),new v(1,0,0)]);this.convexPolyhedronRepresentation=h};CANNON.Box.prototype.calculateLocalInertia=function(mass,target){target=target||new CANNON.Vec3;var e=this.halfExtents;target.x=1/12*mass*(2*e.y*2*e.y+2*e.z*2*e.z);target.y=1/12*mass*(2*e.x*2*e.x+2*e.z*2*e.z);target.z=1/12*mass*(2*e.y*2*e.y+2*e.x*2*e.x);return target};CANNON.Box.prototype.getSideNormals=function(sixTargetVectors,quat){var sides=sixTargetVectors;var ex=this.halfExtents;sides[0].set(ex.x,0,0);sides[1].set(0,ex.y,0);sides[2].set(0,0,ex.z);sides[3].set(-ex.x,0,0);sides[4].set(0,-ex.y,0);sides[5].set(0,0,-ex.z);if(quat!=undefined){for(var i=0;i<sides.length;i++)quat.vmult(sides[i],sides[i])}return sides};CANNON.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z};CANNON.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm();this.boundingSphereRadiusNeedsUpdate=false};var worldCornerTempPos=new CANNON.Vec3;var worldCornerTempNeg=new CANNON.Vec3;CANNON.Box.prototype.forEachWorldCorner=function(pos,quat,callback){var e=this.halfExtents;var corners=[[e.x,e.y,e.z],[-e.x,e.y,e.z],[-e.x,-e.y,e.z],[-e.x,-e.y,-e.z],[e.x,-e.y,-e.z],[e.x,e.y,-e.z],[-e.x,e.y,-e.z],[e.x,-e.y,e.z]];for(var i=0;i<corners.length;i++){worldCornerTempPos.set(corners[i][0],corners[i][1],corners[i][2]);quat.vmult(worldCornerTempPos,worldCornerTempPos);pos.vadd(worldCornerTempPos,worldCornerTempPos);callback(worldCornerTempPos.x,worldCornerTempPos.y,worldCornerTempPos.z)}};CANNON.Box.prototype.calculateWorldAABB=function(pos,quat,min,max){min.set(Infinity,Infinity,Infinity);max.set(-Infinity,-Infinity,-Infinity);this.forEachWorldCorner(pos,quat,function(x,y,z){if(x>max.x)max.x=x;if(y>max.y)max.y=y;if(z>max.z)max.z=z;if(x<min.x)min.x=x;if(y<min.y)min.y=y;if(z<min.z)min.z=z})};CANNON.Plane=function(){CANNON.Shape.call(this);this.type=CANNON.Shape.types.PLANE};CANNON.Plane.prototype=new CANNON.Shape;CANNON.Plane.prototype.constructor=CANNON.Plane;CANNON.Plane.prototype.calculateLocalInertia=function(mass,target){target=target||new CANNON.Vec3;return target};CANNON.Plane.prototype.volume=function(){return Infinity};var tempNormal=new CANNON.Vec3(0,0,1);CANNON.Plane.prototype.calculateWorldAABB=function(pos,quat,min,max){quat.vmult(tempNormal,tempNormal);min.set(Infinity,Infinity,Infinity);var axes=["x","y","z"];for(var i=0;i<axes.length;i++){var ax=axes[i];if(tempNormal[ax]==1)max[ax]=pos[ax];if(tempNormal[ax]==-1)min[ax]=pos[ax]}};CANNON.Compound=function(){CANNON.Shape.call(this);this.type=CANNON.Shape.types.COMPOUND;this.childShapes=[];this.childOffsets=[];this.childOrientations=[]};CANNON.Compound.prototype=new CANNON.Shape;CANNON.Compound.prototype.constructor=CANNON.Compound;CANNON.Compound.prototype.addChild=function(shape,offset,orientation){offset=offset||new CANNON.Vec3;orientation=orientation||new CANNON.Quaternion;this.childShapes.push(shape);this.childOffsets.push(offset);this.childOrientations.push(orientation)};CANNON.Compound.prototype.volume=function(){var r=0;for(var i=0;i<this.childShapes.length;i++)r+=this.childShapes[i].volume();return r};var Compound_calculateLocalInertia_mr2=new CANNON.Vec3;var Compound_calculateLocalInertia_childInertia=new CANNON.Vec3;CANNON.Compound.prototype.calculateLocalInertia=function(mass,target){target=target||new CANNON.Vec3;var V=this.volume();var childInertia=Compound_calculateLocalInertia_childInertia;for(var i=0,Nchildren=this.childShapes.length;i!==Nchildren;i++){var b=this.childShapes[i];var o=this.childOffsets[i];var q=this.childOrientations[i];var m=b.volume()/V*mass;b.calculateLocalInertia(m,childInertia);target.vadd(childInertia,target);var mr2=Compound_calculateLocalInertia_mr2;mr2.set(m*o.x*o.x,m*o.y*o.y,m*o.z*o.z);target.vadd(mr2,target)}return target};CANNON.Compound.prototype.computeBoundingSphereRadius=function(){var r=0;for(var i=0;i<this.childShapes.length;i++){var si=this.childShapes[i];if(si.boundingSphereRadiusNeedsUpdate)si.computeBoundingSphereRadius();var candidate=this.childOffsets[i].norm()+si.boundingSphereRadius;if(r<candidate)r=candidate}this.boundingSphereRadius=r;this.boundingSphereRadiusNeedsUpdate=false};var aabbmaxTemp=new CANNON.Vec3;var aabbminTemp=new CANNON.Vec3;var childPosTemp=new CANNON.Vec3;var childQuatTemp=new CANNON.Quaternion;CANNON.Compound.prototype.calculateWorldAABB=function(pos,quat,min,max){var N=this.childShapes.length;min.set(Infinity,Infinity,Infinity);max.set(-Infinity,-Infinity,-Infinity);for(var i=0;i<N;i++){this.childOffsets[i].copy(childPosTemp);quat.vmult(childPosTemp,childPosTemp);pos.vadd(childPosTemp,childPosTemp);quat.mult(this.childOrientations[i],childQuatTemp);this.childShapes[i].calculateWorldAABB(childPosTemp,childQuatTemp,aabbminTemp,aabbmaxTemp);if(aabbminTemp.x<min.x)min.x=aabbminTemp.x;if(aabbminTemp.y<min.y)min.y=aabbminTemp.y;if(aabbminTemp.z<min.z)min.z=aabbminTemp.z;if(aabbmaxTemp.x>max.x)max.x=aabbmaxTemp.x;if(aabbmaxTemp.y>max.y)max.y=aabbmaxTemp.y;if(aabbmaxTemp.z>max.z)max.z=aabbmaxTemp.z}};CANNON.ConvexPolyhedron=function(points,faces,normals){var that=this;CANNON.Shape.call(this);this.type=CANNON.Shape.types.CONVEXPOLYHEDRON;this.vertices=points||[];this.faces=faces||[];this.faceNormals=normals||[];for(var i=0;i<this.faceNormals.length;i++)this.faceNormals[i].normalize();this.uniqueEdges=[];var nv=this.vertices.length;for(var pi=0;pi<nv;pi++){var p=this.vertices[pi];if(!(p instanceof CANNON.Vec3)){throw"Argument 1 must be instance of CANNON.Vec3";return false}this.uniqueEdges.push(p)}for(var i=0;i<this.faces.length;i++){var numVertices=this.faces[i].length;var NbTris=numVertices;for(var j=0;j<NbTris;j++){var k=(j+1)%numVertices;var edge=new CANNON.Vec3;this.vertices[this.faces[i][j]].vsub(this.vertices[this.faces[i][k]],edge);edge.normalize();var found=false;for(var p=0;p<this.uniqueEdges.length;p++){if(this.uniqueEdges[p].almostEquals(edge)||this.uniqueEdges[p].almostEquals(edge)){found=true;break}}if(!found){this.uniqueEdges.push(edge)}if(edge){edge.face1=i}else{var ed;ed.m_face0=i;edges.insert(vp,ed)}}}var worldVertex=new CANNON.Vec3;function project(hull,axis,pos,quat,maxmin){var n=hull.vertices.length;var max=null;var min=null;var vs=hull.vertices;for(var i=0;i<n;i++){vs[i].copy(worldVertex);quat.vmult(worldVertex,worldVertex);worldVertex.vadd(pos,worldVertex);var val=worldVertex.dot(axis);if(max===null||val>max)max=val;if(min===null||val<min)min=val}if(min>max){var temp=min;min=max;max=temp}maxmin[0]=max;maxmin[1]=min}this.testSepAxis=function(axis,hullB,posA,quatA,posB,quatB){var maxminA=[],maxminB=[],hullA=this;project(hullA,axis,posA,quatA,maxminA);project(hullB,axis,posB,quatB,maxminB);var maxA=maxminA[0];var minA=maxminA[1];var maxB=maxminB[0];var minB=maxminB[1];if(maxA<minB||maxB<minA){return false}var d0=maxA-minB;var d1=maxB-minA;depth=d0<d1?d0:d1;return depth};var faceANormalWS3=new CANNON.Vec3;var Worldnormal1=new CANNON.Vec3;var deltaC=new CANNON.Vec3;var worldEdge0=new CANNON.Vec3;var worldEdge1=new CANNON.Vec3;var Cross=new CANNON.Vec3;this.findSeparatingAxis=function(hullB,posA,quatA,posB,quatB,target){var dmin=Infinity;var hullA=this;var curPlaneTests=0;var numFacesA=hullA.faces.length;for(var i=0;i<numFacesA;i++){hullA.faceNormals[i].copy(faceANormalWS3);quatA.vmult(faceANormalWS3,faceANormalWS3);var d=hullA.testSepAxis(faceANormalWS3,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;
faceANormalWS3.copy(target)}}var numFacesB=hullB.faces.length;for(var i=0;i<numFacesB;i++){hullB.faceNormals[i].copy(Worldnormal1);quatB.vmult(Worldnormal1,Worldnormal1);curPlaneTests++;var d=hullA.testSepAxis(Worldnormal1,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;Worldnormal1.copy(target)}}var edgeAstart,edgeAend,edgeBstart,edgeBend;var curEdgeEdge=0;for(var e0=0;e0<hullA.uniqueEdges.length;e0++){hullA.uniqueEdges[e0].copy(worldEdge0);quatA.vmult(worldEdge0,worldEdge0);for(var e1=0;e1<hullB.uniqueEdges.length;e1++){hullB.uniqueEdges[e1].copy(worldEdge1);quatB.vmult(worldEdge1,worldEdge1);worldEdge0.cross(worldEdge1,Cross);curEdgeEdge++;if(!Cross.almostZero()){Cross.normalize();var dist=hullA.testSepAxis(Cross,hullB,posA,quatA,posB,quatB);if(dist===false){return false}if(dist<dmin){dmin=dist;Cross.copy(target)}}}}posB.vsub(posA,deltaC);if(deltaC.dot(target)>0)target.negate(target);return true};var WorldNormal=new CANNON.Vec3;this.clipAgainstHull=function(posA,quatA,hullB,posB,quatB,separatingNormal,minDist,maxDist,result){if(!(posA instanceof CANNON.Vec3))throw new Error("posA must be Vec3");if(!(quatA instanceof CANNON.Quaternion))throw new Error("quatA must be Quaternion");var hullA=this;var curMaxDist=maxDist;var closestFaceB=-1;var dmax=-Infinity;for(var face=0;face<hullB.faces.length;face++){hullB.faceNormals[face].copy(WorldNormal);quatB.vmult(WorldNormal,WorldNormal);var d=WorldNormal.dot(separatingNormal);if(d>dmax){dmax=d;closestFaceB=face}}var worldVertsB1=[];polyB=hullB.faces[closestFaceB];var numVertices=polyB.length;for(var e0=0;e0<numVertices;e0++){var b=hullB.vertices[polyB[e0]];var worldb=new CANNON.Vec3;b.copy(worldb);quatB.vmult(worldb,worldb);posB.vadd(worldb,worldb);worldVertsB1.push(worldb)}if(closestFaceB>=0)this.clipFaceAgainstHull(separatingNormal,posA,quatA,worldVertsB1,minDist,maxDist,result)};var faceANormalWS=new CANNON.Vec3;var edge0=new CANNON.Vec3;var WorldEdge0=new CANNON.Vec3;var worldPlaneAnormal1=new CANNON.Vec3;var planeNormalWS1=new CANNON.Vec3;var worldA1=new CANNON.Vec3;var localPlaneNormal=new CANNON.Vec3;var planeNormalWS=new CANNON.Vec3;this.clipFaceAgainstHull=function(separatingNormal,posA,quatA,worldVertsB1,minDist,maxDist,result){if(!(separatingNormal instanceof CANNON.Vec3))throw new Error("sep normal must be vector");if(!(worldVertsB1 instanceof Array))throw new Error("world verts must be array");minDist=Number(minDist);maxDist=Number(maxDist);var hullA=this;var worldVertsB2=[];var pVtxIn=worldVertsB1;var pVtxOut=worldVertsB2;var closestFaceA=-1;var dmin=Infinity;for(var face=0;face<hullA.faces.length;face++){hullA.faceNormals[face].copy(faceANormalWS);quatA.vmult(faceANormalWS,faceANormalWS);var d=faceANormalWS.dot(separatingNormal);if(d<dmin){dmin=d;closestFaceA=face}}if(closestFaceA<0){console.log("--- did not find any closest face... ---");return}var polyA=hullA.faces[closestFaceA];polyA.connectedFaces=[];for(var i=0;i<hullA.faces.length;i++)for(var j=0;j<hullA.faces[i].length;j++)if(polyA.indexOf(hullA.faces[i][j])!==-1&&i!==closestFaceA&&polyA.connectedFaces.indexOf(i)===-1)polyA.connectedFaces.push(i);var numContacts=pVtxIn.length;var numVerticesA=polyA.length;var res=[];for(var e0=0;e0<numVerticesA;e0++){var a=hullA.vertices[polyA[e0]];var b=hullA.vertices[polyA[(e0+1)%numVerticesA]];a.vsub(b,edge0);edge0.copy(WorldEdge0);quatA.vmult(WorldEdge0,WorldEdge0);posA.vadd(WorldEdge0,WorldEdge0);this.faceNormals[closestFaceA].copy(worldPlaneAnormal1);quatA.vmult(worldPlaneAnormal1,worldPlaneAnormal1);posA.vadd(worldPlaneAnormal1,worldPlaneAnormal1);WorldEdge0.cross(worldPlaneAnormal1,planeNormalWS1);planeNormalWS1.negate(planeNormalWS1);a.copy(worldA1);quatA.vmult(worldA1,worldA1);posA.vadd(worldA1,worldA1);var planeEqWS1=-worldA1.dot(planeNormalWS1);var planeEqWS;if(true){var otherFace=polyA.connectedFaces[e0];this.faceNormals[otherFace].copy(localPlaneNormal);var localPlaneEq=planeConstant(otherFace);localPlaneNormal.copy(planeNormalWS);quatA.vmult(planeNormalWS,planeNormalWS);var planeEqWS=localPlaneEq-planeNormalWS.dot(posA)}else{planeNormalWS1.copy(planeNormalWS);planeEqWS=planeEqWS1}this.clipFaceAgainstPlane(pVtxIn,pVtxOut,planeNormalWS,planeEqWS);while(pVtxIn.length)pVtxIn.shift();while(pVtxOut.length)pVtxIn.push(pVtxOut.shift())}this.faceNormals[closestFaceA].copy(localPlaneNormal);var localPlaneEq=planeConstant(closestFaceA);localPlaneNormal.copy(planeNormalWS);quatA.vmult(planeNormalWS,planeNormalWS);var planeEqWS=localPlaneEq-planeNormalWS.dot(posA);for(var i=0;i<pVtxIn.length;i++){var depth=planeNormalWS.dot(pVtxIn[i])+planeEqWS;if(depth<=minDist){console.log("clamped: depth="+depth+" to minDist="+(minDist+""));depth=minDist}if(depth<=maxDist){var point=pVtxIn[i];if(depth<=0){var p={point:point,normal:planeNormalWS,depth:depth};result.push(p)}}}};this.clipFaceAgainstPlane=function(inVertices,outVertices,planeNormal,planeConstant){if(!(planeNormal instanceof CANNON.Vec3))throw new Error("planeNormal must be Vec3, "+planeNormal+" given");if(!(inVertices instanceof Array))throw new Error("invertices must be Array, "+inVertices+" given");if(!(outVertices instanceof Array))throw new Error("outvertices must be Array, "+outVertices+" given");var n_dot_first,n_dot_last;var numVerts=inVertices.length;if(numVerts<2)return outVertices;var firstVertex=inVertices[inVertices.length-1];var lastVertex=inVertices[0];n_dot_first=planeNormal.dot(firstVertex)+planeConstant;for(var vi=0;vi<numVerts;vi++){lastVertex=inVertices[vi];n_dot_last=planeNormal.dot(lastVertex)+planeConstant;if(n_dot_first<0){if(n_dot_last<0){var newv=new CANNON.Vec3;lastVertex.copy(newv);outVertices.push(newv)}else{var newv=new CANNON.Vec3;firstVertex.lerp(lastVertex,n_dot_first/(n_dot_first-n_dot_last),newv);outVertices.push(newv)}}else{if(n_dot_last<0){var newv=new CANNON.Vec3;firstVertex.lerp(lastVertex,n_dot_first/(n_dot_first-n_dot_last),newv);outVertices.push(newv);outVertices.push(lastVertex)}}firstVertex=lastVertex;n_dot_first=n_dot_last}return outVertices};var that=this;function normalOfFace(i,target){var f=that.faces[i];var va=that.vertices[f[0]];var vb=that.vertices[f[1]];var vc=that.vertices[f[2]];return normal(va,vb,vc,target)}function planeConstant(face_i,target){var f=that.faces[face_i];var n=that.faceNormals[face_i];var v=that.vertices[f[0]];var c=-n.dot(v);return c}var cb=new CANNON.Vec3;var ab=new CANNON.Vec3;function normal(va,vb,vc,target){vb.vsub(va,ab);vc.vsub(vb,cb);cb.cross(ab,target);if(!target.isZero()){target.normalize()}}function printFace(i){var f=that.faces[i],s="";for(var j=0;j<f.length;j++)s+=" ("+that.vertices[f[j]]+")";return s}function equalEdge(ea,eb){return ea[0]===eb[1]&&ea[1]===eb[0]}function randomOffset(){return(Math.random()-.5)*2*1e-6}this.calculateLocalInertia=function(mass,target){that.computeAABB();var x=this.aabbmax.x-this.aabbmin.x,y=this.aabbmax.y-this.aabbmin.y,z=this.aabbmax.z-this.aabbmin.z;target.x=1/12*mass*(2*y*2*y+2*z*2*z);target.y=1/12*mass*(2*x*2*x+2*z*2*z);target.z=1/12*mass*(2*y*2*y+2*x*2*x)};var worldVert=new CANNON.Vec3;this.computeAABB=function(){var n=this.vertices.length,aabbmin=this.aabbmin,aabbmax=this.aabbmax,vertices=this.vertices;aabbmin.set(Infinity,Infinity,Infinity);aabbmax.set(-Infinity,-Infinity,-Infinity);for(var i=0;i<n;i++){var v=vertices[i];if(v.x<aabbmin.x)aabbmin.x=v.x;else if(v.x>aabbmax.x)aabbmax.x=v.x;if(v.y<aabbmin.y)aabbmin.y=v.y;else if(v.y>aabbmax.y)aabbmax.y=v.y;if(v.z<aabbmin.z)aabbmin.z=v.z;else if(v.z>aabbmax.z)aabbmax.z=v.z}}};CANNON.ConvexPolyhedron.prototype=new CANNON.Shape;CANNON.ConvexPolyhedron.prototype.constructor=CANNON.ConvexPolyhedron;CANNON.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){var max2=0;var verts=this.vertices;for(var i=0,N=verts.length;i!==N;i++){var norm2=verts[i].norm2();if(norm2>max2)max2=norm2}this.boundingSphereRadius=Math.sqrt(max2);this.boundingSphereRadiusNeedsUpdate=false};var tempWorldVertex=new CANNON.Vec3;CANNON.ConvexPolyhedron.prototype.calculateWorldAABB=function(pos,quat,min,max){var n=this.vertices.length,verts=this.vertices;var minx,miny,minz,maxx,maxy,maxz;for(var i=0;i<n;i++){verts[i].copy(tempWorldVertex);quat.vmult(tempWorldVertex,tempWorldVertex);pos.vadd(tempWorldVertex,tempWorldVertex);var v=tempWorldVertex;if(v.x<minx||minx===undefined)minx=v.x;else if(v.x>maxx||maxx===undefined)maxx=v.x;if(v.y<miny||miny===undefined)miny=v.y;else if(v.y>maxy||maxy===undefined)maxy=v.y;if(v.z<minz||minz===undefined)minz=v.z;else if(v.z>maxz||maxz===undefined)maxz=v.z}min.set(minx,miny,minz);max.set(maxx,maxy,maxz)};CANNON.ConvexPolyhedron.prototype.volume=function(){if(this.boundingSphereRadiusNeedsUpdate)this.computeBoundingSphereRadius();return 4*Math.PI*this.boundingSphereRadius/3};CANNON.ConvexPolyhedron.prototype.getAveragePointLocal=function(target){target=target||new CANNON.Vec3;var n=this.vertices.length,verts=this.vertices;for(var i=0;i<n;i++){target.vadd(verts[i],target)}target.mult(1/n,target);return target};CANNON.ConvexPolyhedron.prototype.transformAllPoints=function(offset,quat){var n=this.vertices.length,verts=this.vertices;if(quat){for(var i=0;i<n;i++){var v=verts[i];quat.vmult(v,v)}}if(offset){for(var i=0;i<n;i++){var v=verts[i];v.vadd(offset,v)}}};var ConvexPolyhedron_pointIsInside=new CANNON.Vec3;var ConvexPolyhedron_vToP=new CANNON.Vec3;var ConvexPolyhedron_vToPointInside=new CANNON.Vec3;CANNON.ConvexPolyhedron.prototype.pointIsInside=function(p){var n=this.vertices.length,verts=this.vertices,faces=this.faces,normals=this.faceNormals;var positiveResult=null;var N=this.faces.length;var pointInside=ConvexPolyhedron_pointIsInside;this.getAveragePointLocal(pointInside);for(var i=0;i<N;i++){var numVertices=this.faces[i].length;var n=normals[i];var v=verts[faces[i][0]];var vToP=ConvexPolyhedron_vToP;p.vsub(v,vToP);var r1=n.dot(vToP);var vToPointInside=ConvexPolyhedron_vToPointInside;pointInside.vsub(v,vToPointInside);var r2=n.dot(vToPointInside);if(r1<0&&r2>0||r1>0&&r2<0){return false}else{}}return positiveResult?1:-1};function pointInConvex(p){}CANNON.Cylinder=function(radiusTop,radiusBottom,height,numSegments){var N=numSegments,verts=[],normals=[],faces=[],bottomface=[],topface=[],cos=Math.cos,sin=Math.sin;verts.push(new CANNON.Vec3(radiusBottom*cos(0),radiusBottom*sin(0),-height*.5));bottomface.push(0);verts.push(new CANNON.Vec3(radiusTop*cos(0),radiusTop*sin(0),height*.5));topface.push(1);for(var i=0;i<N;i++){var theta=2*Math.PI/N*(i+1);var thetaN=2*Math.PI/N*(i+.5);if(i<N-1){verts.push(new CANNON.Vec3(radiusBottom*cos(theta),radiusBottom*sin(theta),-height*.5));bottomface.push(2*(i+1));verts.push(new CANNON.Vec3(radiusTop*cos(theta),radiusTop*sin(theta),height*.5));topface.push(2*(i+1)+1);normals.push(new CANNON.Vec3(cos(thetaN),sin(thetaN),0));faces.push([2*i,2*i+1,2*(i+1),2*(i+1)+1])}else{faces.push([2*i,2*i+1,0,1]);normals.push(new CANNON.Vec3(cos(thetaN),sin(thetaN),0))}}faces.push(topface);normals.push(new CANNON.Vec3(0,0,1));faces.push(bottomface);normals.push(new CANNON.Vec3(0,0,-1));this.type=CANNON.Shape.types.CONVEXPOLYHEDRON;CANNON.ConvexPolyhedron.call(this,verts,faces,normals)};CANNON.Cylinder.prototype=new CANNON.ConvexPolyhedron;CANNON.Solver=function(){this.equations=[]};CANNON.Solver.prototype.solve=function(dt,world){return 0};CANNON.Solver.prototype.addEquation=function(eq){this.equations.push(eq)};CANNON.Solver.prototype.removeEquation=function(eq){var i=this.equations.indexOf(eq);if(i!=-1)this.equations.splice(i,1)};CANNON.Solver.prototype.removeAllEquations=function(){this.equations.length=0};CANNON.GSSolver=function(){CANNON.Solver.call(this);this.iterations=10;this.tolerance=0};CANNON.GSSolver.prototype=new CANNON.Solver;var GSSolver_solve_lambda=[];var GSSolver_solve_invCs=[];var GSSolver_solve_Bs=[];CANNON.GSSolver.prototype.solve=function(dt,world){var d=this.d,ks=this.k,iter=0,maxIter=this.iterations,tolSquared=this.tolerance*this.tolerance,a=this.a,b=this.b,equations=this.equations,Neq=equations.length,bodies=world.bodies,Nbodies=world.bodies.length,h=dt;var invCs=GSSolver_solve_invCs;var Bs=GSSolver_solve_Bs;var lambda=GSSolver_solve_lambda;for(var i=0;i!==Neq;i++){var c=equations[i];if(c.spookParamsNeedsUpdate){c.updateSpookParams(h);c.spookParamsNeedsUpdate=false}lambda[i]=0;Bs[i]=c.computeB(h);invCs[i]=1/c.computeC()}var q,B,c,invC,deltalambda,deltalambdaTot,GWlambda,lambdaj;if(Neq!==0){var i,j,abs=Math.abs;for(i=0;i!==Nbodies;i++){var b=bodies[i],vlambda=b.vlambda,wlambda=b.wlambda;vlambda.set(0,0,0);if(wlambda)wlambda.set(0,0,0)}for(iter=0;iter!==maxIter;iter++){deltalambdaTot=0;for(j=0;j!==Neq;j++){c=equations[j];B=Bs[j];invC=invCs[j];lambdaj=lambda[j];GWlambda=c.computeGWlambda(c.eps);deltalambda=invC*(B-GWlambda-c.eps*lambdaj);if(lambdaj+deltalambda<c.minForce){deltalambda=c.minForce-lambdaj}else if(lambdaj+deltalambda>c.maxForce){deltalambda=c.maxForce-lambdaj}lambda[j]+=deltalambda;deltalambdaTot+=abs(deltalambda);c.addToWlambda(deltalambda)}if(deltalambdaTot*deltalambdaTot<tolSquared)break}for(i=0;i!==Nbodies;i++){var b=bodies[i],v=b.velocity,w=b.angularVelocity;v.vadd(b.vlambda,v);if(w)w.vadd(b.wlambda,w)}}errorTot=deltalambdaTot;return iter};CANNON.SplitSolver=function(subsolver){CANNON.Solver.call(this);this.subsolver=subsolver};CANNON.SplitSolver.prototype=new CANNON.Solver;CANNON.SplitSolver.prototype.solve=function(dt,world){var nodes=[],bodies=world.bodies,equations=this.equations,Neq=equations.length,Nbodies=bodies.length,subsolver=this.subsolver;for(var i=0;i<Nbodies;i++)nodes.push({body:bodies[i],children:[],eqs:[],visited:false});for(var k=0;k<Neq;k++){var eq=equations[k],i=bodies.indexOf(eq.bi),j=bodies.indexOf(eq.bj),ni=nodes[i],nj=nodes[j];ni.children.push(nj);ni.eqs.push(eq);nj.children.push(ni);nj.eqs.push(eq)}var STATIC=CANNON.Body.STATIC;function getUnvisitedNode(nodes){var N=nodes.length;for(var i=0;i<N;i++){var node=nodes[i];if(!node.visited&&!(node.body.motionstate&STATIC))return node}return false}function bfs(root,visitFunc){var queue=[];queue.push(root);root.visited=true;visitFunc(root);while(queue.length){var node=queue.pop();var child;while(child=getUnvisitedNode(node.children)){child.visited=true;visitFunc(child);queue.push(child)}}}var child,n=0;while(child=getUnvisitedNode(nodes)){var eqs=[],bds=[];bfs(child,function(node){bds.push(node.body);for(var i=0;i<node.eqs.length;i++)if(eqs.indexOf(node.eqs[i])==-1)eqs.push(node.eqs[i])});for(var i=0;i<eqs.length;i++)subsolver.addEquation(eqs[i]);var iter=subsolver.solve(dt,{bodies:bds});subsolver.removeAllEquations();n++}return n};CANNON.Material=function(name){this.name=name;this.id=-1};CANNON.ContactMaterial=function(m1,m2,friction,restitution){this.id=-1;this.materials=[m1,m2];this.friction=friction!=undefined?Number(friction):.3;this.restitution=restitution!=undefined?Number(restitution):.3;this.contactEquationStiffness=1e7;this.contactEquationRegularizationTime=3;this.frictionEquationStiffness=1e7;this.frictionEquationRegularizationTime=3};CANNON.World=function(){CANNON.EventTarget.apply(this);this.allowSleep=false;this.contacts=[];this.frictionEquations=[];this.frictionEquationPool=[];this.quatNormalizeSkip=0;this.quatNormalizeFast=false;this.time=0;this.stepnumber=0;this.default_dt=1/60;this.last_dt=this.default_dt;this.nextId=0;this.gravity=new CANNON.Vec3;this.broadphase=null;this.bodies=[];var th=this;this.solver=new CANNON.GSSolver;this.constraints=[];this.contactgen=new CANNON.ContactGenerator;this.collision_matrix=[];this.materials=[];this.contactmaterials=[];this.mats2cmat=[];this.defaultMaterial=new CANNON.Material("default");this.defaultContactMaterial=new CANNON.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0);this.temp={gvec:new CANNON.Vec3,vi:new CANNON.Vec3,vj:new CANNON.Vec3,wi:new CANNON.Vec3,wj:new CANNON.Vec3,t1:new CANNON.Vec3,t2:new CANNON.Vec3,rixn:new CANNON.Vec3,rjxn:new CANNON.Vec3,step_q:new CANNON.Quaternion,step_w:new CANNON.Quaternion,step_wq:new CANNON.Quaternion};this.doProfiling=false;this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0}};CANNON.World.prototype.getContactMaterial=function(m1,m2){if(m1 instanceof CANNON.Material&&m2 instanceof CANNON.Material){var i=m1.id;var j=m2.id;if(i<j){var temp=i;i=j;j=temp}return this.contactmaterials[this.mats2cmat[i+j*this.materials.length]]}};CANNON.World.prototype.numObjects=function(){return this.bodies.length};CANNON.World.prototype.clearCollisionState=function(body){var n=this.numObjects();var i=body.id;for(var idx=0;idx<n;idx++){var j=idx;if(i>j)cm[j+i*n]=0;else cm[i+j*n]=0}};CANNON.World.prototype.collisionMatrixGet=function(i,j,current){var N=this.bodies.length;if(typeof current=="undefined")current=true;if(current&&i<j||!current&&i>j){var temp=j;j=i;i=temp}return this.collision_matrix[i+j*N]};CANNON.World.prototype.collisionMatrixSet=function(i,j,value,current){var N=this.bodies.length;if(typeof current==="undefined")current=true;if(current&&i<j||!current&&i>j){var temp=j;j=i;i=temp}this.collision_matrix[i+j*N]=value};CANNON.World.prototype.collisionMatrixTick=function(){var N=this.bodies.length;for(var i=0;i<N;i++){for(var j=0;j<i;j++){var currentState=this.collisionMatrixGet(i,j,true);this.collisionMatrixSet(i,j,currentState,false);this.collisionMatrixSet(i,j,0,true)}}};CANNON.World.prototype.add=function(body){var n=this.numObjects();this.bodies.push(body);body.id=this.id();body.world=this;body.position.copy(body.initPosition);body.velocity.copy(body.initVelocity);body.timeLastSleepy=this.time;if(body instanceof CANNON.RigidBody){body.angularVelocity.copy(body.initAngularVelocity);body.quaternion.copy(body.initQuaternion)}for(var i=0;i<2*n+1;i++)this.collision_matrix.push(0)};CANNON.World.prototype.addConstraint=function(c){this.constraints.push(c);c.id=this.id()};CANNON.World.prototype.removeConstraint=function(c){var idx=this.constraints.indexOf(c);if(idx!=-1)this.constraints.splice(idx,1)};CANNON.World.prototype.id=function(){return this.nextId++};CANNON.World.prototype.remove=function(body){body.world=null;var n=this.numObjects();var bodies=this.bodies;for(var i in bodies)if(bodies[i].id==body.id)bodies.splice(i,1);for(var i=0;i<2*n-1;i++)this.collision_matrix.pop()};CANNON.World.prototype.addMaterial=function(m){if(m.id==-1){var n=this.materials.length;this.materials.push(m);m.id=this.materials.length-1;if(true){for(var i=0;i<2*n+1;i++)this.mats2cmat.push(-1)}else{var newcm=new Int16Array(this.materials.length*this.materials.length);for(var i=0;i<newcm.length;i++)newcm[i]=-1;for(var i=0;i<this.materials.length-1;i++)for(var j=0;j<this.materials.length-1;j++)newcm[i+this.materials.length*j]=this.mats2cmat[i+(this.materials.length-1)*j];this.mats2cmat=newcm}}};CANNON.World.prototype.addContactMaterial=function(cmat){this.addMaterial(cmat.materials[0]);this.addMaterial(cmat.materials[1]);if(cmat.materials[0].id>cmat.materials[1].id){i=cmat.materials[0].id;j=cmat.materials[1].id}else{j=cmat.materials[0].id;i=cmat.materials[1].id}this.contactmaterials.push(cmat);cmat.id=this.contactmaterials.length-1;this.mats2cmat[i+this.materials.length*j]=cmat.id};CANNON.World.prototype._now=function(){if(window.performance.webkitNow)return window.performance.webkitNow();else return Date.now()};var World_step_postStepEvent={type:"postStep"},World_step_preStepEvent={type:"preStep"};CANNON.World.prototype.step=function(dt){var world=this,that=this,N=this.numObjects(),bodies=this.bodies,solver=this.solver,gravity=this.gravity,doProfiling=this.doProfiling,profile=this.profile,DYNAMIC=CANNON.Body.DYNAMIC,now=this._now,profilingStart,cm=this.collision_matrix,constraints=this.constraints,FrictionEquation=CANNON.FrictionEquation,gnorm=gravity.norm(),gx=gravity.x,gy=gravity.y,gz=gravity.z;if(doProfiling)profilingStart=now();if(dt===undefined){if(this.last_dt)dt=this.last_dt;else dt=this.default_dt}for(var i=0;i!==N;i++){var bi=bodies[i];if(bi.motionstate&DYNAMIC){var f=bi.force,m=bi.mass;f.x+=m*gx;f.y+=m*gy;f.z+=m*gz}}if(doProfiling)profilingStart=now();var pairs=this.broadphase.collisionPairs(this);var p1=pairs[0];var p2=pairs[1];if(doProfiling)profile.broadphase=now()-profilingStart;this.collisionMatrixTick();if(doProfiling)profilingStart=now();var oldcontacts=this.contacts;this.contacts=[];this.contactgen.getContacts(p1,p2,this,this.contacts,oldcontacts);if(doProfiling)profile.nearphase=now()-profilingStart;if(doProfiling)profilingStart=now();var temp=this.temp;var contacts=this.contacts;var ncontacts=contacts.length;this.frictionEquationPool=this.frictionEquationPool.concat(this.frictionEquations);this.frictionEquations=[];for(var k=0;k!==ncontacts;k++){var c=contacts[k];var bi=c.bi,bj=c.bj;var i=bodies.indexOf(bi),j=bodies.indexOf(bj);var cm=this.getContactMaterial(bi.material,bj.material)||this.defaultContactMaterial;var mu=cm.friction;var e=cm.restitution;var gvec=temp.gvec;gvec.set(bj.position.x+c.rj.x-bi.position.x-c.ri.x,bj.position.y+c.rj.y-bi.position.y-c.ri.y,bj.position.z+c.rj.z-bi.position.z-c.ri.z);var g=gvec.dot(c.ni);if(g<0){c.restitution=cm.restitution;c.penetration=g;c.stiffness=cm.contactEquationStiffness;c.regularizationTime=cm.contactEquationRegularizationTime;solver.addEquation(c);if(mu>0){var mug=mu*gnorm;var reducedMass=bi.invMass+bj.invMass;if(reducedMass!=0)reducedMass=1/reducedMass;var pool=this.frictionEquationPool;var c1=pool.length?pool.pop():new FrictionEquation(bi,bj,mug*reducedMass);var c2=pool.length?pool.pop():new FrictionEquation(bi,bj,mug*reducedMass);this.frictionEquations.push(c1);this.frictionEquations.push(c2);c1.bi=c2.bi=bi;c1.bj=c2.bj=bj;c1.minForce=c2.minForce=-mug*reducedMass;c1.maxForce=c2.maxForce=mug*reducedMass;c.ri.copy(c1.ri);c.rj.copy(c1.rj);c.ri.copy(c2.ri);c.rj.copy(c2.rj);c.ni.tangents(c1.t,c2.t);solver.addEquation(c1);solver.addEquation(c2)}this.collisionMatrixSet(i,j,1,true);if(this.collisionMatrixGet(i,j,true)!=this.collisionMatrixGet(i,j,false)){bi.dispatchEvent({type:"collide","with":bj,contact:c});bj.dispatchEvent({type:"collide","with":bi,contact:c});bi.wakeUp();bj.wakeUp()}}}if(doProfiling)profile.makeContactConstraints=now()-profilingStart;var bi;if(doProfiling)profilingStart=now();for(var i=0,Nconstraints=constraints.length;i!==Nconstraints;i++){var c=constraints[i];c.update();for(var j=0,Neq=c.equations.length;j!==Neq;j++){var eq=c.equations[j];solver.addEquation(eq)}}solver.solve(dt,this);if(doProfiling)profile.solve=now()-profilingStart;solver.removeAllEquations();var pow=Math.pow;for(var i=0;i!==N;i++){bi=bodies[i];if(bi.motionstate&DYNAMIC){var ld=pow(1-bi.linearDamping,dt);var v=bi.velocity;v.mult(ld,v);var av=bi.angularVelocity;if(av){var ad=pow(1-bi.angularDamping,dt);av.mult(ad,av)}}}this.dispatchEvent(World_step_postStepEvent);for(var i=0;i!==N;i++){var bi=bodies[i];bi.preStep&&bi.preStep.call(bi)}if(doProfiling)profilingStart=now();var q=temp.step_q;var w=temp.step_w;var wq=temp.step_wq;var stepnumber=this.stepnumber;var DYNAMIC_OR_KINEMATIC=CANNON.Body.DYNAMIC|CANNON.Body.KINEMATIC;var quatNormalize=stepnumber%(this.quatNormalizeSkip+1)===0;var quatNormalizeFast=this.quatNormalizeFast;var half_dt=dt*.5;for(var i=0;i!==N;i++){var b=bodies[i],force=b.force,tau=b.tau;if(b.motionstate&DYNAMIC_OR_KINEMATIC){var velo=b.velocity,angularVelo=b.angularVelocity,pos=b.position,quat=b.quaternion,invMass=b.invMass,invInertia=b.invInertia;velo.x+=force.x*invMass*dt;velo.y+=force.y*invMass*dt;velo.z+=force.z*invMass*dt;if(b.angularVelocity){angularVelo.x+=tau.x*invInertia.x*dt;angularVelo.y+=tau.y*invInertia.y*dt;angularVelo.z+=tau.z*invInertia.z*dt}if(!b.isSleeping()){pos.x+=velo.x*dt;pos.y+=velo.y*dt;pos.z+=velo.z*dt;if(b.angularVelocity){w.set(angularVelo.x,angularVelo.y,angularVelo.z,0);w.mult(quat,wq);quat.x+=half_dt*wq.x;quat.y+=half_dt*wq.y;quat.z+=half_dt*wq.z;quat.w+=half_dt*wq.w;if(quatNormalize){if(quatNormalizeFast)quat.normalizeFast();else quat.normalize()}}}}b.force.set(0,0,0);if(b.tau)b.tau.set(0,0,0)}if(doProfiling)profile.integrate=now()-profilingStart;this.time+=dt;this.stepnumber+=1;this.dispatchEvent(World_step_postStepEvent);for(var i=0;i!==N;i++){var bi=bodies[i];var postStep=bi.postStep;postStep&&postStep.call(bi)}for(var i=0;i!==N;i++){var b=bodies[i];if(b.inertiaWorldAutoUpdate)b.quaternion.vmult(b.inertia,b.inertiaWorld);if(b.invInertiaWorldAutoUpdate)b.quaternion.vmult(b.invInertia,b.invInertiaWorld)}if(this.allowSleep){for(var i=0;i!==N;i++){bodies[i].sleepTick(this.time)}}};CANNON.ContactPoint=function(bi,bj,normalConstraint,contactMaterial,tangentConstraint1,tangentConstraint2){this.bi=bi;this.bj=bj;this.n=normalConstraint;this.t1=tangentConstraint1;this.t2=tangentConstraint2;this.contactMaterial=contactMaterial};CANNON.ContactGenerator=function(){this.contactReduction=false;var contactPointPool=[];var v3pool=new CANNON.Vec3Pool;function makeResult(bi,bj){if(contactPointPool.length){var c=contactPointPool.pop();c.bi=bi;c.bj=bj;return c}else return new CANNON.ContactEquation(bi,bj)}function swapResult(r){var temp;temp=r.ri;r.ri=r.rj;r.rj=temp;r.ni.negate(r.ni);temp=r.bi;r.bi=r.bj;r.bj=temp}function sphereSphere(result,si,sj,xi,xj,qi,qj,bi,bj){var r=makeResult(bi,bj);bj.position.vsub(xi,r.ni);r.ni.normalize();r.ni.copy(r.ri);r.ni.copy(r.rj);r.ri.mult(si.radius,r.ri);r.rj.mult(-sj.radius,r.rj);result.push(r)}var point_on_plane_to_sphere=new CANNON.Vec3;var plane_to_sphere_ortho=new CANNON.Vec3;function spherePlane(result,si,sj,xi,xj,qi,qj,bi,bj){var r=makeResult(bi,bj);r.ni.set(0,0,1);qj.vmult(r.ni,r.ni);r.ni.negate(r.ni);r.ni.normalize();r.ni.mult(si.radius,r.ri);xi.vsub(xj,point_on_plane_to_sphere);r.ni.mult(r.ni.dot(point_on_plane_to_sphere),plane_to_sphere_ortho);point_on_plane_to_sphere.vsub(plane_to_sphere_ortho,r.rj);if(plane_to_sphere_ortho.norm2()<=si.radius*si.radius)result.push(r)}var pointInPolygon_edge=new CANNON.Vec3;var pointInPolygon_edge_x_normal=new CANNON.Vec3;var pointInPolygon_vtp=new CANNON.Vec3;function pointInPolygon(verts,normal,p){var positiveResult=null;var N=verts.length;for(var i=0;i<N;i++){var v=verts[i];var edge=pointInPolygon_edge;verts[(i+1)%N].vsub(v,edge);var edge_x_normal=pointInPolygon_edge_x_normal;edge.cross(normal,edge_x_normal);var vertex_to_p=pointInPolygon_vtp;p.vsub(v,vertex_to_p);var r=edge_x_normal.dot(vertex_to_p);if(positiveResult===null||r>0&&positiveResult===true||r<=0&&positiveResult===false){if(positiveResult===null)positiveResult=r>0;continue}else return false}return true}var box_to_sphere=new CANNON.Vec3;var sphereBox_ns=new CANNON.Vec3;var sphereBox_ns1=new CANNON.Vec3;var sphereBox_ns2=new CANNON.Vec3;var sphereBox_sides=[new CANNON.Vec3,new CANNON.Vec3,new CANNON.Vec3,new CANNON.Vec3,new CANNON.Vec3,new CANNON.Vec3];var sphereBox_sphere_to_corner=new CANNON.Vec3;var sphereBox_side_ns=new CANNON.Vec3;var sphereBox_side_ns1=new CANNON.Vec3;var sphereBox_side_ns2=new CANNON.Vec3;function sphereBox(result,si,sj,xi,xj,qi,qj,bi,bj){var sides=sphereBox_sides;xi.vsub(xj,box_to_sphere);sj.getSideNormals(sides,qj);var R=si.radius;var penetrating_sides=[];var found=false;var side_ns=sphereBox_side_ns;var side_ns1=sphereBox_side_ns1;var side_ns2=sphereBox_side_ns2;var side_h=null;var side_penetrations=0;var side_dot1=0;var side_dot2=0;var side_distance=null;for(var idx=0,nsides=sides.length;idx!==nsides&&found===false;idx++){var ns=sphereBox_ns;sides[idx].copy(ns);var h=ns.norm();ns.normalize();var dot=box_to_sphere.dot(ns);if(dot<h+R&&dot>0){var ns1=sphereBox_ns1;var ns2=sphereBox_ns2;sides[(idx+1)%3].copy(ns1);sides[(idx+2)%3].copy(ns2);var h1=ns1.norm();var h2=ns2.norm();ns1.normalize();ns2.normalize();var dot1=box_to_sphere.dot(ns1);var dot2=box_to_sphere.dot(ns2);if(dot1<h1&&dot1>-h1&&dot2<h2&&dot2>-h2){var dist=Math.abs(dot-h-R);if(side_distance===null||dist<side_distance){side_distance=dist;side_dot1=dot1;side_dot2=dot2;side_h=h;ns.copy(side_ns);ns1.copy(side_ns1);ns2.copy(side_ns2);side_penetrations++}}}}if(side_penetrations){found=true;var r=makeResult(bi,bj);side_ns.mult(-R,r.ri);side_ns.copy(r.ni);r.ni.negate(r.ni);side_ns.mult(side_h,side_ns);side_ns1.mult(side_dot1,side_ns1);side_ns.vadd(side_ns1,side_ns);side_ns2.mult(side_dot2,side_ns2);side_ns.vadd(side_ns2,r.rj);result.push(r)}var rj=v3pool.get();var sphere_to_corner=sphereBox_sphere_to_corner;for(var j=0;j!==2&&!found;j++){for(var k=0;k!==2&&!found;k++){for(var l=0;l!==2&&!found;l++){rj.set(0,0,0);if(j)rj.vadd(sides[0],rj);else rj.vsub(sides[0],rj);if(k)rj.vadd(sides[1],rj);else rj.vsub(sides[1],rj);if(l)rj.vadd(sides[2],rj);else rj.vsub(sides[2],rj);xj.vadd(rj,sphere_to_corner);sphere_to_corner.vsub(xi,sphere_to_corner);if(sphere_to_corner.norm2()<R*R){found=true;var r=makeResult(bi,bj);sphere_to_corner.copy(r.ri);r.ri.normalize();r.ri.copy(r.ni);r.ri.mult(R,r.ri);rj.copy(r.rj);result.push(r)}}}}v3pool.release(rj);rj=null;var edgeTangent=v3pool.get();var edgeCenter=v3pool.get();var r=v3pool.get();var orthogonal=v3pool.get();var dist=v3pool.get();var Nsides=sides.length;for(var j=0;j<Nsides&&!found;j++){for(var k=0;k<Nsides&&!found;k++){if(j%3!=k%3){sides[k].cross(sides[j],edgeTangent);edgeTangent.normalize();sides[j].vadd(sides[k],edgeCenter);xi.copy(r);r.vsub(edgeCenter,r);r.vsub(xj,r);var orthonorm=r.dot(edgeTangent);edgeTangent.mult(orthonorm,orthogonal);var l=0;while(l==j%3||l==k%3)l++;xi.copy(dist);dist.vsub(orthogonal,dist);dist.vsub(edgeCenter,dist);dist.vsub(xj,dist);var tdist=Math.abs(orthonorm);var ndist=dist.norm();if(tdist<sides[l].norm()&&ndist<R){found=true;var res=makeResult(bi,bj);edgeCenter.vadd(orthogonal,res.rj);res.rj.copy(res.rj);dist.negate(res.ni);res.ni.normalize();res.rj.copy(res.ri);res.ri.vadd(xj,res.ri);res.ri.vsub(xi,res.ri);res.ri.normalize();res.ri.mult(R,res.ri);result.push(res)}}}}v3pool.release(edgeTangent,edgeCenter,r,orthogonal,dist)}var convex_to_sphere=new CANNON.Vec3;var sphereConvex_edge=new CANNON.Vec3;var sphereConvex_edgeUnit=new CANNON.Vec3;var sphereConvex_sphereToCorner=new CANNON.Vec3;var sphereConvex_worldCorner=new CANNON.Vec3;var sphereConvex_worldNormal=new CANNON.Vec3;var sphereConvex_worldPoint=new CANNON.Vec3;var sphereConvex_worldSpherePointClosestToPlane=new CANNON.Vec3;var sphereConvex_penetrationVec=new CANNON.Vec3;var sphereConvex_sphereToWorldPoint=new CANNON.Vec3;function sphereConvex(result,si,sj,xi,xj,qi,qj,bi,bj){xi.vsub(xj,convex_to_sphere);var normals=sj.faceNormals;var faces=sj.faces;var verts=sj.vertices;var R=si.radius;var penetrating_sides=[];for(var i=0;i<verts.length;i++){var v=verts[i];var worldCorner=sphereConvex_worldCorner;qj.vmult(v,worldCorner);xj.vadd(worldCorner,worldCorner);var sphere_to_corner=sphereConvex_sphereToCorner;worldCorner.vsub(xi,sphere_to_corner);if(sphere_to_corner.norm2()<R*R){found=true;var r=makeResult(bi,bj);sphere_to_corner.copy(r.ri);r.ri.normalize();r.ri.copy(r.ni);r.ri.mult(R,r.ri);worldCorner.vsub(xj,r.rj);result.push(r);return}}var found=false;for(var i=0,nfaces=faces.length;i!==nfaces&&found===false;i++){var normal=normals[i];var face=faces[i];var worldNormal=sphereConvex_worldNormal;qj.vmult(normal,worldNormal);var worldPoint=sphereConvex_worldPoint;qj.vmult(verts[face[0]],worldPoint);worldPoint.vadd(xj,worldPoint);var worldSpherePointClosestToPlane=sphereConvex_worldSpherePointClosestToPlane;worldNormal.mult(-R,worldSpherePointClosestToPlane);xi.vadd(worldSpherePointClosestToPlane,worldSpherePointClosestToPlane);var penetrationVec=sphereConvex_penetrationVec;worldSpherePointClosestToPlane.vsub(worldPoint,penetrationVec);var penetration=penetrationVec.dot(worldNormal);var sphereToWorldPoint=sphereConvex_sphereToWorldPoint;xi.vsub(worldPoint,sphereToWorldPoint);if(penetration<0&&sphereToWorldPoint.dot(worldNormal)>0){var faceVerts=[];for(var j=0,Nverts=face.length;j!==Nverts;j++){var worldVertex=v3pool.get();qj.vmult(verts[face[j]],worldVertex);xj.vadd(worldVertex,worldVertex);faceVerts.push(worldVertex)}if(pointInPolygon(faceVerts,worldNormal,xi)){found=true;var r=makeResult(bi,bj);worldNormal.mult(-R,r.ri);worldNormal.negate(r.ni);var penetrationVec2=v3pool.get();worldNormal.mult(-penetration,penetrationVec2);var penetrationSpherePoint=v3pool.get();
worldNormal.mult(-R,penetrationSpherePoint);xi.vsub(xj,r.rj);r.rj.vadd(penetrationSpherePoint,r.rj);r.rj.vadd(penetrationVec2,r.rj);v3pool.release(penetrationVec2);v3pool.release(penetrationSpherePoint);result.push(r);return}else{for(var j=0;j<face.length;j++){var v1=v3pool.get();var v2=v3pool.get();qj.vmult(verts[face[(j+1)%face.length]],v1);qj.vmult(verts[face[(j+2)%face.length]],v2);xj.vadd(v1,v1);xj.vadd(v2,v2);var edge=sphereConvex_edge;v2.vsub(v1,edge);edgeUnit=sphereConvex_edgeUnit;edge.unit(edgeUnit);var p=v3pool.get();var v1_to_xi=v3pool.get();xi.vsub(v1,v1_to_xi);edgeUnit.mult(v1_to_xi.dot(edgeUnit),p);p.vadd(v1,p);var xi_to_p=v3pool.get();p.vsub(xi,xi_to_p);if(xi_to_p.norm2()<R*R){var r=makeResult(bi,bj);p.vsub(xj,r.rj);p.vsub(xi,r.ni);r.ni.normalize();r.ni.mult(R,r.ri);result.push(r);return}v3pool.release(v1);v3pool.release(v2);v3pool.release(p);v3pool.release(xi_to_p);v3pool.release(v1_to_xi)}}for(var j=0,Nfaceverts=faceVerts.length;j!==Nfaceverts;j++){v3pool.release(faceVerts[j])}}}}var planeBox_normal=new CANNON.Vec3;var plane_to_corner=new CANNON.Vec3;function planeBox(result,si,sj,xi,xj,qi,qj,bi,bj){planeConvex(result,si,sj.convexPolyhedronRepresentation,xi,xj,qi,qj,bi,bj)}var recurseCompound_v3pool=[];var recurseCompound_quatpool=[];function recurseCompound(result,si,sj,xi,xj,qi,qj,bi,bj){var v3pool=recurseCompound_v3pool;var quatPool=recurseCompound_quatpool;var nr=0;for(var i=0,Nchildren=sj.childShapes.length;i!==Nchildren;i++){var r=[];var newQuat=quatPool.pop()||new CANNON.Quaternion;var newPos=v3pool.pop()||new CANNON.Vec3;qj.mult(sj.childOrientations[i],newQuat);newQuat.normalize();qj.vmult(sj.childOffsets[i],newPos);xj.vadd(newPos,newPos);nearPhase(r,si,sj.childShapes[i],xi,newPos,qi,newQuat,bi,bj);quatPool.push(newQuat);var tempVec=newPos;if(!si)nr+=r.length;for(var j=0;j<r.length;j++){qj.vmult(sj.childOffsets[i],tempVec);r[j].rj.vadd(tempVec,r[j].rj);result.push(r[j])}v3pool.push(newPos)}}var planeConvex_v=new CANNON.Vec3;var planeConvex_normal=new CANNON.Vec3;var planeConvex_relpos=new CANNON.Vec3;var planeConvex_projected=new CANNON.Vec3;function planeConvex(result,si,sj,xi,xj,qi,qj,bi,bj){var v=planeConvex_v;var normal=planeConvex_normal;normal.set(0,0,1);qi.vmult(normal,normal);var relpos=planeConvex_relpos;for(var i=0;i<sj.vertices.length;i++){sj.vertices[i].copy(v);qj.vmult(v,v);xj.vadd(v,v);v.vsub(xi,relpos);var dot=normal.dot(relpos);if(dot<=0){var projected=planeConvex_projected;normal.mult(normal.dot(v),projected);v.vsub(projected,projected);var r=makeResult(bi,bj);normal.copy(r.ni);projected.copy(r.ri);v.vsub(xj,r.rj);result.push(r)}}}var convexConvex_sepAxis=new CANNON.Vec3;var convexConvex_q=new CANNON.Vec3;function convexConvex(result,si,sj,xi,xj,qi,qj,bi,bj){var sepAxis=convexConvex_sepAxis;if(si.findSeparatingAxis(sj,xi,qi,xj,qj,sepAxis)){var res=[];var q=convexConvex_q;si.clipAgainstHull(xi,qi,sj,xj,qj,sepAxis,-100,100,res);for(var j=0;j<res.length;j++){var r=makeResult(bi,bj);sepAxis.negate(r.ni);res[j].normal.negate(q);q.mult(res[j].depth,q);res[j].point.vadd(q,r.ri);res[j].point.copy(r.rj);r.rj.vsub(xj,r.rj);r.ri.vsub(xi,r.ri);result.push(r)}}}var particlePlane_normal=new CANNON.Vec3;var particlePlane_relpos=new CANNON.Vec3;var particlePlane_projected=new CANNON.Vec3;function particlePlane(result,si,sj,xi,xj,qi,qj,bi,bj){var normal=particlePlane_normal;normal.set(0,0,1);bj.quaternion.vmult(normal,normal);var relpos=particlePlane_relpos;xi.vsub(bj.position,relpos);var dot=normal.dot(relpos);if(dot<=0){var r=makeResult(bi,bj);normal.copy(r.ni);r.ni.negate(r.ni);r.ri.set(0,0,0);var projected=particlePlane_projected;normal.mult(normal.dot(xi),projected);xi.vsub(projected,projected);projected.copy(r.rj);result.push(r)}}var particleSphere_normal=new CANNON.Vec3;function particleSphere(result,si,sj,xi,xj,qi,qj,bi,bj){var normal=particleSphere_normal;normal.set(0,0,1);xi.vsub(xj,normal);var lengthSquared=normal.norm2();if(lengthSquared<=sj.radius*sj.radius){var r=makeResult(bi,bj);normal.normalize();normal.copy(r.rj);r.rj.mult(sj.radius,r.rj);normal.copy(r.ni);r.ni.negate(r.ni);r.ri.set(0,0,0);result.push(r)}}var cqj=new CANNON.Quaternion;var particleConvex_local=new CANNON.Vec3;var particleConvex_normal=new CANNON.Vec3;var particleConvex_penetratedFaceNormal=new CANNON.Vec3;function particleConvex(result,si,sj,xi,xj,qi,qj,bi,bj){var penetratedFaceIndex=-1;var penetratedFaceNormal=particleConvex_penetratedFaceNormal;var minPenetration=null;var numDetectedFaces=0;var local=particleConvex_local;xi.copy(local);local.vsub(xj,local);qj.conjugate(cqj);cqj.vmult(local,local);if(sj.pointIsInside(local)){for(var i=0,nfaces=sj.faces.length;i!==nfaces;i++){var verts=[];for(var j=0,nverts=sj.faces[i].length;j!==nverts;j++){var worldVertex=new CANNON.Vec3;sj.vertices[sj.faces[i][j]].copy(worldVertex);qj.vmult(worldVertex,worldVertex);worldVertex.vadd(xj,worldVertex);verts.push(worldVertex)}var normal=particleConvex_normal;sj.faceNormals[i].copy(normal);normal.normalize();qj.vmult(normal,normal);var penetration=-normal.dot(xi.vsub(verts[0]));if(minPenetration===null||Math.abs(penetration)<Math.abs(minPenetration)){minPenetration=penetration;penetratedFaceIndex=i;normal.copy(penetratedFaceNormal);numDetectedFaces++}}if(penetratedFaceIndex!==-1){var r=makeResult(bi,bj);var worldPenetrationVec=penetratedFaceNormal.mult(minPenetration);var projectedToFace=xi.vsub(xj).vadd(worldPenetrationVec);projectedToFace.copy(r.rj);penetratedFaceNormal.negate(r.ni);r.ri.set(0,0,0);result.push(r)}else{console.warn("Point found inside convex, but did not find penetrating face!")}}}function nearPhase(result,si,sj,xi,xj,qi,qj,bi,bj){var swapped=false,types=CANNON.Shape.types;if(si&&sj){if(si.type>sj.type){var temp;temp=sj;sj=si;si=temp;temp=xj;xj=xi;xi=temp;temp=qj;qj=qi;qi=temp;temp=bj;bj=bi;bi=temp;swapped=true}}else{if(si&&!sj){var temp;temp=sj;sj=si;si=temp;temp=xj;xj=xi;xi=temp;temp=qj;qj=qi;qi=temp;temp=bj;bj=bi;bi=temp;swapped=true}}if(si&&sj){if(si.type==types.SPHERE){switch(sj.type){case types.SPHERE:sphereSphere(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.PLANE:spherePlane(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.BOX:sphereBox(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.COMPOUND:recurseCompound(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.CONVEXPOLYHEDRON:sphereConvex(result,si,sj,xi,xj,qi,qj,bi,bj);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+sj.type+" not implemented yet.");break}}else if(si.type==types.PLANE){switch(sj.type){case types.PLANE:throw new Error("Plane-plane collision... wait, you did WHAT?");break;case types.BOX:planeBox(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.COMPOUND:recurseCompound(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.CONVEXPOLYHEDRON:planeConvex(result,si,sj,xi,xj,qi,qj,bi,bj);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+sj.type+" not implemented yet.");break}}else if(si.type==types.BOX){switch(sj.type){case types.BOX:nearPhase(result,si.convexPolyhedronRepresentation,sj.convexPolyhedronRepresentation,xi,xj,qi,qj,bi,bj);break;case types.COMPOUND:recurseCompound(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.CONVEXPOLYHEDRON:nearPhase(result,si.convexPolyhedronRepresentation,sj,xi,xj,qi,qj,bi,bj);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+sj.type+" not implemented yet.");break}}else if(si.type==types.COMPOUND){switch(sj.type){case types.COMPOUND:recurseCompound(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.CONVEXPOLYHEDRON:var r=[];recurseCompound(r,sj,si,xj,xi,qj,qi,bj,bi);for(var ri=0;ri<r.length;ri++){swapResult(r[ri]);result.push(r[ri])}break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+sj.type+" not implemented yet.");break}}else if(si.type==types.CONVEXPOLYHEDRON){switch(sj.type){case types.CONVEXPOLYHEDRON:convexConvex(result,si,sj,xi,xj,qi,qj,bi,bj);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+sj.type+" not implemented yet.");break}}}else{switch(sj.type){case types.PLANE:particlePlane(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.SPHERE:particleSphere(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.BOX:particleConvex(result,si,sj.convexPolyhedronRepresentation,xi,xj,qi,qj,bi,bj);break;case types.CONVEXPOLYHEDRON:particleConvex(result,si,sj,xi,xj,qi,qj,bi,bj);break;case types.COMPOUND:recurseCompound(result,si,sj,xi,xj,qi,qj,bi,bj);break;default:console.warn("Collision between CANNON.Particle and "+sj.type+" not implemented yet.");break}}for(var i=0;swapped&&i<result.length;i++)swapResult(result[i])}this.reduceContacts=function(contacts){};this.getContacts=function(p1,p2,world,result,oldcontacts){for(var i=0;oldcontacts&&i<oldcontacts.length;i++)contactPointPool.push(oldcontacts[i]);for(var k=0;k<p1.length;k++){var bi=p1[k],bj=p2[k];nearPhase(result,bi.shape,bj.shape,bi.position,bj.position,bi.quaternion,bj.quaternion,bi,bj)}}};CANNON.Equation=function(bi,bj,minForce,maxForce){this.id=-1;this.minForce=typeof minForce=="undefined"?-1e6:minForce;this.maxForce=typeof maxForce=="undefined"?1e6:maxForce;this.bi=bi;this.bj=bj;this.stiffness=1e7;this.regularizationTime=5;this.a=0;this.b=0;this.eps=0;this.spookParamsNeedsUpdate=true};CANNON.Equation.prototype.constructor=CANNON.Equation;CANNON.Equation.prototype.updateSpookParams=function(h){var d=this.regularizationTime,k=this.stiffness;this.a=4/(h*(1+4*d));this.b=4*d/(1+4*d);this.eps=4/(h*h*k*(1+4*d))};CANNON.ContactEquation=function(bi,bj){CANNON.Equation.call(this,bi,bj,0,1e6);this.restitution=0;this.penetration=0;this.ri=new CANNON.Vec3;this.penetrationVec=new CANNON.Vec3;this.rj=new CANNON.Vec3;this.ni=new CANNON.Vec3;this.rixn=new CANNON.Vec3;this.rjxn=new CANNON.Vec3;this.rixw=new CANNON.Vec3;this.rjxw=new CANNON.Vec3;this.invIi=new CANNON.Mat3;this.invIj=new CANNON.Mat3;this.relVel=new CANNON.Vec3;this.relForce=new CANNON.Vec3};CANNON.ContactEquation.prototype=new CANNON.Equation;CANNON.ContactEquation.prototype.constructor=CANNON.ContactEquation;var ContactEquation_computeB_temp1=new CANNON.Vec3;var ContactEquation_computeB_temp2=new CANNON.Vec3;CANNON.ContactEquation.prototype.computeB=function(h){var a=this.a,b=this.b;var bi=this.bi;var bj=this.bj;var ri=this.ri;var rj=this.rj;var rixn=this.rixn;var rjxn=this.rjxn;var vi=bi.velocity;var wi=bi.angularVelocity?bi.angularVelocity:new CANNON.Vec3;var fi=bi.force;var taui=bi.tau?bi.tau:new CANNON.Vec3;var vj=bj.velocity;var wj=bj.angularVelocity?bj.angularVelocity:new CANNON.Vec3;var fj=bj.force;var tauj=bj.tau?bj.tau:new CANNON.Vec3;var relVel=this.relVel;var relForce=this.relForce;var penetrationVec=this.penetrationVec;var invMassi=bi.invMass;var invMassj=bj.invMass;var invIi=this.invIi;var invIj=this.invIj;if(bi.invInertia)invIi.setTrace(bi.invInertia);else invIi.identity();if(bj.invInertia)invIj.setTrace(bj.invInertia);else invIj.identity();var n=this.ni;ri.cross(n,rixn);rj.cross(n,rjxn);var penetrationVec=this.penetrationVec;penetrationVec.set(0,0,0);penetrationVec.vadd(bj.position,penetrationVec);penetrationVec.vadd(rj,penetrationVec);penetrationVec.vsub(bi.position,penetrationVec);penetrationVec.vsub(ri,penetrationVec);var Gq=n.dot(penetrationVec);var invIi_vmult_taui=ContactEquation_computeB_temp1;var invIj_vmult_tauj=ContactEquation_computeB_temp2;invIi.vmult(taui,invIi_vmult_taui);invIj.vmult(tauj,invIj_vmult_tauj);var ePlusOne=this.restitution+1;var GW=ePlusOne*vj.dot(n)-ePlusOne*vi.dot(n)+wj.dot(rjxn)-wi.dot(rixn);var GiMf=fj.dot(n)*invMassj-fi.dot(n)*invMassi+rjxn.dot(invIj_vmult_tauj)-rixn.dot(invIi_vmult_taui);var B=-Gq*a-GW*b-h*GiMf;return B};var computeC_temp1=new CANNON.Vec3;var computeC_temp2=new CANNON.Vec3;CANNON.ContactEquation.prototype.computeC=function(){var bi=this.bi;var bj=this.bj;var rixn=this.rixn;var rjxn=this.rjxn;var invMassi=bi.invMass;var invMassj=bj.invMass;var C=invMassi+invMassj+this.eps;var invIi=this.invIi;var invIj=this.invIj;if(bi.invInertia)invIi.setTrace(bi.invInertia);else invIi.identity();if(bj.invInertia)invIj.setTrace(bj.invInertia);else invIj.identity();invIi.vmult(rixn,computeC_temp1);invIj.vmult(rjxn,computeC_temp2);C+=computeC_temp1.dot(rixn);C+=computeC_temp2.dot(rjxn);return C};var computeGWlambda_ulambda=new CANNON.Vec3;CANNON.ContactEquation.prototype.computeGWlambda=function(){var bi=this.bi;var bj=this.bj;var ulambda=computeGWlambda_ulambda;var GWlambda=0;bj.vlambda.vsub(bi.vlambda,ulambda);GWlambda+=ulambda.dot(this.ni);if(bi.wlambda)GWlambda-=bi.wlambda.dot(this.rixn);if(bj.wlambda)GWlambda+=bj.wlambda.dot(this.rjxn);return GWlambda};var ContactEquation_addToWlambda_temp1=new CANNON.Vec3;var ContactEquation_addToWlambda_temp2=new CANNON.Vec3;CANNON.ContactEquation.prototype.addToWlambda=function(deltalambda){var bi=this.bi;var bj=this.bj;var rixn=this.rixn;var rjxn=this.rjxn;var invMassi=bi.invMass;var invMassj=bj.invMass;var n=this.ni;var temp1=ContactEquation_addToWlambda_temp1;var temp2=ContactEquation_addToWlambda_temp2;n.mult(invMassi*deltalambda,temp2);bi.vlambda.vsub(temp2,bi.vlambda);n.mult(invMassj*deltalambda,temp2);bj.vlambda.vadd(temp2,bj.vlambda);if(bi.wlambda){var I=this.invIi;I.vmult(rixn,temp1);temp1.mult(deltalambda,temp1);bi.wlambda.vsub(temp1,bi.wlambda)}if(bj.wlambda){var I=this.invIj;I.vmult(rjxn,temp1);temp1.mult(deltalambda,temp1);bj.wlambda.vadd(temp1,bj.wlambda)}};CANNON.FrictionEquation=function(bi,bj,slipForce){CANNON.Equation.call(this,bi,bj,-slipForce,slipForce);this.ri=new CANNON.Vec3;this.rj=new CANNON.Vec3;this.t=new CANNON.Vec3;this.rixt=new CANNON.Vec3;this.rjxt=new CANNON.Vec3;this.wixri=new CANNON.Vec3;this.wjxrj=new CANNON.Vec3;this.invIi=new CANNON.Mat3;this.invIj=new CANNON.Mat3;this.relVel=new CANNON.Vec3;this.relForce=new CANNON.Vec3};CANNON.FrictionEquation.prototype=new CANNON.Equation;CANNON.FrictionEquation.prototype.constructor=CANNON.FrictionEquation;var FrictionEquation_computeB_temp1=new CANNON.Vec3;var FrictionEquation_computeB_temp2=new CANNON.Vec3;CANNON.FrictionEquation.prototype.computeB=function(h){var a=this.a,b=this.b;var bi=this.bi;var bj=this.bj;var ri=this.ri;var rj=this.rj;var rixt=this.rixt;var rjxt=this.rjxt;var wixri=this.wixri;var wjxrj=this.wjxrj;var vi=bi.velocity;var wi=bi.angularVelocity?bi.angularVelocity:new CANNON.Vec3;var fi=bi.force;var taui=bi.tau?bi.tau:new CANNON.Vec3;var vj=bj.velocity;var wj=bj.angularVelocity?bj.angularVelocity:new CANNON.Vec3;var fj=bj.force;var tauj=bj.tau?bj.tau:new CANNON.Vec3;var relVel=this.relVel;var relForce=this.relForce;var invMassi=bi.invMass;var invMassj=bj.invMass;var invIi=this.invIi;var invIj=this.invIj;if(bi.invInertia)invIi.setTrace(bi.invInertia);if(bj.invInertia)invIj.setTrace(bj.invInertia);var t=this.t;ri.cross(t,rixt);rj.cross(t,rjxt);wi.cross(ri,wixri);wj.cross(rj,wjxrj);var invIi_vmult_taui=FrictionEquation_computeB_temp1;var invIj_vmult_tauj=FrictionEquation_computeB_temp2;invIi.vmult(taui,invIi_vmult_taui);invIj.vmult(tauj,invIj_vmult_tauj);var Gq=0;var GW=vj.dot(t)-vi.dot(t)+wjxrj.dot(t)-wixri.dot(t);var GiMf=fj.dot(t)*invMassj-fi.dot(t)*invMassi+rjxt.dot(invIj_vmult_tauj)-rixt.dot(invIi_vmult_taui);var B=-Gq*a-GW*b-h*GiMf;return B};var FEcomputeC_temp1=new CANNON.Vec3;var FEcomputeC_temp2=new CANNON.Vec3;CANNON.FrictionEquation.prototype.computeC=function(){var bi=this.bi;var bj=this.bj;var rixt=this.rixt;var rjxt=this.rjxt;var invMassi=bi.invMass;var invMassj=bj.invMass;var C=invMassi+invMassj+this.eps;var invIi=this.invIi;var invIj=this.invIj;if(bi.invInertia)invIi.setTrace(bi.invInertia);if(bj.invInertia)invIj.setTrace(bj.invInertia);invIi.vmult(rixt,FEcomputeC_temp1);invIj.vmult(rjxt,FEcomputeC_temp2);C+=FEcomputeC_temp1.dot(rixt);C+=FEcomputeC_temp2.dot(rjxt);return C};var FrictionEquation_computeGWlambda_ulambda=new CANNON.Vec3;CANNON.FrictionEquation.prototype.computeGWlambda=function(){var bi=this.bi;var bj=this.bj;var GWlambda=0;var ulambda=FrictionEquation_computeGWlambda_ulambda;bj.vlambda.vsub(bi.vlambda,ulambda);GWlambda+=ulambda.dot(this.t);if(bi.wlambda)GWlambda-=bi.wlambda.dot(this.rixt);if(bj.wlambda)GWlambda+=bj.wlambda.dot(this.rjxt);return GWlambda};var FrictionEquation_addToWlambda_tmp=new CANNON.Vec3;CANNON.FrictionEquation.prototype.addToWlambda=function(deltalambda){var bi=this.bi;var bj=this.bj;var rixt=this.rixt;var rjxt=this.rjxt;var invMassi=bi.invMass;var invMassj=bj.invMass;var t=this.t;var tmp=FrictionEquation_addToWlambda_tmp;t.mult(invMassi*deltalambda,tmp);bi.vlambda.vsub(tmp,bi.vlambda);t.mult(invMassj*deltalambda,tmp);bj.vlambda.vadd(tmp,bj.vlambda);var wi=bi.wlambda;if(wi){var I=this.invIi;I.vmult(rixt,tmp);tmp.mult(deltalambda,tmp);wi.vsub(tmp,wi)}var wj=bj.wlambda;if(wj){var I=this.invIj;I.vmult(rjxt,tmp);tmp.mult(deltalambda,tmp);wj.vadd(tmp,wj)}};CANNON.RotationalEquation=function(bodyA,bodyB){CANNON.Equation.call(this,bodyA,bodyB,-1e6,1e6);this.ni=new CANNON.Vec3;this.nj=new CANNON.Vec3;this.nixnj=new CANNON.Vec3;this.njxni=new CANNON.Vec3;this.invIi=new CANNON.Mat3;this.invIj=new CANNON.Mat3;this.relVel=new CANNON.Vec3;this.relForce=new CANNON.Vec3};CANNON.RotationalEquation.prototype=new CANNON.Equation;CANNON.RotationalEquation.prototype.constructor=CANNON.RotationalEquation;CANNON.RotationalEquation.prototype.computeB=function(h){var a=this.a,b=this.b;var bi=this.bi;var bj=this.bj;var ni=this.ni;var nj=this.nj;var nixnj=this.nixnj;var njxni=this.njxni;var vi=bi.velocity;var wi=bi.angularVelocity?bi.angularVelocity:new CANNON.Vec3;var fi=bi.force;var taui=bi.tau?bi.tau:new CANNON.Vec3;var vj=bj.velocity;var wj=bj.angularVelocity?bj.angularVelocity:new CANNON.Vec3;var fj=bj.force;var tauj=bj.tau?bj.tau:new CANNON.Vec3;var invMassi=bi.invMass;var invMassj=bj.invMass;var invIi=this.invIi;var invIj=this.invIj;if(bi.invInertia)invIi.setTrace(bi.invInertia);else invIi.identity();if(bj.invInertia)invIj.setTrace(bj.invInertia);else invIj.identity();ni.cross(nj,nixnj);nj.cross(ni,njxni);var Gq=-ni.dot(nj);var GW=njxni.dot(wi)+nixnj.dot(wj);var GiMf=0;var B=-Gq*a-GW*b-h*GiMf;return B};CANNON.RotationalEquation.prototype.computeC=function(){var bi=this.bi;var bj=this.bj;var nixnj=this.nixnj;var njxni=this.njxni;var invMassi=bi.invMass;var invMassj=bj.invMass;var C=this.eps;var invIi=this.invIi;var invIj=this.invIj;if(bi.invInertia)invIi.setTrace(bi.invInertia);else invIi.identity();if(bj.invInertia)invIj.setTrace(bj.invInertia);else invIj.identity();C+=invIi.vmult(njxni).dot(njxni);C+=invIj.vmult(nixnj).dot(nixnj);return C};var computeGWlambda_ulambda=new CANNON.Vec3;CANNON.RotationalEquation.prototype.computeGWlambda=function(){var bi=this.bi;var bj=this.bj;var ulambda=computeGWlambda_ulambda;var GWlambda=0;if(bi.wlambda)GWlambda+=bi.wlambda.dot(this.njxni);if(bj.wlambda)GWlambda+=bj.wlambda.dot(this.nixnj);return GWlambda};CANNON.RotationalEquation.prototype.addToWlambda=function(deltalambda){var bi=this.bi;var bj=this.bj;var nixnj=this.nixnj;var njxni=this.njxni;var invMassi=bi.invMass;var invMassj=bj.invMass;if(bi.wlambda){var I=this.invIi;bi.wlambda.vsub(I.vmult(nixnj).mult(deltalambda),bi.wlambda)}if(bj.wlambda){var I=this.invIj;bj.wlambda.vadd(I.vmult(nixnj).mult(deltalambda),bj.wlambda)}};CANNON.Constraint=function(bodyA,bodyB){this.equations=[];this.bodyA=bodyA;this.bodyB=bodyB};CANNON.Constraint.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")};CANNON.DistanceConstraint=function(bodyA,bodyB,distance,maxForce){CANNON.Constraint.call(this,bodyA,bodyB);if(typeof maxForce=="undefined")maxForce=1e6;var eqs=this.equations=[new CANNON.ContactEquation(bodyA,bodyB)];var normal=eqs[0];normal.minForce=-maxForce;normal.maxForce=maxForce;this.update=function(){bodyB.position.vsub(bodyA.position,normal.ni);normal.ni.normalize();normal.ni.mult(distance*.5,normal.ri);normal.ni.mult(-distance*.5,normal.rj)}};CANNON.DistanceConstraint.prototype=new CANNON.Constraint;CANNON.RotationalMotorEquation=function(bodyA,bodyB,maxForce){maxForce=maxForce||1e6;CANNON.Equation.call(this,bodyA,bodyB,-maxForce,maxForce);this.axisA=new CANNON.Vec3;this.axisB=new CANNON.Vec3;this.invIi=new CANNON.Mat3;this.invIj=new CANNON.Mat3;this.targetVelocity=0};CANNON.RotationalMotorEquation.prototype=new CANNON.Equation;CANNON.RotationalMotorEquation.prototype.constructor=CANNON.RotationalMotorEquation;CANNON.RotationalMotorEquation.prototype.computeB=function(h){var a=this.a,b=this.b;var bi=this.bi;var bj=this.bj;var axisA=this.axisA;var axisB=this.axisB;var vi=bi.velocity;var wi=bi.angularVelocity?bi.angularVelocity:new CANNON.Vec3;var fi=bi.force;var taui=bi.tau?bi.tau:new CANNON.Vec3;var vj=bj.velocity;var wj=bj.angularVelocity?bj.angularVelocity:new CANNON.Vec3;var fj=bj.force;var tauj=bj.tau?bj.tau:new CANNON.Vec3;var invMassi=bi.invMass;var invMassj=bj.invMass;var invIi=this.invIi;var invIj=this.invIj;if(bi.invInertia)invIi.setTrace(bi.invInertia);else invIi.identity();if(bj.invInertia)invIj.setTrace(bj.invInertia);else invIj.identity();var Gq=0;var GW=axisA.dot(wi)+axisB.dot(wj)+this.targetVelocity;var GiMf=0;var B=-Gq*a-GW*b-h*GiMf;return B};CANNON.RotationalMotorEquation.prototype.computeC=function(){var bi=this.bi;var bj=this.bj;var axisA=this.axisA;var axisB=this.axisB;var invMassi=bi.invMass;var invMassj=bj.invMass;var C=this.eps;var invIi=this.invIi;var invIj=this.invIj;if(bi.invInertia)invIi.setTrace(bi.invInertia);else invIi.identity();if(bj.invInertia)invIj.setTrace(bj.invInertia);else invIj.identity();C+=invIi.vmult(axisA).dot(axisB);C+=invIj.vmult(axisB).dot(axisB);return C};var computeGWlambda_ulambda=new CANNON.Vec3;CANNON.RotationalMotorEquation.prototype.computeGWlambda=function(){var bi=this.bi;var bj=this.bj;var ulambda=computeGWlambda_ulambda;var axisA=this.axisA;var axisB=this.axisB;var GWlambda=0;if(bi.wlambda)GWlambda+=bi.wlambda.dot(axisA);if(bj.wlambda)GWlambda+=bj.wlambda.dot(axisB);return GWlambda};CANNON.RotationalMotorEquation.prototype.addToWlambda=function(deltalambda){var bi=this.bi;var bj=this.bj;var axisA=this.axisA;var axisB=this.axisB;var invMassi=bi.invMass;var invMassj=bj.invMass;if(bi.wlambda){var I=this.invIi;bi.wlambda.vsub(I.vmult(axisA).mult(deltalambda),bi.wlambda)}if(bj.wlambda){var I=this.invIj;bj.wlambda.vadd(I.vmult(axisB).mult(deltalambda),bj.wlambda)}};CANNON.HingeConstraint=function(bodyA,pivotA,axisA,bodyB,pivotB,axisB,maxForce){CANNON.Constraint.call(this,bodyA,bodyB);maxForce=maxForce||1e6;var that=this;var eqs=this.equations=[new CANNON.RotationalEquation(bodyA,bodyB),new CANNON.RotationalEquation(bodyA,bodyB),new CANNON.ContactEquation(bodyA,bodyB),new CANNON.ContactEquation(bodyA,bodyB),new CANNON.ContactEquation(bodyA,bodyB)];this.getRotationalEquation1=function(){return eqs[0]};this.getRotationalEquation2=function(){return eqs[1]};this.getPointToPointEquation1=function(){return eqs[2]};this.getPointToPointEquation2=function(){return eqs[3]};this.getPointToPointEquation3=function(){return eqs[4]};var r1=this.getRotationalEquation1();var r2=this.getRotationalEquation2();var normal=this.getPointToPointEquation1();var t1=this.getPointToPointEquation2();var t2=this.getPointToPointEquation3();var motor;t1.minForce=t2.minForce=normal.minForce=-maxForce;t1.maxForce=t2.maxForce=normal.maxForce=maxForce;var unitPivotA=pivotA.unit();var unitPivotB=pivotB.unit();var axisA_x_pivotA=axisA.cross(unitPivotA);var axisA_x_axisA_x_pivotA=axisA.cross(axisA_x_pivotA);var axisB_x_pivotB=axisB.cross(unitPivotB);axisA_x_pivotA.normalize();axisB_x_pivotB.normalize();var motorEnabled=false;this.motorTargetVelocity=0;this.motorMinForce=-maxForce;this.motorMaxForce=maxForce;this.enableMotor=function(){if(!motorEnabled){motor=new CANNON.RotationalMotorEquation(bodyA,bodyB,maxForce);eqs.push(motor);motorEnabled=true}};this.disableMotor=function(){if(motorEnabled){motorEnabled=false;motor=null;eqs.pop()}};this.update=function(){normal.ni.set(1,0,0);t1.ni.set(0,1,0);t2.ni.set(0,0,1);bodyA.quaternion.vmult(pivotA,normal.ri);bodyB.quaternion.vmult(pivotB,normal.rj);normal.ri.copy(t1.ri);normal.rj.copy(t1.rj);normal.ri.copy(t2.ri);normal.rj.copy(t2.rj);bodyA.quaternion.vmult(axisA_x_pivotA,r1.ni);bodyB.quaternion.vmult(axisB,r1.nj);bodyA.quaternion.vmult(axisA_x_axisA_x_pivotA,r2.ni);bodyB.quaternion.vmult(axisB,r2.nj);if(motorEnabled){bodyA.quaternion.vmult(axisA,motor.axisA);bodyB.quaternion.vmult(axisB,motor.axisB);motor.targetVelocity=that.motorTargetVelocity;motor.maxForce=that.motorMaxForce;motor.minForce=that.motorMinForce}}};CANNON.HingeConstraint.prototype=new CANNON.Constraint;CANNON.PointToPointConstraint=function(bodyA,pivotA,bodyB,pivotB,maxForce){CANNON.Constraint.call(this,bodyA,bodyB);var eqs=this.equations=[new CANNON.ContactEquation(bodyA,bodyB),new CANNON.ContactEquation(bodyA,bodyB),new CANNON.ContactEquation(bodyA,bodyB)];var normal=eqs[0];var t1=eqs[1];var t2=eqs[2];t1.minForce=t2.minForce=normal.minForce=-maxForce;t1.maxForce=t2.maxForce=normal.maxForce=maxForce;this.update=function(){bodyB.position.vsub(bodyA.position,normal.ni);normal.ni.normalize();bodyA.quaternion.vmult(pivotA,normal.ri);bodyB.quaternion.vmult(pivotB,normal.rj);normal.ni.tangents(t1.ni,t2.ni);normal.ri.copy(t1.ri);normal.rj.copy(t1.rj);normal.ri.copy(t2.ri);normal.rj.copy(t2.rj)}};CANNON.PointToPointConstraint.prototype=new CANNON.Constraint;if(typeof module!=="undefined"){module.exports=CANNON}else{this.CANNON=CANNON}}).apply(this);