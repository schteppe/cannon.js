!function(){var a=a||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),a.Mat3=function(a){this.elements=a?a:[0,0,0,0,0,0,0,0,0]},a.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},a.Mat3.prototype.setZero=function(){var a=this.elements;a[0]=0,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=0,a[6]=0,a[7]=0,a[8]=0},a.Mat3.prototype.setTrace=function(a){var b=this.elements;b[0]=a.x,b[4]=a.y,b[8]=a.z},a.Mat3.prototype.vmult=function(b,c){c=c||new a.Vec3;var d=this.elements,e=b.x,f=b.y,g=b.z;return c.x=d[0]*e+d[1]*f+d[2]*g,c.y=d[3]*e+d[4]*f+d[5]*g,c.z=d[6]*e+d[7]*f+d[8]*g,c},a.Mat3.prototype.smult=function(a){for(var b=0;b<this.elements.length;b++)this.elements[b]*=a},a.Mat3.prototype.mmult=function(b){for(var c=new a.Mat3,d=0;3>d;d++)for(var e=0;3>e;e++){for(var f=0,g=0;3>g;g++)f+=b.elements[d+3*g]*this.elements[g+3*e];c.elements[d+3*e]=f}return c},a.Mat3.prototype.solve=function(b,c){c=c||new a.Vec3;for(var d=3,e=4,f=[],g=0;d*e>g;g++)f.push(0);var g,h;for(g=0;3>g;g++)for(h=0;3>h;h++)f[g+e*h]=this.elements[g+3*h];f[3]=b.x,f[7]=b.y,f[11]=b.z;var i,j,k=3,l=k,m=4;do{if(g=l-k,0===f[g+e*g])for(h=g+1;l>h;h++)if(0!==f[g+e*h]){i=m;do j=m-i,f[j+e*g]+=f[j+e*h];while(--i);break}if(0!==f[g+e*g])for(h=g+1;l>h;h++){var n=f[g+e*h]/f[g+e*g];i=m;do j=m-i,f[j+e*h]=g>=j?0:f[j+e*h]-f[j+e*g]*n;while(--i)}}while(--k);if(c.z=f[2*e+3]/f[2*e+2],c.y=(f[1*e+3]-f[1*e+2]*c.z)/f[1*e+1],c.x=(f[0*e+3]-f[0*e+2]*c.z-f[0*e+1]*c.y)/f[0*e+0],isNaN(c.x)||isNaN(c.y)||isNaN(c.z)||1/0===c.x||1/0===c.y||1/0===c.z)throw"Could not solve equation! Got x=["+c.toString()+"], b=["+b.toString()+"], A=["+this.toString()+"]";return c},a.Mat3.prototype.e=function(a,b,c){return void 0===c?this.elements[b+3*a]:(this.elements[b+3*a]=c,void 0)},a.Mat3.prototype.copy=function(b){b=b||new a.Mat3;for(var c=0;c<this.elements.length;c++)b.elements[c]=this.elements[c];return b},a.Mat3.prototype.toString=function(){for(var a="",b=",",c=0;9>c;c++)a+=this.elements[c]+b;return a},a.Mat3.prototype.reverse=function(b){b=b||new a.Mat3;for(var c=3,d=6,e=[],f=0;c*d>f;f++)e.push(0);var f,g;for(f=0;3>f;f++)for(g=0;3>g;g++)e[f+d*g]=this.elements[f+3*g];e[3]=1,e[9]=0,e[15]=0,e[4]=0,e[10]=1,e[16]=0,e[5]=0,e[11]=0,e[17]=1;var h,i,j=3,k=j,l=d;do{if(f=k-j,0===e[f+d*f])for(g=f+1;k>g;g++)if(0!==e[f+d*g]){h=l;do i=l-h,e[i+d*f]+=e[i+d*g];while(--h);break}if(0!==e[f+d*f])for(g=f+1;k>g;g++){var m=e[f+d*g]/e[f+d*f];h=l;do i=l-h,e[i+d*g]=f>=i?0:e[i+d*g]-e[i+d*f]*m;while(--h)}}while(--j);f=2;do{g=f-1;do{var m=e[f+d*g]/e[f+d*f];h=d;do i=d-h,e[i+d*g]=e[i+d*g]-e[i+d*f]*m;while(--h)}while(g--)}while(--f);f=2;do{var m=1/e[f+d*f];h=d;do i=d-h,e[i+d*f]=e[i+d*f]*m;while(--h)}while(f--);f=2;do{g=2;do{if(i=e[c+g+d*f],isNaN(i)||1/0===i)throw"Could not reverse! A=["+this.toString()+"]";b.e(f,g,i)}while(g--)}while(f--);return b},a.Vec3=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},a.Vec3.prototype.cross=function(b,c){var d=b.x,e=b.y,f=b.z,g=this.x,h=this.y,i=this.z;return c=c||new a.Vec3,c.x=h*f-i*e,c.y=i*d-g*f,c.z=g*e-h*d,c},a.Vec3.prototype.set=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},a.Vec3.prototype.vadd=function(b,c){return c?(c.x=b.x+this.x,c.y=b.y+this.y,c.z=b.z+this.z,void 0):new a.Vec3(this.x+b.x,this.y+b.y,this.z+b.z)},a.Vec3.prototype.vsub=function(b,c){return c?(c.x=this.x-b.x,c.y=this.y-b.y,c.z=this.z-b.z,void 0):new a.Vec3(this.x-b.x,this.y-b.y,this.z-b.z)},a.Vec3.prototype.crossmat=function(){return new a.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},a.Vec3.prototype.normalize=function(){var a=this.x,b=this.y,c=this.z,d=Math.sqrt(a*a+b*b+c*c);if(d>0){var e=1/d;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return d},a.Vec3.prototype.unit=function(b){b=b||new a.Vec3;var c=this.x,d=this.y,e=this.z,f=Math.sqrt(c*c+d*d+e*e);return f>0?(f=1/f,b.x=c*f,b.y=d*f,b.z=e*f):(b.x=1,b.y=0,b.z=0),b},a.Vec3.prototype.norm=function(){var a=this.x,b=this.y,c=this.z;return Math.sqrt(a*a+b*b+c*c)},a.Vec3.prototype.norm2=function(){return this.dot(this)},a.Vec3.prototype.distanceTo=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;return Math.sqrt((e-b)*(e-b)+(f-c)*(f-c)+(g-d)*(g-d))},a.Vec3.prototype.mult=function(b,c){c=c||new a.Vec3;var d=this.x,e=this.y,f=this.z;return c.x=b*d,c.y=b*e,c.z=b*f,c},a.Vec3.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},a.Vec3.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},a.Vec3.prototype.negate=function(b){return b=b||new a.Vec3,b.x=-this.x,b.y=-this.y,b.z=-this.z,b};var b=new a.Vec3,c=new a.Vec3;a.Vec3.prototype.tangents=function(a,d){var e=this.norm();if(e>0){var f=b,g=1/e;f.set(this.x*g,this.y*g,this.z*g);var h=c;Math.abs(f.x)<.9?(h.set(1,0,0),f.cross(h,a)):(h.set(0,1,0),f.cross(h,a)),f.cross(a,d)}else a.set(1,0,0).normalize(),d.set(0,1,0).normalize()},a.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},a.Vec3.prototype.copy=function(b){return b=b||new a.Vec3,b.x=this.x,b.y=this.y,b.z=this.z,b},a.Vec3.prototype.lerp=function(a,b,c){var d=this.x,e=this.y,f=this.z;c.x=d+(a.x-d)*b,c.y=e+(a.y-e)*b,c.z=f+(a.z-f)*b},a.Vec3.prototype.almostEquals=function(a,b){return void 0===b&&(b=1e-6),Math.abs(this.x-a.x)>b||Math.abs(this.y-a.y)>b||Math.abs(this.z-a.z)>b?!1:!0},a.Vec3.prototype.almostZero=function(a){return void 0===a&&(a=1e-6),Math.abs(this.x)>a||Math.abs(this.y)>a||Math.abs(this.z)>a?!1:!0},a.Quaternion=function(a,b,c,d){this.x=void 0!==a?a:0,this.y=void 0!==b?b:0,this.z=void 0!==c?c:0,this.w=void 0!==d?d:1},a.Quaternion.prototype.set=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},a.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},a.Quaternion.prototype.setFromAxisAngle=function(a,b){var c=Math.sin(.5*b);this.x=a.x*c,this.y=a.y*c,this.z=a.z*c,this.w=Math.cos(.5*b)},a.Quaternion.prototype.toAxisAngle=function(b){b=b||new a.Vec3,this.normalize();var c=2*Math.acos(this.w),d=Math.sqrt(1-this.w*this.w);return.001>d?(b.x=this.x,b.y=this.y,b.z=this.z):(b.x=this.x/d,b.y=this.y/d,b.z=this.z/d),[b,c]},a.Quaternion.prototype.setFromVectors=function(a,b){var c=a.cross(b);this.x=c.x,this.y=c.y,this.z=c.z,this.w=Math.sqrt(Math.pow(a.norm(),2)*Math.pow(b.norm(),2))+a.dot(b),this.normalize()};var d=new a.Vec3,e=new a.Vec3,f=new a.Vec3;a.Quaternion.prototype.mult=function(b,c){c=c||new a.Quaternion;var g=this.w,h=d,i=e,j=f;return h.set(this.x,this.y,this.z),i.set(b.x,b.y,b.z),c.w=g*b.w-h.dot(i),h.cross(i,j),c.x=g*i.x+b.w*h.x+j.x,c.y=g*i.y+b.w*h.y+j.y,c.z=g*i.z+b.w*h.z+j.z,c},a.Quaternion.prototype.inverse=function(b){var c=this.x,d=this.y,e=this.z,f=this.w;b=b||new a.Quaternion,this.conjugate(b);var g=1/(c*c+d*d+e*e+f*f);return b.x*=g,b.y*=g,b.z*=g,b.w*=g,b},a.Quaternion.prototype.conjugate=function(b){return b=b||new a.Quaternion,b.x=-this.x,b.y=-this.y,b.z=-this.z,b.w=this.w,b},a.Quaternion.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===a?(this.x=0,this.y=0,this.z=0,this.w=0):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a)},a.Quaternion.prototype.normalizeFast=function(){var a=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===a?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=a,this.y*=a,this.z*=a,this.w*=a)},a.Quaternion.prototype.vmult=function(b,c){c=c||new a.Vec3;var d=b.x,e=b.y,f=b.z,g=this.x,h=this.y,i=this.z,j=this.w,k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return c.x=k*j+n*-g+l*-i-m*-h,c.y=l*j+n*-h+m*-g-k*-i,c.z=m*j+n*-i+k*-h-l*-g,c},a.Quaternion.prototype.copy=function(a){a.x=this.x,a.y=this.y,a.z=this.z,a.w=this.w},a.Quaternion.prototype.toEuler=function(a,b){b=b||"YZX";var c,d,e,f=this.x,g=this.y,h=this.z,i=this.w;switch(b){case"YZX":var j=f*g+h*i;if(j>.499&&(c=2*Math.atan2(f,i),d=Math.PI/2,e=0),-.499>j&&(c=-2*Math.atan2(f,i),d=-Math.PI/2,e=0),isNaN(c)){var k=f*f,l=g*g,m=h*h;c=Math.atan2(2*g*i-2*f*h,1-2*l-2*m),d=Math.asin(2*j),e=Math.atan2(2*f*i-2*g*h,1-2*k-2*m)}break;default:throw new Error("Euler order "+b+" not supported yet.")}a.y=c,a.z=d,a.x=e},a.EventTarget=function(){var a={};this.addEventListener=function(b,c){void 0===a[b]&&(a[b]=[]),-1===a[b].indexOf(c)&&a[b].push(c)},this.dispatchEvent=function(b){for(var c in a[b.type])a[b.type][c](b)},this.removeEventListener=function(b,c){var d=a[b].indexOf(c);-1!==d&&a[b].splice(d,1)}},a.ObjectPool=function(){this.objects=[],this.type=Object},a.ObjectPool.prototype.release=function(){for(var a=arguments.length,b=0;b!==a;b++)this.objects.push(arguments[b])},a.ObjectPool.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},a.ObjectPool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this ObjectPool subclass yet!")},a.Vec3Pool=function(){a.ObjectPool.call(this),this.type=a.Vec3},a.Vec3Pool.prototype=new a.ObjectPool,a.Vec3Pool.prototype.constructObject=function(){return new a.Vec3},a.Shape=function(){this.type=0,this.aabbmin=new a.Vec3,this.aabbmax=new a.Vec3,this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0},a.Shape.prototype.constructor=a.Shape,a.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},a.Shape.prototype.getBoundingSphereRadius=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),this.boundingSphereRadius},a.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},a.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type};var g=new a.Vec3,h=new a.Vec3;a.Shape.prototype.calculateTransformedInertia=function(b,c,d){d=d||new a.Vec3;var e=g,f=h;return this.calculateLocalInertia(b,e),c.vmult(e,f),d.x=Math.abs(f.x),d.y=Math.abs(f.y),d.z=Math.abs(f.z),d},a.Shape.calculateLocalAABB=function(){throw new Error(".calculateLocalAABB is not implemented for this Shape yet!")},a.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},a.Body=function(b){a.EventTarget.apply(this),this.type=b,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a.Vec3,this.collisionFilterGroup=1,this.collisionFilterMask=1,this.collisionResponse=!0},a.Body.DYNAMIC=1,a.Body.STATIC=2,a.Body.KINEMATIC=4,a.Particle=function(b,c){if("number"!=typeof b)throw new Error("Argument 1 (mass) must be a number.");if("undefined"!=typeof c&&!(c instanceof a.Material))throw new Error("Argument 2 (material) must be an instance of CANNON.Material.");a.Body.call(this,"particle"),this.position=new a.Vec3,this.initPosition=new a.Vec3,this.velocity=new a.Vec3,this.initVelocity=new a.Vec3,this.force=new a.Vec3,this.mass=b,this.invMass=b>0?1/b:0,this.material=c,this.linearDamping=.01,this.motionstate=0>=b?a.Body.STATIC:a.Body.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0},a.Particle.prototype=new a.Body,a.Particle.prototype.constructor=a.Particle,a.Particle.prototype.isAwake=function(){return 0===this.sleepState},a.Particle.prototype.isSleepy=function(){return 1===this.sleepState},a.Particle.prototype.isSleeping=function(){return 2===this.sleepState},a.Particle.prototype.wakeUp=function(){var a=this.sleepState;this.sleepState=0,2===a&&this.dispatchEvent({type:"wakeup"})},a.Particle.prototype.sleep=function(){this.sleepState=2},a.Particle.prototype.sleepTick=function(a){if(this.allowSleep){var b=this.sleepState,c=this.velocity.norm2(),d=Math.pow(this.sleepSpeedLimit,2);0===b&&d>c?(this.sleepState=1,this.timeLastSleepy=a,this.dispatchEvent({type:"sleepy"})):1===b&&c>d?this.wakeUp():1===b&&a-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleepState=2,this.dispatchEvent({type:"sleep"}))}},a.RigidBody=function(b,c,d){if("number"!=typeof b)throw new Error("Argument 1 (mass) must be a number.");if("undefined"!=typeof d&&!(d instanceof a.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");a.Particle.call(this,b,d),this.tau=new a.Vec3,this.quaternion=new a.Quaternion,this.initQuaternion=new a.Quaternion,this.angularVelocity=new a.Vec3,this.initAngularVelocity=new a.Vec3,this.shape=c,this.inertia=new a.Vec3,c.calculateLocalInertia(b,this.inertia),this.inertiaWorld=new a.Vec3,this.inertia.copy(this.inertiaWorld),this.inertiaWorldAutoUpdate=!1,this.invInertia=new a.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.invInertiaWorld=new a.Vec3,this.invInertia.copy(this.invInertiaWorld),this.invInertiaWorldAutoUpdate=!1,this.angularDamping=.01,this.aabbmin=new a.Vec3,this.aabbmax=new a.Vec3,this.aabbNeedsUpdate=!0,this.wlambda=new a.Vec3},a.RigidBody.prototype=new a.Particle(0),a.RigidBody.prototype.constructor=a.RigidBody,a.RigidBody.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax),this.aabbNeedsUpdate=!1};var i=new a.Vec3,j=new a.Vec3;a.RigidBody.prototype.applyForce=function(a,b){var c=i;b.vsub(this.position,c);var d=j;c.cross(a,d),this.force.vadd(a,this.force),this.tau.vadd(d,this.tau)};var k=new a.Vec3,l=new a.Vec3,m=new a.Vec3;a.RigidBody.prototype.applyImpulse=function(a,b){var c=k;b.vsub(this.position,c);var d=l;a.copy(d),d.mult(this.invMass,d),this.velocity.vadd(d,this.velocity);var e=m;c.cross(a,e),e.x*=this.invInertia.x,e.y*=this.invInertia.y,e.z*=this.invInertia.z,this.angularVelocity.vadd(e,this.angularVelocity)},a.Sphere=function(b){a.Shape.call(this),this.radius=void 0!==b?Number(b):1,this.type=a.Shape.types.SPHERE},a.Sphere.prototype=new a.Shape,a.Sphere.prototype.constructor=a.Sphere,a.Sphere.prototype.calculateLocalInertia=function(b,c){c=c||new a.Vec3;var d=2*b*this.radius*this.radius/5;return c.x=d,c.y=d,c.z=d,c},a.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},a.Sphere.prototype.calculateWorldAABB=function(a,b,c,d){for(var e=this.radius,f=["x","y","z"],g=0;g<f.length;g++){var h=f[g];c[h]=a[h]-e,d[h]=a[h]+e}},a.SPHSystem=function(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]},a.SPHSystem.prototype.add=function(a){this.particles.push(a),this.neighbors.length<this.particles.length&&this.neighbors.push([])},a.SPHSystem.prototype.remove=function(a){var b=this.particles.indexOf(a);-1!==b&&(this.particles.splice(b,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var n=new a.Vec3;a.SPHSystem.prototype.getNeighbors=function(a,b){for(var c=this.particles.length,d=a.id,e=this.smoothingRadius*this.smoothingRadius,f=n,g=0;g!==c;g++){var h=this.particles[g];h.position.vsub(a.position,f),d!==h.id&&f.norm2()<e&&b.push(h)}};var o=new a.Vec3,p=new a.Vec3,q=new a.Vec3,r=new a.Vec3,s=new a.Vec3,t=new a.Vec3;a.SPHSystem.prototype.update=function(){for(var a=this.particles.length,b=o,c=this.speedOfSound,d=this.eps,e=0;e!==a;e++){var f=this.particles[e],g=this.neighbors[e];g.length=0,this.getNeighbors(f,g),g.push(this.particles[e]);for(var h=g.length,i=0,j=0;j!==h;j++){f.position.vsub(g[j].position,b);var k=b.norm(),l=this.w(k);i+=g[j].mass*l}this.densities[e]=i,this.pressures[e]=c*c*(this.densities[e]-this.density)}for(var m=p,n=q,u=r,v=s,w=t,e=0;e!==a;e++){var x=this.particles[e];m.set(0,0,0),n.set(0,0,0);for(var y,z,g=this.neighbors[e],h=g.length,j=0;j!==h;j++){var A=g[j];x.position.vsub(A.position,v);var B=v.norm();y=-A.mass*(this.pressures[e]/(this.densities[e]*this.densities[e]+d)+this.pressures[j]/(this.densities[j]*this.densities[j]+d)),this.gradw(v,u),u.mult(y,u),m.vadd(u,m),A.velocity.vsub(x.velocity,w),w.mult(1/(1e-4+this.densities[e]*this.densities[j])*this.viscosity*A.mass,w),z=this.nablaw(B),w.mult(z,w),n.vadd(w,n)}n.mult(x.mass,n),m.mult(x.mass,m),x.force.vadd(n,x.force),x.force.vadd(m,x.force)}},a.SPHSystem.prototype.w=function(a){var b=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(b,9))*Math.pow(b*b-a*a,3)},a.SPHSystem.prototype.gradw=function(a,b){var c=a.norm(),d=this.smoothingRadius;a.mult(945/(32*Math.PI*Math.pow(d,9))*Math.pow(d*d-c*c,2),b)},a.SPHSystem.prototype.nablaw=function(a){var b=this.smoothingRadius,c=945/(32*Math.PI*Math.pow(b,9))*(b*b-a*a)*(7*a*a-3*b*b);return c},a.Box=function(b){a.Shape.call(this),this.halfExtents=b,this.type=a.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},a.Box.prototype=new a.Shape,a.Box.prototype.constructor=a.Box,a.Box.prototype.updateConvexPolyhedronRepresentation=function(){var b=this.halfExtents.x,c=this.halfExtents.y,d=this.halfExtents.z,e=a.Vec3,f=new a.ConvexPolyhedron([new e(-b,-c,-d),new e(b,-c,-d),new e(b,c,-d),new e(-b,c,-d),new e(-b,-c,d),new e(b,-c,d),new e(b,c,d),new e(-b,c,d)],[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],[new e(0,0,-1),new e(0,0,1),new e(0,-1,0),new e(0,1,0),new e(-1,0,0),new e(1,0,0)]);this.convexPolyhedronRepresentation=f},a.Box.prototype.calculateLocalInertia=function(b,c){c=c||new a.Vec3;var d=this.halfExtents;return c.x=1/12*b*(2*2*d.y*d.y+2*2*d.z*d.z),c.y=1/12*b*(2*2*d.x*d.x+2*2*d.z*d.z),c.z=1/12*b*(2*2*d.y*d.y+2*2*d.x*d.x),c},a.Box.prototype.getSideNormals=function(a,b){var c=a,d=this.halfExtents;if(c[0].set(d.x,0,0),c[1].set(0,d.y,0),c[2].set(0,0,d.z),c[3].set(-d.x,0,0),c[4].set(0,-d.y,0),c[5].set(0,0,-d.z),void 0!==b)for(var e=0;e!==c.length;e++)b.vmult(c[e],c[e]);return c},a.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},a.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm(),this.boundingSphereRadiusNeedsUpdate=!1};var u=new a.Vec3;new a.Vec3,a.Box.prototype.forEachWorldCorner=function(a,b,c){for(var d=this.halfExtents,e=[[d.x,d.y,d.z],[-d.x,d.y,d.z],[-d.x,-d.y,d.z],[-d.x,-d.y,-d.z],[d.x,-d.y,-d.z],[d.x,d.y,-d.z],[-d.x,d.y,-d.z],[d.x,-d.y,d.z]],f=0;f<e.length;f++)u.set(e[f][0],e[f][1],e[f][2]),b.vmult(u,u),a.vadd(u,u),c(u.x,u.y,u.z)},a.Box.prototype.calculateWorldAABB=function(a,b,c,d){c.set(1/0,1/0,1/0),d.set(-1/0,-1/0,-1/0),this.forEachWorldCorner(a,b,function(a,b,e){a>d.x&&(d.x=a),b>d.y&&(d.y=b),e>d.z&&(d.z=e),a<c.x&&(c.x=a),b<c.y&&(c.y=b),e<c.z&&(c.z=e)})},a.Plane=function(){a.Shape.call(this),this.type=a.Shape.types.PLANE,this.worldNormal=new a.Vec3,this.worldNormalNeedsUpdate=!0},a.Plane.prototype=new a.Shape,a.Plane.prototype.constructor=a.Plane,a.Plane.prototype.computeWorldNormal=function(a){var b=this.worldNormal;b.set(0,0,1),a.vmult(b,b),this.worldNormalNeedsUpdate=!1},a.Plane.prototype.calculateLocalInertia=function(b,c){return c=c||new a.Vec3},a.Plane.prototype.volume=function(){return 1/0};var v=new a.Vec3;a.Plane.prototype.calculateWorldAABB=function(a,b,c,d){v.set(0,0,1),b.vmult(v,v),c.set(-1/0,-1/0,-1/0),d.set(1/0,1/0,1/0),1===v.x&&(d.x=a.x),1===v.y&&(d.y=a.y),1===v.z&&(d.z=a.z),-1===v.x&&(c.x=a.x),-1===v.y&&(c.y=a.y),-1===v.z&&(c.z=a.z)},a.Compound=function(){a.Shape.call(this),this.type=a.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},a.Compound.prototype=new a.Shape,a.Compound.prototype.constructor=a.Compound,a.Compound.prototype.addChild=function(b,c,d){c=c||new a.Vec3,d=d||new a.Quaternion,this.childShapes.push(b),this.childOffsets.push(c),this.childOrientations.push(d)},a.Compound.prototype.volume=function(){for(var a=0,b=this.childShapes.length,c=0;c!==b;c++)a+=this.childShapes[c].volume();return a};var w=new a.Vec3,x=new a.Vec3;a.Compound.prototype.calculateLocalInertia=function(b,c){c=c||new a.Vec3;for(var d=this.volume(),e=x,f=0,g=this.childShapes.length;f!==g;f++){var h=this.childShapes[f],i=this.childOffsets[f];this.childOrientations[f];var j=h.volume()/d*b;h.calculateLocalInertia(j,e),c.vadd(e,c);var k=w;k.set(j*i.x*i.x,j*i.y*i.y,j*i.z*i.z),c.vadd(k,c)}return c},a.Compound.prototype.computeBoundingSphereRadius=function(){for(var a=0,b=0;b<this.childShapes.length;b++){var c=this.childShapes[b];c.boundingSphereRadiusNeedsUpdate&&c.computeBoundingSphereRadius();var d=this.childOffsets[b].norm()+c.boundingSphereRadius;d>a&&(a=d)}this.boundingSphereRadius=a,this.boundingSphereRadiusNeedsUpdate=!1};var y=new a.Vec3,z=new a.Vec3,A=new a.Vec3,B=new a.Quaternion;a.Compound.prototype.calculateWorldAABB=function(a,b,c,d){var e=this.childShapes.length;c.set(1/0,1/0,1/0),d.set(-1/0,-1/0,-1/0);for(var f=0;f!==e;f++)this.childOffsets[f].copy(A),b.vmult(A,A),a.vadd(A,A),b.mult(this.childOrientations[f],B),this.childShapes[f].calculateWorldAABB(A,B,z,y),z.x<c.x&&(c.x=z.x),z.y<c.y&&(c.y=z.y),z.z<c.z&&(c.z=z.z),y.x>d.x&&(d.x=y.x),y.y>d.y&&(d.y=y.y),y.z>d.z&&(d.z=y.z)},a.ConvexPolyhedron=function(b,c){function d(a,b,c,d){b.vsub(a,j),c.vsub(b,i),i.cross(j,d),d.isZero()||d.normalize()}function e(a,b,c,d,e){for(var f=a.vertices.length,g=null,h=null,i=a.vertices,j=0;f>j;j++){i[j].copy(w),d.vmult(w,w),w.vadd(c,w);var k=w.dot(b);(null===g||k>g)&&(g=k),(null===h||h>k)&&(h=k)}if(h>g){var l=h;h=g,g=l}e[0]=g,e[1]=h}function f(a,b){var c=h.faces[a],e=h.vertices[c[0]],f=h.vertices[c[1]],g=h.vertices[c[2]];return d(e,f,g,b)}function g(a){var b=h.faces[a],c=h.faceNormals[a],d=h.vertices[b[0]],e=-c.dot(d);return e}var h=this;a.Shape.call(this),this.type=a.Shape.types.CONVEXPOLYHEDRON;var i=new a.Vec3,j=new a.Vec3;this.vertices=b||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=c||[],this.faceNormals=[];for(var k=0;k<this.faces.length;k++){for(var l=0;l<this.faces[k].length;l++)if(!this.vertices[this.faces[k][l]])throw new Error("Vertex "+this.faces[k][l]+" not found!");var m=new a.Vec3;f(k,m),m.negate(m),this.faceNormals.push(m);var n=this.vertices[this.faces[k][0]];if(m.dot(n)<0){console.warn("Face normal "+k+" ("+m.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var l=0;l<this.faces[k].length;l++)console.warn("Vertex "+this.faces[k][l]+": ("+this.vertices[c[k][l]].toString()+")")}}this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[];for(var o=this.vertices.length,p=0;o>p;p++){var q=this.vertices[p];if(!(q instanceof a.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.uniqueEdges.push(q)}for(var k=0;k<this.faces.length;k++)for(var r=this.faces[k].length,s=r,l=0;s>l;l++){var t=(l+1)%r,u=new a.Vec3;this.vertices[this.faces[k][l]].vsub(this.vertices[this.faces[k][t]],u),u.normalize();for(var v=!1,q=0;q<this.uniqueEdges.length;q++)if(this.uniqueEdges[q].almostEquals(u)||this.uniqueEdges[q].almostEquals(u)){v=!0;break}v||this.uniqueEdges.push(u),u&&(u.face1=k)}var w=new a.Vec3;this.testSepAxis=function(a,b,c,d,f,g){var h=[],i=[],j=this;e(j,a,c,d,h),e(b,a,f,g,i);var k=h[0],l=h[1],m=i[0],n=i[1];if(n>k||l>m)return!1;var o=k-n,p=m-l,q=p>o?o:p;return q};var x=new a.Vec3,y=new a.Vec3,z=new a.Vec3,A=new a.Vec3,B=new a.Vec3,C=new a.Vec3;this.findSeparatingAxis=function(a,b,c,d,e,f){for(var g=1/0,h=this,i=0,j=h.faces.length,k=0;j>k;k++){h.faceNormals[k].copy(x),c.vmult(x,x);var l=h.testSepAxis(x,a,b,c,d,e);if(l===!1)return!1;g>l&&(g=l,x.copy(f))}for(var m=a.faces.length,k=0;m>k;k++){a.faceNormals[k].copy(y),e.vmult(y,y),i++;var l=h.testSepAxis(y,a,b,c,d,e);if(l===!1)return!1;g>l&&(g=l,y.copy(f))}for(var n=0,o=0;o<h.uniqueEdges.length;o++){h.uniqueEdges[o].copy(A),c.vmult(A,A);for(var p=0;p<a.uniqueEdges.length;p++)if(a.uniqueEdges[p].copy(B),e.vmult(B,B),A.cross(B,C),n++,!C.almostZero()){C.normalize();var q=h.testSepAxis(C,a,b,c,d,e);if(q===!1)return!1;g>q&&(g=q,C.copy(f))}}return d.vsub(b,z),z.dot(f)>0&&f.negate(f),!0};var D=new a.Vec3;this.clipAgainstHull=function(b,c,d,e,f,g,h,i,j){if(!(b instanceof a.Vec3))throw new Error("posA must be Vec3");if(!(c instanceof a.Quaternion))throw new Error("quatA must be Quaternion");for(var k=-1,l=-1/0,m=0;m<d.faces.length;m++){d.faceNormals[m].copy(D),f.vmult(D,D);var n=D.dot(g);n>l&&(l=n,k=m)}for(var o=[],p=d.faces[k],q=p.length,r=0;q>r;r++){var s=d.vertices[p[r]],t=new a.Vec3;s.copy(t),f.vmult(t,t),e.vadd(t,t),o.push(t)}k>=0&&this.clipFaceAgainstHull(g,b,c,o,h,i,j)};var E=new a.Vec3,F=new a.Vec3,G=new a.Vec3,H=new a.Vec3,I=new a.Vec3,J=new a.Vec3,K=new a.Vec3,L=new a.Vec3;this.clipFaceAgainstHull=function(b,c,d,e,f,h,i){if(!(b instanceof a.Vec3))throw new Error("sep normal must be vector");if(!(e instanceof Array))throw new Error("world verts must be array");f=Number(f),h=Number(h);for(var j=this,k=[],l=e,m=k,n=-1,o=1/0,p=0;p<j.faces.length;p++){j.faceNormals[p].copy(E),d.vmult(E,E);var q=E.dot(b);o>q&&(o=q,n=p)}if(0>n)return console.log("--- did not find any closest face... ---"),void 0;var r=j.faces[n];r.connectedFaces=[];for(var s=0;s<j.faces.length;s++)for(var t=0;t<j.faces[s].length;t++)-1!==r.indexOf(j.faces[s][t])&&s!==n&&-1===r.connectedFaces.indexOf(s)&&r.connectedFaces.push(s);l.length;for(var u=r.length,v=0;u>v;v++){var w=j.vertices[r[v]],x=j.vertices[r[(v+1)%u]];w.vsub(x,F),F.copy(G),d.vmult(G,G),c.vadd(G,G),this.faceNormals[n].copy(H),d.vmult(H,H),c.vadd(H,H),G.cross(H,I),I.negate(I),w.copy(J),d.vmult(J,J),c.vadd(J,J);var y,z=(-J.dot(I),r.connectedFaces[v]);this.faceNormals[z].copy(K);var A=g(z);K.copy(L),d.vmult(L,L);var y=A-L.dot(c);for(this.clipFaceAgainstPlane(l,m,L,y);l.length;)l.shift();for(;m.length;)l.push(m.shift())}this.faceNormals[n].copy(K);var A=g(n);K.copy(L),d.vmult(L,L);for(var y=A-L.dot(c),s=0;s<l.length;s++){var B=L.dot(l[s])+y;if(f>=B&&(console.log("clamped: depth="+B+" to minDist="+(f+"")),B=f),h>=B){var C=l[s];if(0>=B){var D={point:C,normal:L,depth:B};i.push(D)}}}},this.clipFaceAgainstPlane=function(b,c,d,e){if(!(d instanceof a.Vec3))throw new Error("planeNormal must be Vec3, "+d+" given");if(!(b instanceof Array))throw new Error("invertices must be Array, "+b+" given");if(!(c instanceof Array))throw new Error("outvertices must be Array, "+c+" given");var f,g,h=b.length;if(2>h)return c;var i=b[b.length-1],j=b[0];f=d.dot(i)+e;for(var k=0;h>k;k++){if(j=b[k],g=d.dot(j)+e,0>f)if(0>g){var l=new a.Vec3;j.copy(l),c.push(l)}else{var l=new a.Vec3;i.lerp(j,f/(f-g),l),c.push(l)}else if(0>g){var l=new a.Vec3;i.lerp(j,f/(f-g),l),c.push(l),c.push(j)}i=j,f=g}return c};var h=this;this.calculateLocalInertia=function(a,b){h.computeAABB();var c=this.aabbmax.x-this.aabbmin.x,d=this.aabbmax.y-this.aabbmin.y,e=this.aabbmax.z-this.aabbmin.z;b.x=1/12*a*(2*2*d*d+2*2*e*e),b.y=1/12*a*(2*2*c*c+2*2*e*e),b.z=1/12*a*(2*2*d*d+2*2*c*c)},new a.Vec3,this.computeAABB=function(){var a=this.vertices.length,b=this.aabbmin,c=this.aabbmax,d=this.vertices;b.set(1/0,1/0,1/0),c.set(-1/0,-1/0,-1/0);for(var e=0;a>e;e++){var f=d[e];f.x<b.x?b.x=f.x:f.x>c.x&&(c.x=f.x),f.y<b.y?b.y=f.y:f.y>c.y&&(c.y=f.y),f.z<b.z?b.z=f.z:f.z>c.z&&(c.z=f.z)}}},a.ConvexPolyhedron.prototype=new a.Shape,a.ConvexPolyhedron.prototype.constructor=a.ConvexPolyhedron,a.ConvexPolyhedron.prototype.computeWorldVertices=function(b,c){for(var d=this.vertices.length;this.worldVertices.length<d;)this.worldVertices.push(new a.Vec3);for(var e=this.vertices,f=this.worldVertices,g=0;g!==d;g++)c.vmult(e[g],f[g]),b.vadd(f[g],f[g]);this.worldVerticesNeedsUpdate=!1},a.ConvexPolyhedron.prototype.computeWorldFaceNormals=function(b){for(var c=this.faceNormals.length;this.worldFaceNormals.length<c;)this.worldFaceNormals.push(new a.Vec3);for(var d=this.faceNormals,e=this.worldFaceNormals,f=0;f!==c;f++)b.vmult(d[f],e[f]);this.worldFaceNormalsNeedsUpdate=!1},a.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){for(var a=0,b=this.vertices,c=0,d=b.length;c!==d;c++){var e=b[c].norm2();e>a&&(a=e)}this.boundingSphereRadius=Math.sqrt(a),this.boundingSphereRadiusNeedsUpdate=!1};var C=new a.Vec3;a.ConvexPolyhedron.prototype.calculateWorldAABB=function(a,b,c,d){for(var e,f,g,h,i,j,k=this.vertices.length,l=this.vertices,m=0;k>m;m++){l[m].copy(C),b.vmult(C,C),a.vadd(C,C);var n=C;n.x<e||void 0===e?e=n.x:(n.x>h||void 0===h)&&(h=n.x),n.y<f||void 0===f?f=n.y:(n.y>i||void 0===i)&&(i=n.y),n.z<g||void 0===g?g=n.z:(n.z>j||void 0===j)&&(j=n.z)}c.set(e,f,g),d.set(h,i,j)},a.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},a.ConvexPolyhedron.prototype.getAveragePointLocal=function(b){b=b||new a.Vec3;for(var c=this.vertices.length,d=this.vertices,e=0;c>e;e++)b.vadd(d[e],b);return b.mult(1/c,b),b},a.ConvexPolyhedron.prototype.transformAllPoints=function(a,b){var c=this.vertices.length,d=this.vertices;if(b){for(var e=0;c>e;e++){var f=d[e];b.vmult(f,f)}for(var e=0;e<this.faceNormals.length;e++){var f=this.faceNormals[e];b.vmult(f,f)}}if(a)for(var e=0;c>e;e++){var f=d[e];f.vadd(a,f)}};var D=new a.Vec3,E=new a.Vec3,F=new a.Vec3;a.ConvexPolyhedron.prototype.pointIsInside=function(a){var b=this.vertices.length,c=this.vertices,d=this.faces,e=this.faceNormals,f=null,g=this.faces.length,h=D;this.getAveragePointLocal(h);for(var i=0;g>i;i++){this.faces[i].length;var b=e[i],j=c[d[i][0]],k=E;a.vsub(j,k);var l=b.dot(k),m=F;h.vsub(j,m);var n=b.dot(m);if(0>l&&n>0||l>0&&0>n)return!1}return f?1:-1},a.Cylinder=function(b,c,d,e){var f=e,g=[],h=[],i=[],j=[],k=[],l=Math.cos,m=Math.sin;g.push(new a.Vec3(c*l(0),c*m(0),.5*-d)),j.push(0),g.push(new a.Vec3(b*l(0),b*m(0),.5*d)),k.push(1);for(var n=0;f>n;n++){var o=2*Math.PI/f*(n+1),p=2*Math.PI/f*(n+.5);f-1>n?(g.push(new a.Vec3(c*l(o),c*m(o),.5*-d)),j.push(2*n+2),g.push(new a.Vec3(b*l(o),b*m(o),.5*d)),k.push(2*n+3),h.push(new a.Vec3(l(p),m(p),0)),i.push([2*n+2,2*n+3,2*n+1,2*n])):(i.push([0,1,2*n+1,2*n]),h.push(new a.Vec3(l(p),m(p),0)))}i.push(k),h.push(new a.Vec3(0,0,1));for(var q=[],n=0;n<j.length;n++)q.push(j[j.length-n-1]);i.push(q),h.push(new a.Vec3(0,0,-1)),this.type=a.Shape.types.CONVEXPOLYHEDRON,a.ConvexPolyhedron.call(this,g,i,h)},a.Cylinder.prototype=new a.ConvexPolyhedron,a.Ray=function(b,c){function d(a,b,c){return c.vsub(a,o),m=o.dot(b),b.mult(m,p),p.vadd(a,p),n=c.distanceTo(p)}function e(a,b,c,d){d.vsub(b,o),c.vsub(b,q),a.vsub(b,r);var e,f,g=o.dot(o),h=o.dot(q),i=o.dot(r),j=q.dot(q),k=q.dot(r);return(e=j*i-h*k)>=0&&(f=g*k-h*i)>=0&&g*j-h*h>e+f}this.origin=b||new a.Vec3,this.direction=c||new a.Vec3;var f=1e-4;this.setPrecision=function(a){f=a};var g=new a.Vec3,h=new a.Vec3,i=new a.Vec3;new a.Vec3,new a.Vec3;var j=new a.Vec3,k=new a.Vec3,l=new a.Vec3;this.intersectBody=function(b){return b.shape instanceof a.ConvexPolyhedron?this.intersectShape(b.shape,b.quaternion,b.position,b):b.shape instanceof a.Box?this.intersectShape(b.shape.convexPolyhedronRepresentation,b.quaternion,b.position,b):(console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes."),void 0)},this.intersectShape=function(b,c,m,n){var o,p=[];if(b instanceof a.ConvexPolyhedron){var q=d(this.origin,this.direction,m);if(q>b.getBoundingSphereRadius())return p;for(var r,s,t=b.faces,u=b.vertices,v=b.faceNormals,w=0;w<t.length;w++){var x=t[w],y=v[w],z=c,A=m;if(u[x[0]].copy(j),z.vmult(j,j),j.vadd(A,j),j.vsub(this.origin,j),z.vmult(y,k),r=this.direction.dot(k),!(Math.abs(r)<f)&&(s=k.dot(j)/r,!(0>s)&&0>r)){this.direction.mult(s,l),l.vadd(this.origin,l),u[x[0]].copy(g),z.vmult(g,g),A.vadd(g,g);for(var B=1;B<x.length-1;B++)if(u[x[B]].copy(h),u[x[B+1]].copy(i),z.vmult(h,h),z.vmult(i,i),A.vadd(h,h),A.vadd(i,i),e(l,g,h,i)){o={distance:this.origin.distanceTo(l),point:l.copy(),face:x,body:n},p.push(o);break}}}}return p},this.intersectBodies=function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=this.intersectBody(a[c]);Array.prototype.push.apply(b,e)}return b.sort(function(a,b){return a.distance-b.distance}),b};var m,n,o=new a.Vec3,p=new a.Vec3,q=new a.Vec3,r=new a.Vec3},a.Ray.prototype.constructor=a.Ray,a.Broadphase=function(){this.world=null,this.useBoundingBoxes=!1},a.Broadphase.prototype.constructor=a.BroadPhase,a.Broadphase.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")
};var G=a.Body.STATIC|a.Body.KINEMATIC;a.Broadphase.prototype.needBroadphaseCollision=function(b,c){return 0===(b.collisionFilterGroup&c.collisionFilterMask)||0===(c.collisionFilterGroup&b.collisionFilterMask)?!1:0===(b.motionstate&G)&&!b.isSleeping()||0===(c.motionstate&G)&&!c.isSleeping()?b.shape||c.shape?b.shape instanceof a.Plane&&c.shape instanceof a.Plane?!1:!0:!1:!1},a.Broadphase.prototype.intersectionTest=function(a,b,c,d){this.useBoundingBoxes?this.doBoundingBoxBroadphase(a,b,c,d):this.doBoundingSphereBroadphase(a,b,c,d)};var H=new a.Vec3,I=new a.Vec3,J=(new a.Quaternion,new a.Vec3);a.Broadphase.prototype.doBoundingSphereBroadphase=function(b,c,d,e){var f=a.Shape.types,g=f.SPHERE|f.BOX|f.COMPOUND|f.CONVEXPOLYHEDRON,h=f.PLANE;a.Body.STATIC|a.Body.KINEMATIC;var i=H,j=I,k=J,l=b.shape,m=c.shape;if(l&&m){var n=l.type,o=m.type;if(n&g&&o&g){c.position.vsub(b.position,i),l.boundingSphereRadiusNeedsUpdate&&l.computeBoundingSphereRadius(),m.boundingSphereRadiusNeedsUpdate&&m.computeBoundingSphereRadius();var p=l.boundingSphereRadius+m.boundingSphereRadius;i.norm2()<p*p&&(d.push(b),e.push(c))}else if(n&g&&o&f.PLANE||o&g&&n&f.PLANE){var q=n===h?b:c,r=n!==h?b:c,s=r.shape,t=q.shape;r.position.vsub(q.position,i),t.worldNormalNeedsUpdate&&t.computeWorldNormal(q.quaternion),j=t.worldNormal,s.boundingSphereRadiusNeedsUpdate&&s.computeBoundingSphereRadius();var u=i.dot(j)-s.boundingSphereRadius;0>u&&(d.push(b),e.push(c))}}else if(l||m){var v=l?c:b,w=l?b:c,s=w.shape,x=s.type;if(x&g){if(x===f.SPHERE)v.position.vsub(w.position,k),s.radius*s.radius>=k.norm2()&&(d.push(v),e.push(w));else if(x===f.CONVEXPOLYHEDRON||x===f.BOX||x===f.COMPOUND){s.boundingSphereRadiusNeedsUpdate&&s.computeBoundingSphereRadius();var y=s.boundingSphereRadius;v.position.vsub(w.position,k),y*y>=k.norm2()&&(d.push(v),e.push(w))}}else if(x===f.PLANE){var z=w;j.set(0,0,1),z.quaternion.vmult(j,j),v.position.vsub(z.position,k),j.dot(k)<=0&&(d.push(v),e.push(w))}}else;},a.Broadphase.prototype.doBoundingBoxBroadphase=function(b,c,d,e){var f=b.shape,g=c.shape;if(b.aabbNeedsUpdate&&b.computeAABB(),c.aabbNeedsUpdate&&c.computeAABB(),f&&g)b.aabbmax.x<c.aabbmin.x||b.aabbmax.y<c.aabbmin.y||b.aabbmax.z<c.aabbmin.z||b.aabbmin.x>c.aabbmax.x||b.aabbmin.y>c.aabbmax.y||b.aabbmin.z>c.aabbmax.z||(d.push(b),e.push(c));else if(f||g){var h=f?c:b,i=f?b:c;i.shape instanceof a.Plane,h.position.x<i.aabbmin.x||h.position.y<i.aabbmin.y||h.position.z<i.aabbmin.z||h.position.x>i.aabbmax.x||h.position.y>i.aabbmax.y||h.position.z>i.aabbmax.z||(d.push(b),e.push(c))}else;};var K={},L=[],M=[];a.Broadphase.prototype.makePairsUnique=function(a,b){for(var c=K,d=L,e=M,f=a.length,g=0;g!==f;g++)d[g]=a[g],e[g]=b[g];a.length=0,b.length=0;for(var g=0;g!==f;g++){var h=d[g].id,i=e[g].id,j=i>h?h+","+i:i+","+h;c[j]=g}for(var j in c){var g=c[j];a.push(d[g]),b.push(e[g]),delete c[j]}},a.NaiveBroadphase=function(){a.Broadphase.apply(this)},a.NaiveBroadphase.prototype=new a.Broadphase,a.NaiveBroadphase.prototype.constructor=a.NaiveBroadphase,a.NaiveBroadphase.prototype.collisionPairs=function(a,b,c){var d,e,f,g,h=a.bodies,i=h.length;for(d=0;d!==i;d++)for(e=0;e!==d;e++)f=h[d],g=h[e],this.needBroadphaseCollision(f,g)&&this.intersectionTest(f,g,b,c)},a.GridBroadphase=function(b,c,d,e,f){a.Broadphase.apply(this),this.nx=d||10,this.ny=e||10,this.nz=f||10,this.aabbMin=b||new a.Vec3(100,100,100),this.aabbMax=c||new a.Vec3(-100,-100,-100);var g=this.nx*this.ny*this.nz;if(0>=g)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=g,this.binLengths.length=g;for(var h=0;g>h;h++)this.bins[h]=[],this.binLengths[h]=0},a.GridBroadphase.prototype=new a.Broadphase,a.GridBroadphase.prototype.constructor=a.GridBroadphase;var N=new a.Vec3;new a.Vec3,a.GridBroadphase.prototype.collisionPairs=function(b,c,d){function e(a,b,c,d,e,f,g){var h=0|(a-s)*v,i=0|(b-t)*w,p=0|(c-u)*x,q=J((d-s)*v),r=J((e-t)*w),y=J((f-u)*x);0>h?h=0:h>=j&&(h=j-1),0>i?i=0:i>=k&&(i=k-1),0>p?p=0:p>=l&&(p=l-1),0>q?q=0:q>=j&&(q=j-1),0>r?r=0:r>=k&&(r=k-1),0>y?y=0:y>=l&&(y=l-1),h*=m,i*=n,p*=o,q*=m,r*=n,y*=o;for(var z=h;q>=z;z+=m)for(var A=i;r>=A;A+=n)for(var B=p;y>=B;B+=o){var C=z+A+B;F[C][G[C]++]=g}}var f=b.numObjects(),g=b.bodies,h=this.aabbMax,i=this.aabbMin,j=this.nx,k=this.ny,l=this.nz,m=k*l,n=l,o=1,p=h.x,q=h.y,r=h.z,s=i.x,t=i.y,u=i.z,v=j/(p-s),w=k/(q-t),x=l/(r-u),y=(p-s)/j,z=(q-t)/k,A=(r-u)/l,B=.5*Math.sqrt(y*y+z*z+A*A),C=a.Shape.types,D=C.SPHERE,E=C.PLANE;C.BOX,C.COMPOUND,C.CONVEXPOLYHEDRON;for(var F=this.bins,G=this.binLengths,H=this.bins.length,I=0;I!==H;I++)G[I]=0;for(var J=Math.ceil,i=Math.min,h=Math.max,I=0;I!==f;I++){var K=g[I],L=K.shape;switch(L.type){case D:var M=K.position.x,O=K.position.y,P=K.position.z,Q=L.radius;e(M-Q,O-Q,P-Q,M+Q,O+Q,P+Q,K);break;case E:L.worldNormalNeedsUpdate&&L.computeWorldNormal(K.quaternion);var R=L.worldNormal,S=s+.5*y-K.position.x,T=t+.5*z-K.position.y,U=u+.5*A-K.position.z,V=N;V.set(S,T,U);for(var W=0,X=0;W!==j;W++,X+=m,V.y=T,V.x+=y)for(var Y=0,Z=0;Y!==k;Y++,Z+=n,V.z=U,V.y+=z)for(var $=0,_=0;$!==l;$++,_+=o,V.z+=A)if(V.dot(R)<B){var ab=X+Z+_;F[ab][G[ab]++]=K}break;default:K.aabbNeedsUpdate&&K.computeAABB(),e(K.aabbmin.x,K.aabbmin.y,K.aabbmin.z,K.aabbmax.x,K.aabbmax.y,K.aabbmax.z,K)}}for(var I=0;I!==H;I++){var bb=G[I];if(bb>1)for(var cb=F[I],W=0;W!==bb;W++)for(var K=cb[W],Y=0;Y!==W;Y++){var db=cb[Y];this.needBroadphaseCollision(K,db)&&this.intersectionTest(K,db,c,d)}}this.makePairsUnique(c,d)},a.ArrayCollisionMatrix=function(){this.matrix=[]},a.ArrayCollisionMatrix.prototype.get=function(a,b){if(a=a.index,b=b.index,b>a){var c=b;b=a,a=c}return this.matrix[(a*(a+1)>>1)+b-1]},a.ArrayCollisionMatrix.prototype.set=function(a,b,c){if(a=a.index,b=b.index,b>a){var d=b;b=a,a=d}this.matrix[(a*(a+1)>>1)+b-1]=c?1:0},a.ArrayCollisionMatrix.prototype.reset=function(){for(var a=0,b=this.matrix.length;a!==b;a++)this.matrix[a]=0},a.ArrayCollisionMatrix.prototype.setNumObjects=function(a){this.matrix.length=a*(a-1)>>1},a.ObjectCollisionMatrix=function(){this.matrix={}},a.ObjectCollisionMatrix.prototype.get=function(a,b){if(a=a.id,b=b.id,b>a){var c=b;b=a,a=c}return a+"-"+b in this.matrix},a.ObjectCollisionMatrix.prototype.set=function(a,b,c){if(a=a.id,b=b.id,b>a){var d=b;b=a,a=d}c?this.matrix[a+"-"+b]=!0:delete this.matrix[a+"-"+b]},a.ObjectCollisionMatrix.prototype.reset=function(){this.matrix={}},a.ObjectCollisionMatrix.prototype.setNumObjects=function(){},a.Solver=function(){this.equations=[]},a.Solver.prototype.solve=function(){return 0},a.Solver.prototype.addEquation=function(a){this.equations.push(a)},a.Solver.prototype.removeEquation=function(a){var b=this.equations,c=b.indexOf(a);-1!==c&&b.splice(c,1)},a.Solver.prototype.removeAllEquations=function(){this.equations.length=0},a.GSSolver=function(){a.Solver.call(this),this.iterations=10,this.tolerance=0},a.GSSolver.prototype=new a.Solver;var O=[],P=[],Q=[];a.GSSolver.prototype.solve=function(a,b){var c,d,e,f,g,h,i=(this.d,this.k,0),j=this.iterations,k=this.tolerance*this.tolerance,l=(this.a,this.b),m=this.equations,n=m.length,o=b.bodies,p=o.length,q=a,r=P,s=Q,t=O;r.length=0,s.length=0,t.length=0;for(var u=0;u!==n;u++){var v=m[u];v.spookParamsNeedsUpdate&&(v.updateSpookParams(q),v.spookParamsNeedsUpdate=!1),t[u]=0,s[u]=v.computeB(q),r[u]=1/v.computeC()}if(0!==n){for(var u=0;u!==p;u++){var l=o[u],w=l.vlambda,x=l.wlambda;w.set(0,0,0),x&&x.set(0,0,0)}for(i=0;i!==j;i++){f=0;for(var y=0;y!==n;y++){var v=m[y];c=s[y],d=r[y],h=t[y],g=v.computeGWlambda(),e=d*(c-g-v.eps*h),h+e<v.minForce?e=v.minForce-h:h+e>v.maxForce&&(e=v.maxForce-h),t[y]+=e,f+=e>0?e:-e,v.addToWlambda(e)}if(k>f*f)break}for(var u=0;u!==p;u++){var l=o[u],z=l.velocity,A=l.angularVelocity;z.vadd(l.vlambda,z),A&&A.vadd(l.wlambda,A)}}return i},a.SplitSolver=function(b){a.Solver.call(this),this.subsolver=b},a.SplitSolver.prototype=new a.Solver;var R=[],S=[],T=[],U={bodies:null};a.SplitSolver.prototype.solve=function(b,c){function d(a){for(var b=a.length,c=0;c!==b;c++){var d=a[c];if(!(d.visited||d.body.motionstate&u))return d}return!1}function e(a,b){var c=[];for(c.push(a),a.visited=!0,b(a);c.length;)for(var e,f=c.pop();e=d(f.children);)e.visited=!0,b(e),c.push(e)}function f(a){x.push(a.body);for(var b=a.eqs.length,c=0;c!==b;c++){var d=a.eqs[c];-1===w.indexOf(d)&&w.push(d)}}for(var g=R,h=c.bodies,i=this.equations,j=i.length,k=h.length,l=this.subsolver,m=g.length;m!==k;m++)g.push({body:h[m],children:[],eqs:[],visited:!1});for(var m=0;m!==k;m++){var n=g[m];n.body=h[m],n.children.length=0,n.eqs.length=0,n.visited=!1}for(var o=0;o!==j;o++){var p=i[o],m=h.indexOf(p.bi),q=h.indexOf(p.bj),r=g[m],s=g[q];r.children.push(s),r.eqs.push(p),s.children.push(r),s.eqs.push(p)}for(var t,u=a.Body.STATIC,v=0,w=S,x=T,y=U;t=d(g);){w.length=0,x.length=0,e(t,f);for(var z=w.length,m=0;m!==z;m++)l.addEquation(w[m]);y.bodies=x,l.solve(b,y),l.removeAllEquations(),v++}return v},a.Material=function(a){this.name=a,this.id=-1},a.ContactMaterial=function(a,b,c,d){this.id=-1,this.materials=[a,b],this.friction=void 0!==c?Number(c):.3,this.restitution=void 0!==d?Number(d):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3},a.World=function(){a.EventTarget.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new a.Vec3,this.broadphase=null,this.bodies=[],this.solver=new a.GSSolver,this.constraints=[],this.contactgen=new a.ContactGenerator,this.collisionMatrix=new a.ArrayCollisionMatrix,this.collisionMatrixPrevious=new a.ArrayCollisionMatrix,this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new a.Material("default"),this.defaultContactMaterial=new a.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0},this.subsystems=[]},a.World.prototype.getContactMaterial=function(b,c){if(b instanceof a.Material&&c instanceof a.Material){var d=b.id,e=c.id;if(e>d){var f=d;d=e,e=f}return this.contactmaterials[this.mats2cmat[d+e*this.materials.length]]}},a.World.prototype.numObjects=function(){return this.bodies.length},a.World.prototype.collisionMatrixTick=function(){var a=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=a,this.collisionMatrix.reset()},a.World.prototype.add=function(b){b.id=this.id(),b.index=this.bodies.length,this.bodies.push(b),b.world=this,b.position.copy(b.initPosition),b.velocity.copy(b.initVelocity),b.timeLastSleepy=this.time,b instanceof a.RigidBody&&(b.angularVelocity.copy(b.initAngularVelocity),b.quaternion.copy(b.initQuaternion)),this.collisionMatrix.setNumObjects(this.bodies.length)},a.World.prototype.addConstraint=function(a){this.constraints.push(a),a.id=this.id()},a.World.prototype.removeConstraint=function(a){var b=this.constraints.indexOf(a);-1!==b&&this.constraints.splice(b,1)},a.World.prototype.id=function(){return this.nextId++},a.World.prototype.remove=function(a){a.world=null;var b=this.numObjects()-1,c=this.bodies;c.splice(a.index,1);for(var d=a.index;b>d;d++)c[d].index=d;this.collisionMatrix.setNumObjects(b)},a.World.prototype.addMaterial=function(a){if(-1===a.id){var b=this.materials.length;this.materials.push(a),a.id=this.materials.length-1;for(var c=0;c!==2*b+1;c++)this.mats2cmat.push(-1)}},a.World.prototype.addContactMaterial=function(a){this.addMaterial(a.materials[0]),this.addMaterial(a.materials[1]);var b,c;a.materials[0].id>a.materials[1].id?(b=a.materials[0].id,c=a.materials[1].id):(c=a.materials[0].id,b=a.materials[1].id),this.contactmaterials.push(a),a.id=this.contactmaterials.length-1,this.mats2cmat[b+this.materials.length*c]=a.id},a.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()};var V={type:"postStep"},W={type:"preStep"},X={type:"collide","with":null,contact:null},Y=[],Z=[],$=[],_=[],ab=new a.Vec3,bb=(new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Quaternion,new a.Quaternion),cb=new a.Quaternion;a.World.prototype.step=function(b){var c,d=this.contacts,e=$,f=_,g=this.numObjects(),h=this.bodies,i=this.solver,j=this.gravity,k=this.doProfiling,l=this.profile,m=a.Body.DYNAMIC,n=this._now,o=this.constraints,p=a.FrictionEquation,q=Z,r=j.norm(),s=j.x,t=j.y,u=j.z,v=0;for(k&&(c=n()),void 0===b&&(b=this.last_dt||this.default_dt),v=0;v!==g;v++){var w=h[v];if(w.motionstate&m){var x=w.force,y=w.mass;x.x+=y*s,x.y+=y*t,x.z+=y*u}}for(var v=0,z=this.subsystems.length;v!==z;v++)this.subsystems[v].update();k&&(c=n()),e.length=0,f.length=0,this.broadphase.collisionPairs(this,e,f),k&&(l.broadphase=n()-c),this.collisionMatrixTick(),k&&(c=n());var A=Y,B=d.length;for(v=0;v!==B;v++)A.push(d[v]);d.length=0,this.contactgen.getContacts(e,f,this,d,A),k&&(l.nearphase=n()-c),k&&(c=n());var C=d.length,D=this.frictionEquations.length;for(v=0;v!==D;v++)q.push(this.frictionEquations[v]);this.frictionEquations.length=0;for(var E=0;E!==C;E++){var F=d[E],w=F.bi,G=F.bj,v=h.indexOf(w),H=h.indexOf(G),I=this.getContactMaterial(w.material,G.material)||this.defaultContactMaterial,J=I.friction,K=ab;K.set(G.position.x+F.rj.x-w.position.x-F.ri.x,G.position.y+F.rj.y-w.position.y-F.ri.y,G.position.z+F.rj.z-w.position.z-F.ri.z);var L=K.dot(F.ni);if(0>L){if(w.collisionResponse&&G.collisionResponse&&(F.restitution=I.restitution,F.penetration=L,F.stiffness=I.contactEquationStiffness,F.regularizationTime=I.contactEquationRegularizationTime,i.addEquation(F),J>0)){var M=J*r,N=w.invMass+G.invMass;N>0&&(N=1/N);var O=q,P=O.length?O.pop():new p(w,G,M*N),Q=O.length?O.pop():new p(w,G,M*N);this.frictionEquations.push(P),this.frictionEquations.push(Q),P.bi=Q.bi=w,P.bj=Q.bj=G,P.minForce=Q.minForce=-M*N,P.maxForce=Q.maxForce=M*N,F.ri.copy(P.ri),F.rj.copy(P.rj),F.ri.copy(Q.ri),F.rj.copy(Q.rj),F.ni.tangents(P.t,Q.t),i.addEquation(P),i.addEquation(Q)}this.collisionMatrix.set(w,G,!0),this.collisionMatrix.get(w,G)!==this.collisionMatrixPrevious.get(w,G)&&(X.with=G,X.contact=F,w.dispatchEvent(X),X.with=w,G.dispatchEvent(X),w.wakeUp(),G.wakeUp())}}k&&(l.makeContactConstraints=n()-c),k&&(c=n());var R=o.length;for(v=0;v!==R;v++){var F=o[v];F.update();for(var H=0,S=F.equations.length;H!==S;H++){var T=F.equations[H];i.addEquation(T)}}i.solve(b,this),k&&(l.solve=n()-c),i.removeAllEquations();var U=Math.pow;for(v=0;v!==g;v++){var w=h[v];if(w.motionstate&m){var db=U(1-w.linearDamping,b),eb=w.velocity;eb.mult(db,eb);var fb=w.angularVelocity;if(fb){var gb=U(1-w.angularDamping,b);fb.mult(gb,fb)}}}for(this.dispatchEvent(W),v=0;v!==g;v++){var w=h[v];w.preStep&&w.preStep.call(w)}k&&(c=n());var hb=bb,ib=cb,jb=this.stepnumber,kb=a.Body.DYNAMIC|a.Body.KINEMATIC,lb=0===jb%(this.quatNormalizeSkip+1),mb=this.quatNormalizeFast,nb=.5*b,ob=a.Shape.types.PLANE,pb=a.Shape.types.CONVEXPOLYHEDRON;for(v=0;v!==g;v++){var qb=h[v],rb=qb.shape,sb=qb.force,tb=qb.tau;if(qb.motionstate&kb){var ub=qb.velocity,vb=qb.angularVelocity,wb=qb.position,xb=qb.quaternion,yb=qb.invMass,zb=qb.invInertia;if(ub.x+=sb.x*yb*b,ub.y+=sb.y*yb*b,ub.z+=sb.z*yb*b,qb.angularVelocity&&(vb.x+=tb.x*zb.x*b,vb.y+=tb.y*zb.y*b,vb.z+=tb.z*zb.z*b),qb.isSleeping()||(wb.x+=ub.x*b,wb.y+=ub.y*b,wb.z+=ub.z*b,qb.angularVelocity&&(hb.set(vb.x,vb.y,vb.z,0),hb.mult(xb,ib),xb.x+=nb*ib.x,xb.y+=nb*ib.y,xb.z+=nb*ib.z,xb.w+=nb*ib.w,lb&&(mb?xb.normalizeFast():xb.normalize())),qb.aabbmin&&(qb.aabbNeedsUpdate=!0)),rb)switch(rb.type){case ob:rb.worldNormalNeedsUpdate=!0;break;case pb:rb.worldFaceNormalsNeedsUpdate=!0,rb.worldVerticesNeedsUpdate=!0}}qb.force.set(0,0,0),qb.tau&&qb.tau.set(0,0,0)}for(k&&(l.integrate=n()-c),this.time+=b,this.stepnumber+=1,this.dispatchEvent(V),v=0;v!==g;v++){var w=h[v],Ab=w.postStep;Ab&&Ab.call(w)}for(v=0;v!==g;v++){var qb=h[v];qb.inertiaWorldAutoUpdate&&qb.quaternion.vmult(qb.inertia,qb.inertiaWorld),qb.invInertiaWorldAutoUpdate&&qb.quaternion.vmult(qb.invInertia,qb.invInertiaWorld)}if(this.allowSleep)for(v=0;v!==g;v++)h[v].sleepTick(this.time)},a.ContactGenerator=function(){function b(b,c){if(q.length){var d=q.pop();return d.bi=b,d.bj=c,d}return new a.ContactEquation(b,c)}function c(a){var b;b=a.ri,a.ri=a.rj,a.rj=b,a.ni.negate(a.ni),b=a.bi,a.bi=a.bj,a.bj=b}function d(a,c,d,e,f,g,h,i,j){var k=b(i,j);j.position.vsub(e,k.ni),k.ni.normalize(),k.ni.copy(k.ri),k.ni.copy(k.rj),k.ri.mult(c.radius,k.ri),k.rj.mult(-d.radius,k.rj),a.push(k)}function e(a,c,d,e,f,g,h,i,j){var k=b(i,j);k.ni.set(0,0,1),h.vmult(k.ni,k.ni),k.ni.negate(k.ni),k.ni.normalize(),k.ni.mult(c.radius,k.ri),e.vsub(f,s),k.ni.mult(k.ni.dot(s),t),s.vsub(t,k.rj),t.norm2()<=c.radius*c.radius&&a.push(k)}function f(a,b,c){for(var d=null,e=a.length,f=0;f!==e;f++){var g=a[f],h=u;a[(f+1)%e].vsub(g,h);var i=v;h.cross(b,i);var j=w;c.vsub(g,j);var k=i.dot(j);if(!(null===d||k>0&&d===!0||0>=k&&d===!1))return!1;null===d&&(d=k>0)}return!0}function g(a,c,d,e,f,g,h,i,j){var k=B;e.vsub(f,x),d.getSideNormals(k,h);for(var l=c.radius,m=!1,n=D,o=E,p=F,q=null,s=0,t=0,u=0,v=null,w=0,G=k.length;w!==G&&m===!1;w++){var H=y;k[w].copy(H);var I=H.norm();H.normalize();var J=x.dot(H);if(I+l>J&&J>0){var K=z,L=A;k[(w+1)%3].copy(K),k[(w+2)%3].copy(L);var M=K.norm(),N=L.norm();K.normalize(),L.normalize();var O=x.dot(K),P=x.dot(L);if(M>O&&O>-M&&N>P&&P>-N){var Q=Math.abs(J-I-l);(null===v||v>Q)&&(v=Q,t=O,u=P,q=I,H.copy(n),K.copy(o),L.copy(p),s++)}}}if(s){m=!0;var R=b(i,j);n.mult(-l,R.ri),n.copy(R.ni),R.ni.negate(R.ni),n.mult(q,n),o.mult(t,o),n.vadd(o,n),p.mult(u,p),n.vadd(p,R.rj),a.push(R)}for(var S=r.get(),T=C,U=0;2!==U&&!m;U++)for(var V=0;2!==V&&!m;V++)for(var W=0;2!==W&&!m;W++)if(S.set(0,0,0),U?S.vadd(k[0],S):S.vsub(k[0],S),V?S.vadd(k[1],S):S.vsub(k[1],S),W?S.vadd(k[2],S):S.vsub(k[2],S),f.vadd(S,T),T.vsub(e,T),T.norm2()<l*l){m=!0;var R=b(i,j);T.copy(R.ri),R.ri.normalize(),R.ri.copy(R.ni),R.ri.mult(l,R.ri),S.copy(R.rj),a.push(R)}r.release(S),S=null;for(var X=r.get(),Y=r.get(),R=r.get(),Z=r.get(),Q=r.get(),$=k.length,U=0;U!==$&&!m;U++)for(var V=0;V!==$&&!m;V++)if(U%3!==V%3){k[V].cross(k[U],X),X.normalize(),k[U].vadd(k[V],Y),e.copy(R),R.vsub(Y,R),R.vsub(f,R);var _=R.dot(X);X.mult(_,Z);for(var W=0;W===U%3||W===V%3;)W++;e.copy(Q),Q.vsub(Z,Q),Q.vsub(Y,Q),Q.vsub(f,Q);var ab=Math.abs(_),bb=Q.norm();if(ab<k[W].norm()&&l>bb){m=!0;var cb=b(i,j);Y.vadd(Z,cb.rj),cb.rj.copy(cb.rj),Q.negate(cb.ni),cb.ni.normalize(),cb.rj.copy(cb.ri),cb.ri.vadd(f,cb.ri),cb.ri.vsub(e,cb.ri),cb.ri.normalize(),cb.ri.mult(l,cb.ri),a.push(cb)}}r.release(X,Y,R,Z,Q)}function h(a,c,d,e,g,h,i,j,k){e.vsub(g,G);for(var l=d.faceNormals,m=d.faces,n=d.vertices,o=c.radius,p=0;p!==n.length;p++){var q=n[p],s=K;i.vmult(q,s),g.vadd(s,s);var t=J;if(s.vsub(e,t),t.norm2()<o*o){v=!0;var u=b(j,k);return t.copy(u.ri),u.ri.normalize(),u.ri.copy(u.ni),u.ri.mult(o,u.ri),s.vsub(g,u.rj),a.push(u),void 0}}for(var v=!1,p=0,w=m.length;p!==w&&v===!1;p++){var x=l[p],y=m[p],z=L;i.vmult(x,z);var A=M;i.vmult(n[y[0]],A),A.vadd(g,A);var B=N;z.mult(-o,B),e.vadd(B,B);var C=O;B.vsub(A,C);var D=C.dot(z),E=P;if(e.vsub(A,E),0>D&&E.dot(z)>0){for(var F=[],Q=0,R=y.length;Q!==R;Q++){var S=r.get();i.vmult(n[y[Q]],S),g.vadd(S,S),F.push(S)}if(f(F,z,e)){v=!0;var u=b(j,k);z.mult(-o,u.ri),z.negate(u.ni);var T=r.get();z.mult(-D,T);var U=r.get();z.mult(-o,U),e.vsub(g,u.rj),u.rj.vadd(U,u.rj),u.rj.vadd(T,u.rj),r.release(T),r.release(U),a.push(u);for(var Q=0,V=F.length;Q!==V;Q++)r.release(F[Q]);return}for(var Q=0;Q!==y.length;Q++){var W=r.get(),X=r.get();i.vmult(n[y[(Q+1)%y.length]],W),i.vmult(n[y[(Q+2)%y.length]],X),g.vadd(W,W),g.vadd(X,X);var Y=H;X.vsub(W,Y);var Z=I;Y.unit(Z);var $=r.get(),_=r.get();e.vsub(W,_);var ab=_.dot(Z);Z.mult(ab,$),$.vadd(W,$);var bb=r.get();if($.vsub(e,bb),ab>0&&ab*ab<Y.norm2()&&bb.norm2()<o*o){var u=b(j,k);$.vsub(g,u.rj),$.vsub(e,u.ni),u.ni.normalize(),u.ni.mult(o,u.ri),a.push(u);for(var Q=0,V=F.length;Q!==V;Q++)r.release(F[Q]);return r.release(W),r.release(X),r.release($),r.release(bb),r.release(_),void 0}r.release(W),r.release(X),r.release($),r.release(bb),r.release(_)}for(var Q=0,V=F.length;Q!==V;Q++)r.release(F[Q])}}}function i(a,b,c,d,e,f,g,h,i){k(a,b,c.convexPolyhedronRepresentation,d,e,f,g,h,i)}function j(b,c,d,e,f,g,h,i,j){for(var k=Q,l=R,m=0,n=0,o=d.childShapes.length;n!==o;n++){var q=[],r=l.pop()||new a.Quaternion,s=k.pop()||new a.Vec3;h.mult(d.childOrientations[n],r),r.normalize(),h.vmult(d.childOffsets[n],s),f.vadd(s,s),p(q,c,d.childShapes[n],e,s,g,r,i,j),l.push(r);var t=s;c||(m+=q.length);for(var u=0;u!==q.length;u++)h.vmult(d.childOffsets[n],t),q[u].rj.vadd(t,q[u].rj),b.push(q[u]);k.push(s)}}function k(a,c,d,e,f,g,h,i,j){var k=S,l=T;l.set(0,0,1),g.vmult(l,l);for(var m=U,n=0;n!==d.vertices.length;n++){d.vertices[n].copy(k),h.vmult(k,k),f.vadd(k,k),k.vsub(e,m);var o=l.dot(m);if(0>=o){var p=V;l.mult(l.dot(k),p),k.vsub(p,p);var q=b(i,j);l.copy(q.ni),p.copy(q.ri),k.vsub(f,q.rj),a.push(q)}}}function l(a,c,d,e,f,g,h,i,j){var k=W;if(c.findSeparatingAxis(d,e,g,f,h,k)){var l=[],m=X;c.clipAgainstHull(e,g,d,f,h,k,-100,100,l);for(var n=0;n!==l.length;n++){var o=b(i,j);k.negate(o.ni),l[n].normal.negate(m),m.mult(l[n].depth,m),l[n].point.vadd(m,o.ri),l[n].point.copy(o.rj),o.rj.vsub(f,o.rj),o.ri.vsub(e,o.ri),a.push(o)}}}function m(a,c,d,e,f,g,h,i,j){var k=Y;k.set(0,0,1),j.quaternion.vmult(k,k);var l=Z;e.vsub(j.position,l);var m=k.dot(l);if(0>=m){var n=b(i,j);k.copy(n.ni),n.ni.negate(n.ni),n.ri.set(0,0,0);var o=$;k.mult(k.dot(e),o),e.vsub(o,o),o.copy(n.rj),a.push(n)}}function n(a,c,d,e,f,g,h,i,j){var k=_;k.set(0,0,1),e.vsub(f,k);var l=k.norm2();if(l<=d.radius*d.radius){var m=b(i,j);k.normalize(),k.copy(m.rj),m.rj.mult(d.radius,m.rj),k.copy(m.ni),m.ni.negate(m.ni),m.ri.set(0,0,0),a.push(m)}}function o(a,c,d,e,f,g,h,i,j){var k=-1,l=cb,m=eb,n=null,o=0,p=bb;if(e.copy(p),p.vsub(f,p),h.conjugate(ab),ab.vmult(p,p),d.pointIsInside(p)){d.worldVerticesNeedsUpdate&&d.computeWorldVertices(f,h),d.worldFaceNormalsNeedsUpdate&&d.computeWorldFaceNormals(h);for(var q=0,r=d.faces.length;q!==r;q++){var s=[d.worldVertices[d.faces[q][0]]],t=d.worldFaceNormals[q];e.vsub(s[0],db);var u=-t.dot(db);(null===n||Math.abs(u)<Math.abs(n))&&(n=u,k=q,t.copy(l),o++)}if(-1!==k){var v=b(i,j);l.mult(n,m),m.vadd(e,m),m.vsub(f,m),m.copy(v.rj),l.negate(v.ni),v.ri.set(0,0,0),a.push(v)}else console.warn("Point found inside convex, but did not find penetrating face!")}}function p(b,f,q,r,s,t,u,v,w){var x=!1,y=a.Shape.types,z=y.SPHERE,A=y.PLANE,B=y.BOX,C=y.COMPOUND,D=y.CONVEXPOLYHEDRON;if(f&&q){if(f.type>q.type){var E;E=q,q=f,f=E,E=s,s=r,r=E,E=u,u=t,t=E,E=w,w=v,v=E,x=!0}}else if(f&&!q){var E;E=q,q=f,f=E,E=s,s=r,r=E,E=u,u=t,t=E,E=w,w=v,v=E,x=!0}if(f&&q){if(f.type===z)switch(q.type){case z:d(b,f,q,r,s,t,u,v,w);break;case A:e(b,f,q,r,s,t,u,v,w);break;case B:g(b,f,q,r,s,t,u,v,w);break;case C:j(b,f,q,r,s,t,u,v,w);break;case D:h(b,f,q,r,s,t,u,v,w);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+q.type+" not implemented yet.")}else if(f.type===y.PLANE)switch(q.type){case y.PLANE:throw new Error("Plane-plane collision... wait, you did WHAT?");case y.BOX:i(b,f,q,r,s,t,u,v,w);break;case y.COMPOUND:j(b,f,q,r,s,t,u,v,w);break;case y.CONVEXPOLYHEDRON:k(b,f,q,r,s,t,u,v,w);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+q.type+" not implemented yet.")}else if(f.type===y.BOX)switch(q.type){case y.BOX:p(b,f.convexPolyhedronRepresentation,q.convexPolyhedronRepresentation,r,s,t,u,v,w);break;case y.COMPOUND:j(b,f,q,r,s,t,u,v,w);break;case y.CONVEXPOLYHEDRON:p(b,f.convexPolyhedronRepresentation,q,r,s,t,u,v,w);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+q.type+" not implemented yet.")}else if(f.type===y.COMPOUND)switch(q.type){case y.COMPOUND:j(b,f,q,r,s,t,u,v,w);break;case y.CONVEXPOLYHEDRON:var F=[];j(F,q,f,s,r,u,t,w,v);for(var G=0;G!==F.length;G++)c(F[G]),b.push(F[G]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+q.type+" not implemented yet.")}else if(f.type===y.CONVEXPOLYHEDRON)switch(q.type){case y.CONVEXPOLYHEDRON:l(b,f,q,r,s,t,u,v,w);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+q.type+" not implemented yet.")}}else switch(q.type){case y.PLANE:m(b,f,q,r,s,t,u,v,w);break;case y.SPHERE:n(b,f,q,r,s,t,u,v,w);break;case y.BOX:o(b,f,q.convexPolyhedronRepresentation,r,s,t,u,v,w);break;case y.CONVEXPOLYHEDRON:o(b,f,q,r,s,t,u,v,w);break;case y.COMPOUND:j(b,f,q,r,s,t,u,v,w);break;default:console.warn("Collision between CANNON.Particle and "+q.type+" not implemented yet.")}for(var H=0,I=b.length;x&&H!==I;H++)c(b[H])}this.contactReduction=!1;var q=[],r=new a.Vec3Pool,s=new a.Vec3,t=new a.Vec3,u=new a.Vec3,v=new a.Vec3,w=new a.Vec3,x=new a.Vec3,y=new a.Vec3,z=new a.Vec3,A=new a.Vec3,B=[new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3],C=new a.Vec3,D=new a.Vec3,E=new a.Vec3,F=new a.Vec3,G=new a.Vec3,H=new a.Vec3,I=new a.Vec3,J=new a.Vec3,K=new a.Vec3,L=new a.Vec3,M=new a.Vec3,N=new a.Vec3,O=new a.Vec3,P=new a.Vec3;new a.Vec3,new a.Vec3;var Q=[],R=[],S=new a.Vec3,T=new a.Vec3,U=new a.Vec3,V=new a.Vec3,W=new a.Vec3,X=new a.Vec3,Y=new a.Vec3,Z=new a.Vec3,$=new a.Vec3,_=new a.Vec3,ab=new a.Quaternion,bb=new a.Vec3;new a.Vec3;var cb=new a.Vec3,db=new a.Vec3,eb=new a.Vec3;this.reduceContacts=function(){},this.getContacts=function(a,b,c,d,e){q=e;for(var f=0,g=a.length;f!==g;f++){var h=a[f],i=b[f];p(d,h.shape,i.shape,h.position,i.position,h.quaternion,i.quaternion,h,i)}}},a.Equation=function(a,b,c,d){this.id=-1,this.minForce="undefined"==typeof c?-1e6:c,this.maxForce="undefined"==typeof d?1e6:d,this.bi=a,this.bj=b,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0},a.Equation.prototype.constructor=a.Equation,a.Equation.prototype.updateSpookParams=function(a){var b=this.regularizationTime,c=this.stiffness;this.a=4/(a*(1+4*b)),this.b=4*b/(1+4*b),this.eps=4/(a*a*c*(1+4*b))},a.ContactEquation=function(b,c){a.Equation.call(this,b,c,0,1e6),this.restitution=0,this.ri=new a.Vec3,this.rj=new a.Vec3,this.penetrationVec=new a.Vec3,this.ni=new a.Vec3,this.rixn=new a.Vec3,this.rjxn=new a.Vec3,this.invIi=new a.Mat3,this.invIj=new a.Mat3,this.biInvInertiaTimesRixn=new a.Vec3,this.bjInvInertiaTimesRjxn=new a.Vec3},a.ContactEquation.prototype=new a.Equation,a.ContactEquation.prototype.constructor=a.ContactEquation,a.ContactEquation.prototype.reset=function(){this.invInertiaTimesRxnNeedsUpdate=!0};var db=new a.Vec3,eb=new a.Vec3,fb=new a.Vec3;a.ContactEquation.prototype.computeB=function(a){var b=this.a,c=this.b,d=this.bi,e=this.bj,f=this.ri,g=this.rj,h=this.rixn,i=this.rjxn,j=fb,k=d.velocity,l=d.angularVelocity?d.angularVelocity:j,m=d.force,n=d.tau?d.tau:j,o=e.velocity,p=e.angularVelocity?e.angularVelocity:j,q=e.force,r=e.tau?e.tau:j,s=this.penetrationVec,t=d.invMass,u=e.invMass,v=this.invIi,w=this.invIj;d.invInertia?v.setTrace(d.invInertia):v.identity(),e.invInertia?w.setTrace(e.invInertia):w.identity();var x=this.ni;f.cross(x,h),g.cross(x,i);var s=this.penetrationVec;s.set(0,0,0),s.vadd(e.position,s),s.vadd(g,s),s.vsub(d.position,s),s.vsub(f,s);var y=x.dot(s),z=db,A=eb;v.vmult(n,z),w.vmult(r,A);var B=this.restitution+1,C=B*o.dot(x)-B*k.dot(x)+p.dot(i)-l.dot(h),D=q.dot(x)*u-m.dot(x)*t+i.dot(A)-h.dot(z),E=-y*b-C*c-a*D;return E},new a.Vec3,new a.Vec3,a.ContactEquation.prototype.computeC=function(){var a=this.bi,b=this.bj,c=this.rixn,d=this.rjxn,e=a.invMass,f=b.invMass,g=e+f+this.eps,h=this.invIi,i=this.invIj;return h.vmult(c,this.biInvInertiaTimesRixn),i.vmult(d,this.bjInvInertiaTimesRjxn),g+=this.biInvInertiaTimesRixn.dot(c),g+=this.bjInvInertiaTimesRjxn.dot(d)};var gb=new a.Vec3;a.ContactEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=gb,d=0;return b.vlambda.vsub(a.vlambda,c),d+=c.dot(this.ni),a.wlambda&&(d-=a.wlambda.dot(this.rixn)),b.wlambda&&(d+=b.wlambda.dot(this.rjxn)),d};var hb=new a.Vec3,ib=new a.Vec3;a.ContactEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=(this.rixn,this.rjxn,b.invMass),e=c.invMass,f=this.ni,g=hb,h=ib;f.mult(d*a,h),b.vlambda.vsub(h,b.vlambda),f.mult(e*a,h),c.vlambda.vadd(h,c.vlambda),void 0!==b.wlambda&&(this.biInvInertiaTimesRixn.mult(a,g),b.wlambda.vsub(g,b.wlambda)),void 0!==c.wlambda&&(this.bjInvInertiaTimesRjxn.mult(a,g),c.wlambda.vadd(g,c.wlambda))},a.FrictionEquation=function(b,c,d){a.Equation.call(this,b,c,-d,d),this.ri=new a.Vec3,this.rj=new a.Vec3,this.t=new a.Vec3,this.rixt=new a.Vec3,this.rjxt=new a.Vec3,this.wixri=new a.Vec3,this.wjxrj=new a.Vec3,this.invIi=new a.Mat3,this.invIj=new a.Mat3,this.relVel=new a.Vec3,this.relForce=new a.Vec3,this.biInvInertiaTimesRixt=new a.Vec3,this.bjInvInertiaTimesRjxt=new a.Vec3},a.FrictionEquation.prototype=new a.Equation,a.FrictionEquation.prototype.constructor=a.FrictionEquation;var jb=new a.Vec3,kb=new a.Vec3,lb=new a.Vec3;a.FrictionEquation.prototype.computeB=function(a){var b=this.a,c=this.b,d=this.bi,e=this.bj,f=this.ri,g=this.rj,h=this.rixt,i=this.rjxt,j=this.wixri,k=this.wjxrj,l=lb,m=d.velocity,n=d.angularVelocity?d.angularVelocity:l,o=d.force,p=d.tau?d.tau:l,q=e.velocity,r=e.angularVelocity?e.angularVelocity:l,s=e.force,t=e.tau?e.tau:l,u=(this.relVel,this.relForce,d.invMass),v=e.invMass,w=this.invIi,x=this.invIj,y=this.t,z=jb,A=kb;d.invInertia&&w.setTrace(d.invInertia),e.invInertia&&x.setTrace(e.invInertia),f.cross(y,h),g.cross(y,i),n.cross(f,j),r.cross(g,k),w.vmult(p,z),x.vmult(t,A);var B=0,C=q.dot(y)-m.dot(y)+k.dot(y)-j.dot(y),D=s.dot(y)*v-o.dot(y)*u+i.dot(A)-h.dot(z),E=-B*b-C*c-a*D;return E},a.FrictionEquation.prototype.computeC=function(){var a=this.bi,b=this.bj,c=this.rixt,d=this.rjxt,e=a.invMass,f=b.invMass,g=e+f+this.eps,h=this.invIi,i=this.invIj;return h.vmult(c,this.biInvInertiaTimesRixt),i.vmult(d,this.bjInvInertiaTimesRjxt),g+=this.biInvInertiaTimesRixt.dot(c),g+=this.bjInvInertiaTimesRjxt.dot(d)};var mb=new a.Vec3;a.FrictionEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=0,d=mb;return b.vlambda.vsub(a.vlambda,d),c+=d.dot(this.t),a.wlambda&&(c-=a.wlambda.dot(this.rixt)),b.wlambda&&(c+=b.wlambda.dot(this.rjxt)),c};var nb=new a.Vec3;a.FrictionEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=(this.rixt,this.rjxt,b.invMass),e=c.invMass,f=this.t,g=nb,h=b.wlambda,i=c.wlambda;f.mult(d*a,g),b.vlambda.vsub(g,b.vlambda),f.mult(e*a,g),c.vlambda.vadd(g,c.vlambda),h&&(this.biInvInertiaTimesRixt.mult(a,g),h.vsub(g,h)),i&&(this.bjInvInertiaTimesRjxt.mult(a,g),i.vadd(g,i))},a.RotationalEquation=function(b,c){a.Equation.call(this,b,c,-1e6,1e6),this.ni=new a.Vec3,this.nj=new a.Vec3,this.nixnj=new a.Vec3,this.njxni=new a.Vec3,this.invIi=new a.Mat3,this.invIj=new a.Mat3,this.relVel=new a.Vec3,this.relForce=new a.Vec3},a.RotationalEquation.prototype=new a.Equation,a.RotationalEquation.prototype.constructor=a.RotationalEquation,a.RotationalEquation.prototype.computeB=function(b){var c=this.a,d=this.b,e=this.bi,f=this.bj,g=this.ni,h=this.nj,i=this.nixnj,j=this.njxni;e.velocity;var k=e.angularVelocity?e.angularVelocity:new a.Vec3;e.force,e.tau?e.tau:new a.Vec3,f.velocity;var l=f.angularVelocity?f.angularVelocity:new a.Vec3;f.force,f.tau?f.tau:new a.Vec3,e.invMass,f.invMass;var m=this.invIi,n=this.invIj;e.invInertia?m.setTrace(e.invInertia):m.identity(),f.invInertia?n.setTrace(f.invInertia):n.identity(),g.cross(h,i),h.cross(g,j);var o=-g.dot(h),p=j.dot(k)+i.dot(l),q=0,r=-o*c-p*d-b*q;return r},a.RotationalEquation.prototype.computeC=function(){var a=this.bi,b=this.bj,c=this.nixnj,d=this.njxni;a.invMass,b.invMass;var e=this.eps,f=this.invIi,g=this.invIj;return a.invInertia?f.setTrace(a.invInertia):f.identity(),b.invInertia?g.setTrace(b.invInertia):g.identity(),e+=f.vmult(d).dot(d),e+=g.vmult(c).dot(c)};var gb=new a.Vec3;a.RotationalEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=0;return a.wlambda&&(c+=a.wlambda.dot(this.njxni)),b.wlambda&&(c+=b.wlambda.dot(this.nixnj)),c},a.RotationalEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=this.nixnj;
if(this.njxni,b.invMass,c.invMass,b.wlambda){var e=this.invIi;b.wlambda.vsub(e.vmult(d).mult(a),b.wlambda)}if(c.wlambda){var e=this.invIj;c.wlambda.vadd(e.vmult(d).mult(a),c.wlambda)}},a.Constraint=function(a,b){this.equations=[],this.bodyA=a,this.bodyB=b},a.Constraint.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},a.DistanceConstraint=function(b,c,d,e){a.Constraint.call(this,b,c),"undefined"==typeof e&&(e=1e6);var f=this.equations=[new a.ContactEquation(b,c)],g=f[0];g.minForce=-e,g.maxForce=e,this.update=function(){c.position.vsub(b.position,g.ni),g.ni.normalize(),g.ni.mult(.5*d,g.ri),g.ni.mult(.5*-d,g.rj)}},a.DistanceConstraint.prototype=new a.Constraint,a.RotationalMotorEquation=function(b,c,d){d=d||1e6,a.Equation.call(this,b,c,-d,d),this.axisA=new a.Vec3,this.axisB=new a.Vec3,this.invIi=new a.Mat3,this.invIj=new a.Mat3,this.targetVelocity=0},a.RotationalMotorEquation.prototype=new a.Equation,a.RotationalMotorEquation.prototype.constructor=a.RotationalMotorEquation,a.RotationalMotorEquation.prototype.computeB=function(b){var c=this.a,d=this.b,e=this.bi,f=this.bj,g=this.axisA,h=this.axisB;e.velocity;var i=e.angularVelocity?e.angularVelocity:new a.Vec3;e.force,e.tau?e.tau:new a.Vec3,f.velocity;var j=f.angularVelocity?f.angularVelocity:new a.Vec3;f.force,f.tau?f.tau:new a.Vec3,e.invMass,f.invMass;var k=this.invIi,l=this.invIj;e.invInertia?k.setTrace(e.invInertia):k.identity(),f.invInertia?l.setTrace(f.invInertia):l.identity();var m=0,n=g.dot(i)+h.dot(j)+this.targetVelocity,o=0,p=-m*c-n*d-b*o;return p},a.RotationalMotorEquation.prototype.computeC=function(){var a=this.bi,b=this.bj,c=this.axisA,d=this.axisB;a.invMass,b.invMass;var e=this.eps,f=this.invIi,g=this.invIj;return a.invInertia?f.setTrace(a.invInertia):f.identity(),b.invInertia?g.setTrace(b.invInertia):g.identity(),e+=f.vmult(c).dot(d),e+=g.vmult(d).dot(d)};var gb=new a.Vec3;a.RotationalMotorEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=this.axisA,d=this.axisB,e=0;return a.wlambda&&(e+=a.wlambda.dot(c)),b.wlambda&&(e+=b.wlambda.dot(d)),e},a.RotationalMotorEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=this.axisA,e=this.axisB;if(b.invMass,c.invMass,b.wlambda){var f=this.invIi;b.wlambda.vsub(f.vmult(d).mult(a),b.wlambda)}if(c.wlambda){var f=this.invIj;c.wlambda.vadd(f.vmult(e).mult(a),c.wlambda)}},a.HingeConstraint=function(b,c,d,e,f,g,h){a.Constraint.call(this,b,e),h=h||1e6;var i=this,j=this.equations=[new a.RotationalEquation(b,e),new a.RotationalEquation(b,e),new a.ContactEquation(b,e),new a.ContactEquation(b,e),new a.ContactEquation(b,e)];this.getRotationalEquation1=function(){return j[0]},this.getRotationalEquation2=function(){return j[1]},this.getPointToPointEquation1=function(){return j[2]},this.getPointToPointEquation2=function(){return j[3]},this.getPointToPointEquation3=function(){return j[4]};var k,l=this.getRotationalEquation1(),m=this.getRotationalEquation2(),n=this.getPointToPointEquation1(),o=this.getPointToPointEquation2(),p=this.getPointToPointEquation3();o.minForce=p.minForce=n.minForce=-h,o.maxForce=p.maxForce=n.maxForce=h;var q=c.unit(),r=f.unit(),s=new a.Vec3,t=new a.Vec3,u=new a.Vec3;d.cross(q,s),s.norm2()<.001&&q.tangents(s,s),d.cross(s,t),g.cross(r,u),u.norm2()<.001&&g.tangents(u,u),s.normalize(),u.normalize();var v=!1;this.motorTargetVelocity=0,this.motorMinForce=-h,this.motorMaxForce=h,this.enableMotor=function(){v||(k=new a.RotationalMotorEquation(b,e,h),j.push(k),v=!0)},this.disableMotor=function(){v&&(v=!1,k=null,j.pop())},this.update=function(){n.ni.set(1,0,0),o.ni.set(0,1,0),p.ni.set(0,0,1),b.quaternion.vmult(c,n.ri),e.quaternion.vmult(f,n.rj),n.ri.copy(o.ri),n.rj.copy(o.rj),n.ri.copy(p.ri),n.rj.copy(p.rj),b.quaternion.vmult(s,l.ni),e.quaternion.vmult(g,l.nj),b.quaternion.vmult(t,m.ni),e.quaternion.vmult(g,m.nj),v&&(b.quaternion.vmult(d,k.axisA),e.quaternion.vmult(g,k.axisB),k.targetVelocity=i.motorTargetVelocity,k.maxForce=i.motorMaxForce,k.minForce=i.motorMinForce)}},a.HingeConstraint.prototype=new a.Constraint,a.PointToPointConstraint=function(b,c,d,e,f){a.Constraint.call(this,b,d);var g=this.equations=[new a.ContactEquation(b,d),new a.ContactEquation(b,d),new a.ContactEquation(b,d)],h=g[0],i=g[1],j=g[2];i.minForce=j.minForce=h.minForce=-f,i.maxForce=j.maxForce=h.maxForce=f,this.update=function(){d.position.vsub(b.position,h.ni),h.ni.normalize(),b.quaternion.vmult(c,h.ri),d.quaternion.vmult(e,h.rj),h.ni.tangents(i.ni,j.ni),h.ri.copy(i.ri),h.rj.copy(i.rj),h.ri.copy(j.ri),h.rj.copy(j.rj)}},a.PointToPointConstraint.prototype=new a.Constraint,"undefined"!=typeof module?module.exports=a:this.CANNON=a}.apply(this);