<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>THREE.CannonDebugRenderer example</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin:0;
            padding:0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <script src="../../libs/Three.js"></script>
    <script src="../../libs/Detector.js"></script>
    <script src="../../build/cannon.js"></script>
    <script src="CannonDebugRenderer.js"></script>

    <script>

        var world;
        var fixedTimeStep = 1 / 60;
        var maxSubSteps = 3;
        var mass = 5;
        var lastTime;

        var camera, scene, renderer;
        var geometry, material, mesh;
        var container, camera, scene, renderer, cannonDebugRenderer;

        // To be synced
        var meshes = [];
        var bodies = [];

        if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

        initCannon();
        initThree();
        addSphere();
        addBox();
        addPlane();
        animate();

        function initThree() {

            container = document.createElement( 'div' );
            document.body.appendChild( container );

            // scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog( 0x000000, 500, 10000 );

            // camera
            camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 0.5, 10000 );
            camera.position.set(0, 3, 20);
            scene.add(camera);

            material = new THREE.MeshLambertMaterial( { color: 0x777777 } );

            // lights
            scene.add( new THREE.AmbientLight( 0x111111 ) );
            var light = new THREE.DirectionalLight( 0xffffff, 1.75 );
            var d = 20;
            light.position.set( 40, 20, 20 );
            scene.add( light );

            renderer = new THREE.WebGLRenderer( { antialias: true } );
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.setClearColor( scene.fog.color );

            container.appendChild( renderer.domElement );

            window.addEventListener( 'resize', onWindowResize, false );

            cannonDebugRenderer = new THREE.CannonDebugRenderer(scene, world);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );
        }

        function animate(time) {
            requestAnimationFrame( animate );

            if(time && lastTime){
                var dt = time - lastTime;
                world.step(fixedTimeStep, dt / 1000, maxSubSteps);
            }

            updateMeshPositions();
            cannonDebugRenderer.update();
            renderer.render(scene, camera);
            lastTime = time;
        }

        function updateMeshPositions(){
            for(var i=0; i !== meshes.length; i++){
                meshes[i].position.copy(bodies[i].position);
                meshes[i].quaternion.copy(bodies[i].quaternion);
            }
        }

        function initCannon(){
            world = new CANNON.World();
            world.gravity.set(0,-10,0);
            world.broadphase = new CANNON.NaiveBroadphase();
        }

        function addPlane(){
            // Physics
            var groundShape = new CANNON.Plane();
            var groundBody = new CANNON.Body({ mass: 0 });
            groundBody.addShape(groundShape);
            groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),-Math.PI/2);
            world.add(groundBody);
            bodies.push(groundBody);

            // Graphics
            geometry = new THREE.PlaneGeometry( 100, 100, 1, 1 );
            mesh = new THREE.Mesh( geometry, material );
            mesh.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0), -Math.PI / 2);
            scene.add(mesh);
            meshes.push(mesh);
        }

        function addBox(){
            // Physics
            var boxShape = new CANNON.Box(new CANNON.Vec3(0.5,0.5,0.5));
            var boxBody = new CANNON.Body({ mass: mass });
            boxBody.addShape(boxShape);
            boxBody.position.set(2,5,0);
            world.add(boxBody);
            bodies.push(boxBody);

            // Graphics
            var cubeGeo = new THREE.BoxGeometry( 1, 1, 1, 10, 10 );
            cubeMesh = new THREE.Mesh(cubeGeo, material);
            meshes.push(cubeMesh);
            scene.add(cubeMesh);
        }

        function addSphere(){
            // Physics
            var sphereBody = new CANNON.Body({ mass: mass });
            sphereShape = new CANNON.Sphere(1);
            sphereBody.addShape(sphereShape);
            sphereBody.position.set(-1,5,0);
            world.add(sphereBody);
            bodies.push(sphereBody);

            // Graphics
            var sphereGeo = new THREE.SphereGeometry(1);
            sphereMesh = new THREE.Mesh(sphereGeo, material);
            meshes.push(sphereMesh);
            scene.add(sphereMesh);

        }

    </script>
</body>
</html>
